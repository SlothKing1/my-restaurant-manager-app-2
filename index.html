<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Manager</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <!-- Chart.js for reports -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px; /* Increased max-width for better layout on larger screens */
        }
        /* Hide number input spinners for a cleaner look */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Simple transition for tab content visibility */
        .tab-content {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
        /* Autocomplete styles */
        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 10;
            width: 100%;
        }
        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }
        /* Sorting arrows */
        .sortable {
            cursor: pointer;
        }
        .sort-arrow {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.5;
        }
        .sortable.sorted .sort-arrow {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- Login/Password Form -->
    <div id="login-container" class="container bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center mb-4">Restaurant Manager</h1>
        <p class="text-center text-gray-500 mb-6">Enter the password to access the app.</p>
        <form id="login-form">
            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            <button type="submit" class="w-full mt-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                Log In
            </button>
        </form>
        <div id="login-message" class="mt-4 text-center text-sm font-medium text-red-500 hidden">Incorrect password. Please try again.</div>
    </div>

    <!-- Main Application Content -->
    <div id="app-content" class="container bg-white rounded-xl shadow-2xl p-4 sm:p-6 md:p-8 w-full hidden">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Restaurant Manager</h1>
            <p class="mt-2 text-lg text-gray-500">Your all-in-one tool for costing, sales, and purchases.</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="relative border-b border-gray-200 mb-6">
            <!-- Mobile Menu Button -->
            <div class="md:hidden flex justify-end">
                <button id="mobile-menu-button" class="p-2 rounded-md text-gray-600 hover:bg-gray-100">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
            <!-- Desktop Tabs -->
            <div id="desktop-tabs" class="hidden md:flex flex-wrap">
                <button id="master-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Master Ingredients
                </button>
                <button id="menu-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Menu Costing
                </button>
                <button id="sales-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Daily Sales
                </button>
                <button id="purchases-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Purchases
                </button>
                <button id="salary-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Salary
                </button>
                <button id="reports-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Reports
                </button>
                <button id="settings-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Settings
                </button>
            </div>
             <!-- Mobile Menu Dropdown -->
            <div id="mobile-menu" class="hidden md:hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="master">Master Ingredients</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="menu">Menu Costing</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="sales">Daily Sales</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="purchases">Purchases</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="salary">Salary</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="reports">Reports</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="settings">Settings</a>
            </div>
        </div>

        <!-- Content Sections -->

        <!-- Master Ingredients Section -->
        <div id="master-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Master Ingredients</h2>
            
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Add a New Ingredient</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="ingredient-name" placeholder="Ingredient Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="ingredient-unit" placeholder="Unit (e.g., kg, L, each)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="ingredient-cost" placeholder="Cost per Unit" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-ingredient-btn" class="w-full p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Ingredient
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" id="master-search" placeholder="Search ingredients..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="name">Ingredient <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Unit</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="cost" data-base-text="Cost per Unit">Cost per Unit <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-table-body">
                            <!-- Ingredient rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="master-message" class="mt-4 p-3 text-center text-sm font-medium text-gray-600 rounded-lg"></div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-manage-ingredients">
                    <h3 class="text-xl font-semibold text-gray-600">Manage Ingredient Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-manage-ingredients" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="manage-ingredients-details" class="hidden mt-4">
                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-700 mb-2">Download All Ingredients</h4>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="download-ingredients-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                                Download as PDF
                            </button>
                            <button id="download-ingredients-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                                Download as Google Sheet (CSV)
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">Upload Ingredients (CSV)</h4>
                        <p class="text-sm text-gray-500 mb-2">CSV file should have headers: "Ingredient Name", "Unit", "Cost per Unit"</p>
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <input type="file" id="upload-ingredients-file" accept=".csv" class="flex-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="upload-ingredients-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                                Upload & Replace
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Items & Platters Section -->
        <div id="menu-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Menu Costing</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Add New Dish or Platter</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="menu-item-name" placeholder="Name" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="item-type-select" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="dish">Dish</option>
                        <option value="platter">Platter</option>
                        <option value="starter">Starter</option>
                        <option value="sides">Sides</option>
                        <option value="salads">Salads</option>
                        <option value="dessert">Dessert</option>
                        <option value="drinks">Drinks</option>
                        <option value="wraps">Wraps</option>
                    </select>
                    <input type="number" id="dine-in-price" placeholder="Dine-In Price" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="take-away-price" placeholder="Take-Away Price" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-menu-item-btn" class="md:col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Item
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" id="menu-search" placeholder="Search menu items..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div id="menu-items-container" class="space-y-6 overflow-y-auto max-h-96">
                <!-- Menu item cards will be dynamically inserted here -->
            </div>
        </div>
        
        <!-- Daily Sales Section -->
        <div id="sales-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Daily Sales & Bookings</h2>
            
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Record Today's Sales</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <input type="date" id="sales-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-cash" placeholder="Cash" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-card" placeholder="Card" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-uber" placeholder="Uber Eats" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-justeat" placeholder="Just Eat" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-deliveroo" placeholder="Deliveroo" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-website" placeholder="Website" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-advance" placeholder="Booking Advance" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-toogoodtogo" placeholder="Too Good To Go" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-sales-btn" class="md:col-span-3 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Sales
                    </button>
                </div>
                <div id="sales-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>
            
            <div class="mb-4">
                <input type="text" id="sales-search" placeholder="Search sales by date..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600"></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="date">Date <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="cash" data-base-text="Cash">Cash <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="card" data-base-text="Card">Card <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="online" data-base-text="Online">Online <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="total" data-base-text="Total">Total <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-body">
                            <!-- Sales history will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-download-sales">
                    <h3 class="text-xl font-semibold text-gray-600">Download Sales Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-download-sales" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="download-sales-details" class="hidden mt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Sales History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchases Section -->
        <div id="purchases-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Purchases & Expenses</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Record a Purchase</h3>
                <div class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-4 items-end">
                    <input type="date" id="purchase-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <div class="relative">
                        <input type="text" id="purchase-item" placeholder="Item/Service Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    </div>
                    <input type="number" id="purchase-cost" placeholder="Total Cost" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="purchase-payment-method" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="">Payment Method</option>
                        <option value="Credit">Credit</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Card Payment">Card Payment</option>
                        <option value="Direct Debit">Direct Debit</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="relative">
                        <input type="text" id="purchase-paid-by" placeholder="Paid By" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    </div>
                    <button id="add-purchase-btn" class="w-full p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Purchase
                    </button>
                </div>
                <div id="purchase-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="purchases-search" placeholder="Search purchases..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="date">Date <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="item">Item/Service <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="cost" data-base-text="Total Cost">Total Cost <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Payment Method</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Paid By</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-history-body">
                            <!-- Purchases history will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-download-purchases">
                    <h3 class="text-xl font-semibold text-gray-600">Download Purchases Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-download-purchases" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="download-purchases-details" class="hidden mt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Purchases History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-purchase-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-purchase-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-purchase-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-purchase-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-purchase-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-purchase-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Salary Section -->
        <div id="salary-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Salary</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Record Salary Payment</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="date" id="salary-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <div class="relative">
                        <input type="text" id="salary-employee" placeholder="Employee Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    </div>
                    <select id="salary-type" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="">Select Payment Type</option>
                        <option value="Weekly Salary">Weekly Salary</option>
                        <option value="Monthly Salary">Monthly Salary</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Overtime">Overtime</option>
                    </select>
                    <input type="number" id="salary-amount" placeholder="Amount" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-salary-btn" class="md:col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Payment
                    </button>
                </div>
                <div id="salary-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="salary-search" placeholder="Search employees..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="date">Date <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="employee">Employee Name <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Payment Type</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="amount" data-base-text="Amount">Amount <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salary-history-body">
                            <!-- Salary history will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-download-salary">
                    <h3 class="text-xl font-semibold text-gray-600">Download Salary Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-download-salary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="download-salary-details" class="hidden mt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Salary History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end mb-4">
                        <div>
                            <label for="download-salary-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-salary-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-salary-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-salary-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="download-salary-employees" class="block text-sm font-medium text-gray-700 mb-1">Select Employees</label>
                        <select id="download-salary-employees" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-salary-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-salary-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Profit & Loss Report</h2>
            <div class="p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="report-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="report-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="generate-report-btn" class="w-full p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Generate Report
                    </button>
                </div>
                <div id="report-output" class="mt-6 space-y-4">
                    <!-- Report will be displayed here -->
                </div>
                <div id="charts-container" class="mt-8">
                    <div class="max-w-md mx-auto">
                        <h3 class="text-lg font-semibold text-center text-gray-700 mb-2">Expense Breakdown</h3>
                        <canvas id="expenses-chart"></canvas>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Settings</h2>
            
            <div class="p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">How to Use This App</h3>
                <div class="space-y-4 text-sm text-gray-700">
                    <div>
                        <h4 class="font-semibold text-gray-800">Master Ingredients</h4>
                        <p>This is the foundation of your costing. Add every raw ingredient you purchase here. Be precise with the 'Unit' (e.g., kg, L, each) and 'Cost per Unit', as this is what all calculations are based on.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">Menu Costing & Unit Conversion</h4>
                        <p>Create your dishes and add components from your Master Ingredients list. The app automatically handles unit conversions like **kg to g** and **L to ml**. For items priced per piece, use **'each'** as the unit in both the master list and the recipe.</p>
                    </div>
                    <div>
                        <h4 class="font-semibold text-gray-800">Daily Sales</h4>
                        <p>Record your daily takings from all sources. You can click the arrow next to any record in the sales history to see a detailed breakdown of that day's sales.</p>
                    </div>
                     <div>
                        <h4 class="font-semibold text-gray-800">Data Management</h4>
                        <p>Use the **Backup** feature regularly to save a complete copy of your data to your computer. If anything goes wrong, you can use the **Restore** button to load your data back into the app.</p>
                    </div>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Currency</h3>
                <div class="max-w-xs">
                    <label for="currency-select" class="block text-sm font-medium text-gray-700 mb-1">Select Currency</label>
                    <select id="currency-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <!-- Currency options will be populated here by JavaScript -->
                    </select>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Data Management</h3>
                <div class="space-y-4">
                    <div>
                        <h4 class="text-md font-medium text-gray-700 mb-2">Backup All Data</h4>
                        <p class="text-sm text-gray-500 mb-2">Download a single JSON file containing all your restaurant data.</p>
                        <button id="backup-data-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download Backup
                        </button>
                    </div>
                    <div>
                        <h4 class="text-md font-medium text-gray-700 mb-2">Restore from Backup</h4>
                        <p class="text-sm text-gray-500 mb-2">Upload a previously saved JSON backup file. <span class="font-bold text-red-500">This will overwrite all current data.</span></p>
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <input type="file" id="restore-data-input" accept=".json" class="flex-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="restore-data-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-red-600 hover:bg-red-700 transition-colors duration-200 shadow-md">
                                Restore Data
                            </button>
                        </div>
                    </div>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Version History</h3>
                <div class="text-sm text-gray-600 space-y-4 max-h-48 overflow-y-auto">
                    <div>
                        <p class="font-semibold">Version 1.7 (Latest)</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Added "How to Use" guide in Settings.</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold">Version 1.6</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Added smart unit conversion to Menu Costing.</li>
                            <li>Added expandable sales breakdown view in Daily Sales.</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold">Version 1.5</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Removed Suppliers section to simplify data entry.</li>
                            <li>Removed Sales Trend chart from Reports (to be revisited).</li>
                            <li>Added version numbers to all downloaded filenames.</li>
                            <li>Improved layout for version history display.</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold">Version 1.4</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Added Suppliers tab for contact management.</li>
                            <li>Integrated suppliers into the Purchases section.</li>
                            <li>Added visual charts to the Reports tab.</li>
                            <li>Added full data backup and restore functionality in Settings.</li>
                        </ul>
                    </div>
                    <div>
                        <p class="font-semibold">Version 1.3</p>
                        <ul class="list-disc list-inside ml-4">
                            <li>Added clickable table headers for sorting data.</li>
                            <li>Added version history section.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h4 id="confirm-title" class="text-lg font-bold text-gray-800 mb-4">Confirm Action</h4>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">
                    Cancel
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                    Confirm
                </button>
            </div>
        </div>
    </div>
    
    <!-- JS PDF libraries for PDF generation (fixed order) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // IMPORTANT: Replace with your actual Firebase project configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        // **UPDATED** Import all necessary Firestore functions
        import { getFirestore, doc, setDoc, onSnapshot, collection, addDoc, deleteDoc, updateDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- App Version ---
        const APP_VERSION = '1.7';

        // Firebase configuration 
        const firebaseConfig = {
          apiKey: "AIzaSyAoWY28i0hP3DN2t8fw2A61rBDw2yoIwS0",
          authDomain: "my-web-app2-c8dd0.firebaseapp.com",
          projectId: "my-web-app2-c8dd0",
          storageBucket: "my-web-app2-c8dd0.appspot.com",
          messagingSenderId: "430499672591",
          appId: "1:430499672591:web:f11185605aece22dbee97a"
        };
        
        let db;
        
        // --- Core Data Structures ---
        let masterIngredients = [];
        let menuItems = [];
        let dailySales = [];
        let dailyPurchases = [];
        let salary = [];
        let settings = { currency: 'Â£' };
        let openMenuItems = new Set(); // Keep track of open menu items
        let openSalesRows = new Set(); // Keep track of open sales rows
        let sortState = {
            master: { key: 'name', order: 'asc' },
            sales: { key: 'date', order: 'desc' },
            purchases: { key: 'date', order: 'desc' },
            salary: { key: 'date', order: 'desc' }
        };
        
        // Initialize Firebase.
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // **REMOVED** The old saveDataToFirestore function is no longer needed.
        // Each action (add, delete, update) now communicates with Firestore directly.

        // **UPDATED** Use onSnapshot to get real-time updates from collections
        function setupFirestoreListeners() {
            if (!db) return;

            // Listener for Master Ingredients
            const ingredientsRef = collection(db, 'ingredients');
            onSnapshot(ingredientsRef, (snapshot) => {
                masterIngredients = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAllTabs();
            }, (error) => console.error("Error listening to ingredients:", error));

            // Listener for Menu Items
            const menuItemsRef = collection(db, 'menuItems');
            onSnapshot(menuItemsRef, (snapshot) => {
                menuItems = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAllTabs();
            }, (error) => console.error("Error listening to menu items:", error));

            // Listener for Daily Sales
            const salesRef = collection(db, 'dailySales');
            onSnapshot(salesRef, (snapshot) => {
                dailySales = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAllTabs();
            }, (error) => console.error("Error listening to sales:", error));

            // Listener for Purchases
            const purchasesRef = collection(db, 'dailyPurchases');
            onSnapshot(purchasesRef, (snapshot) => {
                dailyPurchases = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAllTabs();
            }, (error) => console.error("Error listening to purchases:", error));

            // Listener for Salary
            const salaryRef = collection(db, 'salary');
            onSnapshot(salaryRef, (snapshot) => {
                salary = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                rerenderAllTabs();
            }, (error) => console.error("Error listening to salary:", error));

            // Listener for Settings (still a single document)
            const settingsRef = doc(db, 'settings', 'appSettings');
            onSnapshot(settingsRef, (docSnap) => {
                if (docSnap.exists()) {
                    settings = docSnap.data();
                } else {
                    settings = { currency: 'Â£' }; // Default settings
                }
                document.getElementById('currency-select').value = settings.currency;
                rerenderAllTabs();
            }, (error) => console.error("Error listening to settings:", error));
        }
        
        // --- DOM Elements & Event Listeners ---
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginMessage = document.getElementById('login-message');
        const appContent = document.getElementById('app-content');
        
        const masterTab = document.getElementById('master-tab');
        const menuTab = document.getElementById('menu-tab');
        const salesTab = document.getElementById('sales-tab');
        const purchasesTab = document.getElementById('purchases-tab');
        const salaryTab = document.getElementById('salary-tab');
        const reportsTab = document.getElementById('reports-tab');
        const settingsTab = document.getElementById('settings-tab');

        const masterSection = document.getElementById('master-section');
        const menuSection = document.getElementById('menu-section');
        const salesSection = document.getElementById('sales-section');
        const purchasesSection = document.getElementById('purchases-section');
        const salarySection = document.getElementById('salary-section');
        const reportsSection = document.getElementById('reports-section');
        const settingsSection = document.getElementById('settings-section');
        
        const masterSearchInput = document.getElementById('master-search');
        const ingredientsTableBody = document.getElementById('ingredients-table-body');
        const addIngredientBtn = document.getElementById('add-ingredient-btn');
        const ingredientNameInput = document.getElementById('ingredient-name');
        const ingredientUnitInput = document.getElementById('ingredient-unit');
        const ingredientCostInput = document.getElementById('ingredient-cost');
        const masterMessage = document.getElementById('master-message');

        const menuSearchInput = document.getElementById('menu-search');
        const menuItemsContainer = document.getElementById('menu-items-container');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuItemNameInput = document.getElementById('menu-item-name');
        const itemTypeSelect = document.getElementById('item-type-select');
        const dineInPriceInput = document.getElementById('dine-in-price');
        const takeAwayPriceInput = document.getElementById('take-away-price');
        
        const salesSearchInput = document.getElementById('sales-search');
        const salesDateInput = document.getElementById('sales-date');
        const salesCashInput = document.getElementById('sales-cash');
        const salesCardInput = document.getElementById('sales-card');
        const salesUberInput = document.getElementById('sales-uber');
        const salesJustEatInput = document.getElementById('sales-justeat');
        const salesDeliverooInput = document.getElementById('sales-deliveroo');
        const salesWebsiteInput = document.getElementById('sales-website');
        const salesAdvanceInput = document.getElementById('sales-advance');
        const salesTooGoodToGoInput = document.getElementById('sales-toogoodtogo');
        const addSalesBtn = document.getElementById('add-sales-btn');
        const salesMessage = document.getElementById('sales-message');
        const salesHistoryBody = document.getElementById('sales-history-body');
        
        const purchasesSearchInput = document.getElementById('purchases-search');
        const purchaseDateInput = document.getElementById('purchase-date');
        const purchaseItemInput = document.getElementById('purchase-item');
        const purchaseCostInput = document.getElementById('purchase-cost');
        const purchasePaymentMethodInput = document.getElementById('purchase-payment-method');
        const purchasePaidByInput = document.getElementById('purchase-paid-by');
        const addPurchaseBtn = document.getElementById('add-purchase-btn');
        const purchaseMessage = document.getElementById('purchase-message');
        const purchasesHistoryBody = document.getElementById('purchases-history-body');
        
        const salarySearchInput = document.getElementById('salary-search');
        const salaryDateInput = document.getElementById('salary-date');
        const salaryEmployeeInput = document.getElementById('salary-employee');
        const salaryTypeInput = document.getElementById('salary-type');
        const salaryAmountInput = document.getElementById('salary-amount');
        const addSalaryBtn = document.getElementById('add-salary-btn');
        const salaryMessage = document.getElementById('salary-message');
        const salaryHistoryBody = document.getElementById('salary-history-body');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmTitle = document.getElementById('confirm-title');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        let pendingAction = null;

        const downloadStartDateInput = document.getElementById('download-start-date');
        const downloadEndDateInput = document.getElementById('download-end-date');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        
        const downloadPurchaseStartDateInput = document.getElementById('download-purchase-start-date');
        const downloadPurchaseEndDateInput = document.getElementById('download-purchase-end-date');
        const downloadPurchasePdfBtn = document.getElementById('download-purchase-pdf-btn');
        const downloadPurchaseCsvBtn = document.getElementById('download-purchase-csv-btn');

        const downloadSalaryStartDateInput = document.getElementById('download-salary-start-date');
        const downloadSalaryEndDateInput = document.getElementById('download-salary-end-date');
        const downloadSalaryEmployeesSelect = document.getElementById('download-salary-employees');
        const downloadSalaryPdfBtn = document.getElementById('download-salary-pdf-btn');
        const downloadSalaryCsvBtn = document.getElementById('download-salary-csv-btn');

        const downloadIngredientsPdfBtn = document.getElementById('download-ingredients-pdf-btn');
        const downloadIngredientsCsvBtn = document.getElementById('download-ingredients-csv-btn');
        const uploadIngredientsFile = document.getElementById('upload-ingredients-file');
        const uploadIngredientsBtn = document.getElementById('upload-ingredients-btn');
        const currencySelect = document.getElementById('currency-select');

        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportOutput = document.getElementById('report-output');
        let expensesChart;

        const backupDataBtn = document.getElementById('backup-data-btn');
        const restoreDataInput = document.getElementById('restore-data-input');
        const restoreDataBtn = document.getElementById('restore-data-btn');

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');


        // Set today's date on the date pickers
        const today = new Date().toISOString().split('T')[0];
        salesDateInput.value = today;
        purchaseDateInput.value = today;
        salaryDateInput.value = today;
        downloadStartDateInput.value = today;
        downloadEndDateInput.value = today;
        downloadPurchaseStartDateInput.value = today;
        downloadPurchaseEndDateInput.value = today;
        downloadSalaryStartDateInput.value = today;
        downloadSalaryEndDateInput.value = today;
        reportStartDateInput.value = today;
        reportEndDateInput.value = today;


        // --- Password Logic & Session Management ---
        const correctPassword = "Summer2025";

        function showApp() {
            loginContainer.classList.add('hidden');
            appContent.classList.remove('hidden');
            setupFirestoreListeners();
            switchTab(masterTab, masterSection);
        }

        // Check for existing login session on page load
        if (sessionStorage.getItem('isLoggedIn') === 'true') {
            showApp();
        }

        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === correctPassword) {
                sessionStorage.setItem('isLoggedIn', 'true');
                showApp();
            } else {
                loginMessage.classList.remove('hidden');
            }
        });


        // Function to switch tabs
        function switchTab(activeTab, activeSection) {
            const tabs = [masterTab, menuTab, salesTab, purchasesTab, salaryTab, reportsTab, settingsTab];
            const sections = [masterSection, menuSection, salesSection, purchasesSection, salarySection, reportsSection, settingsSection];
            tabs.forEach(tab => tab.classList.remove('border-indigo-500', 'text-indigo-600'));
            sections.forEach(section => section.classList.add('hidden'));
            activeTab.classList.add('border-indigo-500', 'text-indigo-600');
            activeSection.classList.remove('hidden');
        }

        // Tab click handlers
        const desktopTabs = [masterTab, menuTab, salesTab, purchasesTab, salaryTab, reportsTab, settingsTab];
        const sections = [masterSection, menuSection, salesSection, purchasesSection, salarySection, reportsSection, settingsSection];

        desktopTabs.forEach((tab, index) => {
            tab.addEventListener('click', () => switchTab(tab, sections[index]));
        });

        // Mobile Menu Logic
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        document.querySelectorAll('#mobile-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = e.target.dataset.tab;
                const tabButton = document.getElementById(`${tabName}-tab`);
                const section = document.getElementById(`${tabName}-section`);
                switchTab(tabButton, section);
                mobileMenu.classList.add('hidden');
            });
        });

        // --- Master Ingredients Logic ---
        function renderIngredients(data = masterIngredients) {
            const { key, order } = sortState.master;
            const sortedData = [...data].sort((a, b) => { // Create a copy before sorting
                if (a[key] < b[key]) return order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return order === 'asc' ? 1 : -1;
                return 0;
            });

            ingredientsTableBody.innerHTML = '';
            if (sortedData.length === 0) {
                masterMessage.textContent = 'No ingredients found.';
                return;
            }
            masterMessage.textContent = '';
            sortedData.forEach((ingredient) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${ingredient.name}</td>
                    <td class="py-3 px-4 text-gray-800">${ingredient.unit}</td>
                    <td class="py-3 px-4 text-gray-800">
                        ${settings.currency}<input type="number" value="${ingredient.cost.toFixed(2)}" class="w-24 p-1 border rounded text-right" data-id="${ingredient.id}">
                    </td>
                    <td class="py-3 px-4">
                        <button data-id="${ingredient.id}" class="delete-ingredient-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                ingredientsTableBody.appendChild(row);
            });
            attachIngredientEventListeners();
            updateSortIndicator('master');
        }

        masterSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredIngredients = masterIngredients.filter(ing => ing.name.toLowerCase().includes(query));
            renderIngredients(filteredIngredients);
        });

        function attachIngredientEventListeners() {
            // Delete button
            document.querySelectorAll('#ingredients-table-body .delete-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    const ingredient = masterIngredients.find(ing => ing.id === docId);
                    if (ingredient) {
                        confirmTitle.textContent = 'Confirm Deletion';
                        confirmMessage.textContent = `Are you sure you want to delete the ingredient "${ingredient.name}"? This will affect any menu items that use it.`;
                        pendingAction = async () => {
                            try {
                                await deleteDoc(doc(db, 'ingredients', docId));
                            } catch (err) {
                                console.error("Error deleting ingredient:", err);
                            }
                        };
                        confirmModal.classList.remove('hidden');
                    }
                });
            });

            // Editable cost input
            document.querySelectorAll('#ingredients-table-body input[type="number"]').forEach(input => {
                input.addEventListener('change', async (e) => { // Use 'change' to save only when focus is lost
                    const docId = e.target.dataset.id;
                    const newCost = parseFloat(e.target.value);
                    if (!isNaN(newCost) && newCost >= 0 && docId) {
                        try {
                            const ingredientRef = doc(db, 'ingredients', docId);
                            await updateDoc(ingredientRef, { cost: newCost });
                            // The onSnapshot listener will handle re-rendering, but we might want to instantly update menu COGS
                            renderMenuItems(); 
                        } catch (err) {
                            console.error("Error updating cost:", err);
                        }
                    }
                });
            });
        }
        
        addIngredientBtn.addEventListener('click', async () => { // **UPDATED** to be async
            const name = ingredientNameInput.value.trim();
            const unit = ingredientUnitInput.value.trim();
            const cost = parseFloat(ingredientCostInput.value);
            if (!name || !unit || isNaN(cost) || cost <= 0) {
                masterMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            
            // **UPDATED** Save directly to Firestore
            try {
                const newIngredient = { name, unit, cost };
                await addDoc(collection(db, 'ingredients'), newIngredient);
                ingredientNameInput.value = '';
                ingredientUnitInput.value = '';
                ingredientCostInput.value = '';
                masterMessage.textContent = 'Ingredient added successfully!';
            } catch (e) {
                console.error("Error adding ingredient: ", e);
                masterMessage.textContent = 'Failed to add ingredient.';
            }
        });

        // Master Ingredients Download
        downloadIngredientsPdfBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                showTemporaryMessage(downloadIngredientsPdfBtn, 'No ingredients to download.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Master Ingredients List", 14, 20);
            const tableColumn = ["Ingredient Name", "Unit", `Cost per Unit (${settings.currency})`];
            const tableRows = masterIngredients.map(ing => [ing.name, ing.unit, ing.cost.toFixed(2)]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Master_Ingredients_v${APP_VERSION}.pdf`);
        });

        downloadIngredientsCsvBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                showTemporaryMessage(downloadIngredientsCsvBtn, 'No ingredients to download.');
                return;
            }
            const headers = ["Ingredient Name", "Unit", "Cost per Unit"];
            const rows = masterIngredients.map(ing => [
                `"${ing.name.replace(/"/g, '""')}"`, // Handle quotes in names
                `"${ing.unit.replace(/"/g, '""')}"`,
                ing.cost
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Master_Ingredients_v${APP_VERSION}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Master Ingredients Upload
        uploadIngredientsBtn.addEventListener('click', () => {
            const file = uploadIngredientsFile.files[0];
            if (!file) {
                masterMessage.textContent = 'Please select a CSV file to upload.';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => { // **UPDATED** to be async
                const content = e.target.result;
                const lines = content.split(/\r?\n/); // Handle different line endings
                const newIngredients = [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                if (headers[0] !== 'Ingredient Name' || headers[1] !== 'Unit' || headers[2] !== 'Cost per Unit') {
                    masterMessage.textContent = 'Error: Invalid CSV headers. Expected "Ingredient Name", "Unit", "Cost per Unit".';
                    return;
                }
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
                        const name = parts[0];
                        const unit = parts[1];
                        const cost = parseFloat(parts[2]);
                        if (name && unit && !isNaN(cost) && cost > 0) {
                            newIngredients.push({ name, unit, cost });
                        }
                    }
                }
                
                // **UPDATED** This is a destructive action. We delete all old and add all new.
                try {
                    // Delete all existing ingredients
                    for (const ing of masterIngredients) {
                        await deleteDoc(doc(db, 'ingredients', ing.id));
                    }
                    // Add all new ingredients
                    for (const ing of newIngredients) {
                        await addDoc(collection(db, 'ingredients'), ing);
                    }
                    masterMessage.textContent = `Successfully uploaded ${newIngredients.length} ingredients!`;
                } catch (err) {
                    console.error("Error during upload:", err);
                    masterMessage.textContent = 'An error occurred during the upload process.';
                }
            };
            reader.readAsText(file);
        });


        // --- Unit Conversion Logic ---
        function convertUnits(quantity, unit, masterIngredient) {
            // If the master ingredient, its unit, or the target unit are missing, we can't calculate.
            if (!masterIngredient || !masterIngredient.unit || !unit) {
                console.warn(`Could not perform unit conversion due to missing data.`, { quantity, unit, masterIngredient });
                return 0;
            }
            const baseUnit = masterIngredient.unit.toLowerCase();
            const targetUnit = unit.toLowerCase();

            // If units are the same, no conversion needed
            if (baseUnit === targetUnit) {
                return masterIngredient.cost * quantity;
            }

            // Weight conversions
            if (baseUnit === 'kg' && targetUnit === 'g') {
                return masterIngredient.cost * (quantity / 1000);
            }
            if (baseUnit === 'g' && targetUnit === 'kg') {
                return masterIngredient.cost * (quantity * 1000);
            }

            // Volume conversions
            if (baseUnit === 'l' && targetUnit === 'ml') {
                return masterIngredient.cost * (quantity / 1000);
            }
            if (baseUnit === 'ml' && targetUnit === 'l') {
                return masterIngredient.cost * (quantity * 1000);
            }

            // If no conversion rule found, assume 1:1 (e.g., 'each')
            return masterIngredient.cost * quantity;
        }


        // --- Menu Items & Platters Logic ---
        function calculateCogs(ingredients) {
            let totalCogs = 0;
            if (!ingredients) return 0;
            ingredients.forEach(item => {
                totalCogs += calculateComponentCost(item);
            });
            return totalCogs;
        }

        function calculateComponentCost(component) {
            if (component.type === 'ingredient') {
                const masterIng = masterIngredients.find(i => i.name === component.name);
                return convertUnits(component.quantity, component.unit, masterIng);
            } else { // It's a dish/platter etc.
                const dish = menuItems.find(i => i.name === component.name);
                return dish ? calculateCogs(dish.ingredients) * component.quantity : 0;
            }
        }
        
        // Helper function to get the COGS star icon based on percentage
        function getCogsStar(percent) {
            let colorClass = 'text-gray-400';
            if (percent > 0 && percent <= 30) {
                colorClass = 'text-yellow-400';
            } else if (percent > 30 && percent <= 35) {
                colorClass = 'text-green-500';
            } else if (percent > 35 && percent <= 40) {
                colorClass = 'text-amber-500';
            } else if (percent > 40) {
                colorClass = 'text-red-500';
            }
            
            return `
                <div class="flex items-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} fill-current" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    <span class="text-xs font-semibold text-gray-600">${percent.toFixed(0)}%</span>
                </div>
            `;
        }

        function renderMenuItems(data = menuItems) {
            menuItemsContainer.innerHTML = '';
            if (data.length === 0) {
                menuItemsContainer.innerHTML = '<div class="text-center text-gray-600">No menu items found.</div>';
                return;
            }
            data.forEach((item, index) => {
                const cogs = calculateCogs(item.ingredients);
                const dineInVat = item.dineInPrice ? item.dineInPrice * 0.20 : 0;
                const takeAwayVat = item.takeAwayPrice ? item.takeAwayPrice * 0.20 : 0;
                
                const dineInCogsPercent = item.dineInPrice > 0 ? (cogs / item.dineInPrice) * 100 : 0;
                const takeAwayCogsPercent = item.takeAwayPrice > 0 ? (cogs / item.takeAwayPrice) * 100 : 0;
                
                const dineInCogsWithVat = cogs + dineInVat;
                const takeAwayCogsWithVat = cogs + takeAwayVat;

                const itemCard = document.createElement('div');
                itemCard.className = 'p-6 bg-white rounded-lg shadow-md border border-gray-200';
                itemCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4 cursor-pointer toggle-menu-item" data-id="${item.id}">
                        <h3 class="text-xl font-bold text-gray-800">${item.name} (${item.type.charAt(0).toUpperCase() + item.type.slice(1)})</h3>
                        <div class="flex items-center space-x-4">
                            <span class="text-lg font-semibold text-gray-600">COGS:</span>
                            <span class="text-2xl font-extrabold text-indigo-600">${settings.currency}${cogs.toFixed(2)}</span>
                            <button class="delete-item-btn text-red-500 hover:text-red-700" data-id="${item.id}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-${item.id}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div id="item-details-${item.id}" class="space-y-4 hidden">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In Price</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${item.dineInPrice ? item.dineInPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${dineInVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In COGS%</span>
                                ${item.dineInPrice > 0 ? getCogsStar(dineInCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away Price</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${item.takeAwayPrice ? item.takeAwayPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${takeAwayVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away COGS%</span>
                                ${item.takeAwayPrice > 0 ? getCogsStar(takeAwayCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Dine-In COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${dineInCogsWithVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Take-Away COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${takeAwayCogsWithVat.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- Online Markup Calculator -->
                        <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 mt-4">
                            <div class="flex items-center justify-between cursor-pointer toggle-online-pricing" data-id="${item.id}">
                                <h4 class="text-md font-semibold text-gray-700">Online Platform Pricing</h4>
                                <svg class="h-5 w-5 text-gray-400 transform transition-transform duration-200" id="online-chevron-${item.id}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <div id="online-pricing-details-${item.id}" class="hidden mt-4 grid grid-cols-2 gap-4 items-center">
                                <div class="flex items-center space-x-2">
                                    <label for="online-markup-${item.id}" class="text-sm font-medium text-gray-700">Markup:</label>
                                    <input type="number" id="online-markup-${item.id}" min="0" max="500" value="0" class="w-24 p-2 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-lg font-bold text-gray-600">%</span>
                                </div>
                                <div>
                                    <span class="block text-gray-500 text-sm">Online Selling Price:</span>
                                    <span class="block text-gray-800 font-bold text-lg" id="online-price-display-${item.id}">${settings.currency}${item.dineInPrice ? item.dineInPrice.toFixed(2) : '0.00'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Component</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Quantity</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Unit</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Cost</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-table-body-${item.id}">
                                    ${(item.ingredients || []).map((ing, i) => `
                                        <tr class="border-b border-gray-200 last:border-b-0">
                                            <td class="py-2 px-3 text-gray-700">${ing.name}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.quantity}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.unit}</td>
                                            <td class="py-2 px-3 text-gray-700">${settings.currency}${calculateComponentCost(ing).toFixed(2)}</td>
                                            <td class="py-2 px-3">
                                                <button class="remove-component-btn text-red-500 hover:text-red-700" data-item-id="${item.id}" data-component-index="${i}">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Add Component to Recipe</h4>
                            <div class="grid grid-cols-4 gap-2">
                                <select class="component-select p-2 border border-gray-300 rounded-lg col-span-2" data-item-id="${item.id}">
                                    <option value="">Select...</option>
                                    <optgroup label="Ingredients">
                                        ${masterIngredients.map(ing => `<option value="${ing.name}" data-type="ingredient">${ing.name}</option>`).join('')}
                                    </optgroup>
                                    ${item.type === 'platter' ? `<optgroup label="Dishes">${menuItems.filter(m => m.type !== 'platter' && m.name !== item.name).map(d => `<option value="${d.name}" data-type="dish">${d.name}</option>`).join('')}</optgroup>` : ''}
                                </select>
                                <input type="number" placeholder="Qty" class="component-quantity p-2 border border-gray-300 rounded-lg">
                                <input type="text" placeholder="Unit" class="component-unit p-2 border border-gray-300 rounded-lg">
                                <button class="add-component-btn p-2 text-white font-bold rounded-lg bg-indigo-500 hover:bg-indigo-600 transition-colors col-span-4 mt-2" data-item-id="${item.id}">Add</button>
                            </div>
                        </div>
                    </div>
                `;
                menuItemsContainer.appendChild(itemCard);
            });
            
            // Restore open states
            openMenuItems.forEach(id => {
                const details = document.getElementById(`item-details-${id}`);
                const chevron = document.getElementById(`chevron-${id}`);
                if (details && chevron) {
                    details.classList.remove('hidden');
                    chevron.classList.add('rotate-180');
                }
            });

            attachMenuEventListeners();
        }

        menuSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredMenu = menuItems.filter(item => item.name.toLowerCase().includes(query));
            renderMenuItems(filteredMenu);
        });

        addMenuItemBtn.addEventListener('click', async () => { // **UPDATED** to be async
            const name = menuItemNameInput.value.trim();
            const type = itemTypeSelect.value;
            const dineInPrice = parseFloat(dineInPriceInput.value) || 0;
            const takeAwayPrice = parseFloat(takeAwayPriceInput.value) || 0;
            if (!name) { return; }
            
            // **UPDATED** Save directly to Firestore
            try {
                const newItem = { name, type, ingredients: [], dineInPrice, takeAwayPrice };
                await addDoc(collection(db, 'menuItems'), newItem);
                menuItemNameInput.value = '';
                dineInPriceInput.value = '';
                takeAwayPriceInput.value = '';
            } catch(e) {
                console.error("Error adding menu item:", e);
            }
        });

        async function attachMenuEventListeners() {
            document.querySelectorAll('.add-component-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const itemId = btn.dataset.itemId;
                    const item = menuItems.find(i => i.id === itemId);
                    if (!item) return;

                    if (!item.ingredients) {
                        item.ingredients = [];
                    }
                    const card = btn.closest('.p-4');
                    const select = card.querySelector('.component-select');
                    const quantity = parseFloat(card.querySelector('.component-quantity').value);
                    const unit = card.querySelector('.component-unit').value.trim();
                    const selectedOption = select.options[select.selectedIndex];
                    const name = selectedOption.value;
                    const type = selectedOption.dataset.type;

                    if (!name || isNaN(quantity) || quantity <= 0 || !unit) { return; }
                    
                    item.ingredients.push({ name, quantity, unit, type });
                    
                    try {
                        await updateDoc(doc(db, 'menuItems', itemId), { ingredients: item.ingredients });
                        card.querySelector('.component-select').value = '';
                        card.querySelector('.component-quantity').value = '';
                        card.querySelector('.component-unit').value = '';
                    } catch(e) {
                        console.error("Error adding component:", e);
                    }
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    const item = menuItems.find(i => i.id === docId);
                    if (item) {
                        confirmTitle.textContent = 'Confirm Deletion';
                        confirmMessage.textContent = `Are you sure you want to delete the menu item "${item.name}"?`;
                        pendingAction = async () => {
                            try {
                                await deleteDoc(doc(db, 'menuItems', docId));
                            } catch(e) {
                                console.error("Error deleting menu item:", e);
                            }
                        };
                        confirmModal.classList.remove('hidden');
                    }
                });
            });
            
            document.querySelectorAll('.remove-component-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const itemId = e.currentTarget.dataset.itemId;
                    const componentIndex = e.currentTarget.dataset.componentIndex;
                    const item = menuItems.find(i => i.id === itemId);
                    if (item && item.ingredients) {
                        item.ingredients.splice(componentIndex, 1);
                        try {
                            await updateDoc(doc(db, 'menuItems', itemId), { ingredients: item.ingredients });
                        } catch(e) {
                            console.error("Error removing component:", e);
                        }
                    }
                });
            });
            
            document.querySelectorAll('[id^="online-markup-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const id = e.target.id.split('-')[2];
                    const markup = parseFloat(e.target.value) || 0;
                    const item = menuItems.find(i => i.id === id);
                    if (item) {
                        const dineInPrice = item.dineInPrice;
                        const onlinePrice = dineInPrice + (dineInPrice * (markup / 100));
                        document.getElementById(`online-price-display-${id}`).textContent = `${settings.currency}${onlinePrice.toFixed(2)}`;
                    }
                });
            });

            // Toggle collapsible sections
            document.querySelectorAll('.toggle-menu-item').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-item-btn')) {
                        return;
                    }
                    const id = header.dataset.id;
                    const details = document.getElementById(`item-details-${id}`);
                    const chevron = document.getElementById(`chevron-${id}`);
                    
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');

                    if (details.classList.contains('hidden')) {
                        openMenuItems.delete(id);
                    } else {
                        openMenuItems.add(id);
                    }
                });
            });

            document.querySelectorAll('.toggle-online-pricing').forEach(header => {
                header.addEventListener('click', (e) => {
                    const id = header.dataset.id;
                    const details = document.getElementById(`online-pricing-details-${id}`);
                    const chevron = document.getElementById(`online-chevron-${id}`);
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                });
            });
        }
        
        // --- Daily Sales Logic ---
        function renderDailySales(data = dailySales) {
            const { key, order } = sortState.sales;

            const sortedData = [...data].sort((a, b) => {
                let valA, valB;
                if (key === 'total') {
                    valA = (a.cash || 0) + (a.card || 0) + (a.uber || 0) + (a.justeat || 0) + (a.deliveroo || 0) + (a.website || 0) + (a.advance || 0) + (a.toogoodtogo || 0);
                    valB = (b.cash || 0) + (b.card || 0) + (b.uber || 0) + (b.justeat || 0) + (b.deliveroo || 0) + (b.website || 0) + (b.advance || 0) + (b.toogoodtogo || 0);
                } else if (key === 'online') {
                    valA = (a.uber || 0) + (a.justeat || 0) + (a.deliveroo || 0) + (a.website || 0) + (a.toogoodtogo || 0);
                    valB = (b.uber || 0) + (b.justeat || 0) + (b.deliveroo || 0) + (b.website || 0) + (b.toogoodtogo || 0);
                } else {
                    valA = a[key] || 0;
                    valB = b[key] || 0;
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            salesHistoryBody.innerHTML = '';
            if (sortedData.length === 0) {
                salesHistoryBody.innerHTML = `<tr><td colspan="7" class="text-center text-gray-600 py-4">No sales recorded yet.</td></tr>`;
                return;
            }
            sortedData.forEach((sale) => {
                const onlineTotal = (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.toogoodtogo || 0);
                const total = (sale.cash || 0) + (sale.card || 0) + onlineTotal + (sale.advance || 0);
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">
                        <button class="toggle-sales-details" data-id="${sale.id}">
                            <svg class="h-5 w-5 text-gray-500 transform transition-transform duration-200" id="sales-chevron-${sale.id}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 5l7 7-7 7" />
                            </svg>
                        </button>
                    </td>
                    <td class="py-3 px-4">${sale.date}</td>
                    <td class="py-3 px-4">${settings.currency}${(sale.cash || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${settings.currency}${(sale.card || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${settings.currency}${onlineTotal.toFixed(2)}</td>
                    <td class="py-3 px-4 font-bold">${settings.currency}${total.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-id="${sale.id}" class="delete-sales-record-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                
                const detailsRow = document.createElement('tr');
                detailsRow.id = `sales-details-${sale.id}`;
                detailsRow.className = 'hidden';
                detailsRow.innerHTML = `
                    <td colspan="7" class="p-4 bg-gray-50">
                        <div class="grid grid-cols-2 sm:grid-cols-3 md:grid-cols-4 gap-4 text-sm">
                            <div><span class="font-semibold">Uber Eats:</span> ${settings.currency}${(sale.uber || 0).toFixed(2)}</div>
                            <div><span class="font-semibold">Just Eat:</span> ${settings.currency}${(sale.justeat || 0).toFixed(2)}</div>
                            <div><span class="font-semibold">Deliveroo:</span> ${settings.currency}${(sale.deliveroo || 0).toFixed(2)}</div>
                            <div><span class="font-semibold">Website:</span> ${settings.currency}${(sale.website || 0).toFixed(2)}</div>
                            <div><span class="font-semibold">Booking Advance:</span> ${settings.currency}${(sale.advance || 0).toFixed(2)}</div>
                            <div><span class="font-semibold">Too Good To Go:</span> ${settings.currency}${(sale.toogoodtogo || 0).toFixed(2)}</div>
                        </div>
                    </td>
                `;

                salesHistoryBody.appendChild(row);
                salesHistoryBody.appendChild(detailsRow);
            });

            openSalesRows.forEach(id => {
                const details = document.getElementById(`sales-details-${id}`);
                const chevron = document.getElementById(`sales-chevron-${id}`);
                if (details && chevron) {
                    details.classList.remove('hidden');
                    chevron.classList.add('rotate-90');
                }
            });

            attachSalesEventListeners();
            updateSortIndicator('sales');
        }

        salesSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredSales = dailySales.filter(sale => sale.date.includes(query));
            renderDailySales(filteredSales);
        });

        function attachSalesEventListeners() {
            document.querySelectorAll('.delete-sales-record-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    const sale = dailySales.find(s => s.id === docId);
                    if (sale) {
                        confirmTitle.textContent = 'Confirm Deletion';
                        confirmMessage.textContent = `Are you sure you want to delete the sales record for ${sale.date}?`;
                        pendingAction = async () => {
                            try {
                                await deleteDoc(doc(db, 'dailySales', docId));
                            } catch(e) {
                                console.error("Error deleting sales record:", e);
                            }
                        };
                        confirmModal.classList.remove('hidden');
                    }
                });
            });

            document.querySelectorAll('.toggle-sales-details').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const details = document.getElementById(`sales-details-${id}`);
                    const chevron = document.getElementById(`sales-chevron-${id}`);
                    
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-90');

                    if (details.classList.contains('hidden')) {
                        openSalesRows.delete(id);
                    } else {
                        openSalesRows.add(id);
                    }
                });
            });
        }

        addSalesBtn.addEventListener('click', async () => { // **UPDATED** to be async
            const date = salesDateInput.value;
            const cash = parseFloat(salesCashInput.value) || 0;
            const card = parseFloat(salesCardInput.value) || 0;
            const uber = parseFloat(salesUberInput.value) || 0;
            const justeat = parseFloat(salesJustEatInput.value) || 0;
            const deliveroo = parseFloat(salesDeliverooInput.value) || 0;
            const website = parseFloat(salesWebsiteInput.value) || 0;
            const advance = parseFloat(salesAdvanceInput.value) || 0;
            const toogoodtogo = parseFloat(salesTooGoodToGoInput.value) || 0;

            if (!date) { 
                salesMessage.textContent = 'Please select a date.'; 
                return; 
            }
            
            const totalSales = cash + card + uber + justeat + deliveroo + website + advance + toogoodtogo;
            if (totalSales === 0) {
                salesMessage.textContent = 'Please enter a value for at least one sales category.';
                return;
            }

            // **UPDATED** Always add a new record. No more updating based on date.
            const newSale = { date, cash, card, uber, justeat, deliveroo, website, advance, toogoodtogo };
            try {
                await addDoc(collection(db, 'dailySales'), newSale);
                salesMessage.textContent = 'Sales recorded successfully!';
                
                // Clear input fields
                salesCashInput.value = '';
                salesCardInput.value = '';
                salesUberInput.value = '';
                salesJustEatInput.value = '';
                salesDeliverooInput.value = '';
                salesWebsiteInput.value = '';
                salesAdvanceInput.value = '';
                salesTooGoodToGoInput.value = '';
                salesDateInput.value = new Date().toISOString().split('T')[0];
            } catch (e) {
                console.error("Error adding sales record:", e);
                salesMessage.textContent = 'Failed to record sales.';
            }
        });

        // --- Purchases Logic ---
        function renderPurchases(data = dailyPurchases) {
            const { key, order } = sortState.purchases;
            const sortedData = [...data].sort((a, b) => {
                const valA = a[key] || '';
                const valB = b[key] || '';
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            purchasesHistoryBody.innerHTML = '';
            if (sortedData.length === 0) {
                purchasesHistoryBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-600 py-4">No purchases recorded yet.</td></tr>';
                return;
            }
            sortedData.forEach((purchase) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${purchase.date}</td>
                    <td class="py-3 px-4">${purchase.item}</td>
                    <td class="py-3 px-4">${settings.currency}${purchase.cost.toFixed(2)}</td>
                    <td class="py-3 px-4">${purchase.paymentMethod || ''}</td>
                    <td class="py-3 px-4">${purchase.paidBy || ''}</td>
                    <td class="py-3 px-4">
                        <button data-id="${purchase.id}" class="delete-purchase-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                purchasesHistoryBody.appendChild(row);
            });
            attachPurchasesEventListeners();
            updateSortIndicator('purchases');
        }

        purchasesSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredPurchases = dailyPurchases.filter(p => p.item.toLowerCase().includes(query));
            renderPurchases(filteredPurchases);
        });
        
        function attachPurchasesEventListeners() {
            document.querySelectorAll('.delete-purchase-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    const purchase = dailyPurchases.find(p => p.id === docId);
                    if (purchase) {
                        confirmTitle.textContent = 'Confirm Deletion';
                        confirmMessage.textContent = `Are you sure you want to delete the purchase record for "${purchase.item}" on ${purchase.date}?`;
                        pendingAction = async () => {
                            try {
                                await deleteDoc(doc(db, 'dailyPurchases', docId));
                            } catch(e) {
                                console.error("Error deleting purchase:", e);
                            }
                        };
                        confirmModal.classList.remove('hidden');
                    }
                });
            });
        }
        
        addPurchaseBtn.addEventListener('click', async () => { // **UPDATED** to be async
            const date = purchaseDateInput.value;
            const item = purchaseItemInput.value.trim();
            const cost = parseFloat(purchaseCostInput.value);
            const paymentMethod = purchasePaymentMethodInput.value;
            const paidBy = purchasePaidByInput.value.trim();
            if (!date || !item || isNaN(cost) || cost <= 0) {
                purchaseMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            
            const newPurchase = { date, item, cost, paymentMethod, paidBy };
            try {
                await addDoc(collection(db, 'dailyPurchases'), newPurchase);
                purchaseDateInput.value = today;
                purchaseItemInput.value = '';
                purchaseCostInput.value = '';
                purchasePaymentMethodInput.value = '';
                purchasePaidByInput.value = '';
                purchaseMessage.textContent = 'Purchase recorded successfully!';
            } catch(e) {
                console.error("Error adding purchase:", e);
                purchaseMessage.textContent = 'Failed to record purchase.';
            }
        });
        
        // --- Salary Logic ---
        function renderSalary(data = salary) {
            const { key, order } = sortState.salary;
            const sortedData = [...data].sort((a, b) => {
                if (a[key] < b[key]) return order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return order === 'asc' ? 1 : -1;
                return 0;
            });

            salaryHistoryBody.innerHTML = '';
            if (sortedData.length === 0) {
                salaryHistoryBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-600 py-4">No salary payments recorded yet.</td></tr>';
                return;
            }
            sortedData.forEach((payment) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${payment.date}</td>
                    <td class="py-3 px-4">${payment.employee}</td>
                    <td class="py-3 px-4">${payment.type}</td>
                    <td class="py-3 px-4">${settings.currency}${payment.amount.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-id="${payment.id}" class="delete-salary-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salaryHistoryBody.appendChild(row);
            });
            attachSalaryEventListeners();
            populateEmployeeDropdown();
            updateSortIndicator('salary');
        }

        salarySearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredSalary = salary.filter(payment => payment.employee.toLowerCase().includes(query));
            renderSalary(filteredSalary);
        });
        
        function populateEmployeeDropdown() {
            const uniqueEmployees = [...new Set(salary.map(p => p.employee))].sort();
            downloadSalaryEmployeesSelect.innerHTML = `<option value="">All Employees</option>`;
            uniqueEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                downloadSalaryEmployeesSelect.appendChild(option);
            });
        }

        function attachSalaryEventListeners() {
            document.querySelectorAll('.delete-salary-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const docId = e.currentTarget.dataset.id;
                    const payment = salary.find(p => p.id === docId);
                    if (payment) {
                        confirmTitle.textContent = 'Confirm Deletion';
                        confirmMessage.textContent = `Are you sure you want to delete the salary payment for "${payment.employee}" on ${payment.date}?`;
                        pendingAction = async () => {
                            try {
                                await deleteDoc(doc(db, 'salary', docId));
                            } catch(e) {
                                console.error("Error deleting salary:", e);
                            }
                        };
                        confirmModal.classList.remove('hidden');
                    }
                });
            });
        }

        addSalaryBtn.addEventListener('click', async () => { // **UPDATED** to be async
            const date = salaryDateInput.value;
            const employee = salaryEmployeeInput.value.trim();
            const type = salaryTypeInput.value;
            const amount = parseFloat(salaryAmountInput.value);
            if (!date || !employee || !type || isNaN(amount) || amount <= 0) {
                salaryMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            
            const newPayment = { date, employee, type, amount };
            try {
                await addDoc(collection(db, 'salary'), newPayment);
                salaryDateInput.value = today;
                salaryEmployeeInput.value = '';
                salaryTypeInput.value = '';
                salaryAmountInput.value = '';
                salaryMessage.textContent = 'Salary payment recorded successfully!';
            } catch (e) {
                console.error("Error adding salary:", e);
                salaryMessage.textContent = 'Failed to record salary.';
            }
        });

        // --- Global Data Management (Confirmation & Downloads) ---
        confirmDeleteBtn.addEventListener('click', () => {
            if (pendingAction) {
                pendingAction();
            }
            pendingAction = null;
            confirmModal.classList.add('hidden');
        });

        cancelDeleteBtn.addEventListener('click', () => {
            pendingAction = null;
            confirmModal.classList.add('hidden');
        });
        
        // --- Helper function for temporary messages ---
        function showTemporaryMessage(element, message, isError = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mt-2 text-sm font-medium ${isError ? 'text-red-500' : 'text-green-500'}`;
            messageDiv.textContent = message;
            // Insert after the button's container
            element.closest('div').insertAdjacentElement('afterend', messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        // --- Download Functions ---

        // Sales PDF Download
        downloadPdfBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadPdfBtn, 'Please select a start and end date.');
                return;
            }
            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);
            if (filteredSales.length === 0) {
                showTemporaryMessage(downloadPdfBtn, 'No sales data for the selected date range.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Daily Sales Report", 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", `Cash (${settings.currency})`, `Card (${settings.currency})`, `Online (${settings.currency})`, `Total (${settings.currency})`];
            const tableRows = filteredSales.map(sale => {
                const onlineTotal = (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.toogoodtogo || 0);
                const total = (sale.cash || 0) + (sale.card || 0) + onlineTotal + (sale.advance || 0);
                return [sale.date, (sale.cash || 0).toFixed(2), (sale.card || 0).toFixed(2), onlineTotal.toFixed(2), total.toFixed(2)];
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40
            });
            doc.save(`Sales_Report_v${APP_VERSION}_${startDate}_to_${endDate}.pdf`);
        });

        // Sales CSV Download
        downloadCsvBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadCsvBtn, 'Please select a start and end date.');
                return;
            }
            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);
            if (filteredSales.length === 0) {
                showTemporaryMessage(downloadCsvBtn, 'No sales data for the selected date range.');
                return;
            }
            const headers = ["Date", "Cash", "Card", "Uber Eats", "Just Eat", "Deliveroo", "Website", "Booking Advance", "Too Good To Go", "Total"];
            const rows = filteredSales.map(sale => {
                const total = (sale.cash || 0) + (sale.card || 0) + (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.advance || 0) + (sale.toogoodtogo || 0);
                return [
                    `"${sale.date}"`, sale.cash || 0, sale.card || 0, sale.uber || 0, sale.justeat || 0, sale.deliveroo || 0, sale.website || 0, sale.advance || 0, sale.toogoodtogo || 0, total
                ].join(",");
            });
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Sales_Report_v${APP_VERSION}_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Purchases PDF Download
        downloadPurchasePdfBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadPurchasePdfBtn, 'Please select a start and end date.');
                return;
            }
            const filteredPurchases = dailyPurchases.filter(p => p.date >= startDate && p.date <= endDate);
            if (filteredPurchases.length === 0) {
                showTemporaryMessage(downloadPurchasePdfBtn, 'No purchase data for the selected date range.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Purchases Report", 14, 20);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", "Item/Service", `Total Cost (${settings.currency})`, "Payment Method", "Paid By"];
            const tableRows = filteredPurchases.map(p => [p.date, p.item, p.cost.toFixed(2), p.paymentMethod, p.paidBy]);
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40 });
            doc.save(`Purchases_Report_v${APP_VERSION}_${startDate}_to_${endDate}.pdf`);
        });

        // Purchases CSV Download
        downloadPurchaseCsvBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadPurchaseCsvBtn, 'Please select a start and end date.');
                return;
            }
            const filteredPurchases = dailyPurchases.filter(p => p.date >= startDate && p.date <= endDate);
            if (filteredPurchases.length === 0) {
                showTemporaryMessage(downloadPurchaseCsvBtn, 'No purchase data for the selected date range.');
                return;
            }
            const headers = ["Date", "Item/Service", "Total Cost", "Payment Method", "Paid By"];
            const rows = filteredPurchases.map(p => [`"${p.date}"`, `"${p.item.replace(/"/g, '""')}"`, p.cost, `"${p.paymentMethod}"`, `"${p.paidBy}"`].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Purchases_Report_v${APP_VERSION}_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Salary PDF Download
        downloadSalaryPdfBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadSalaryPdfBtn, 'Please select a start and end date.');
                return;
            }

            let filteredSalary = salary.filter(p => p.date >= startDate && p.date <= endDate);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(p => selectedEmployees.includes(p.employee));
            }

            if (filteredSalary.length === 0) {
                showTemporaryMessage(downloadSalaryPdfBtn, 'No salary data for the selected criteria.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Salary Report", 14, 20);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                doc.text(`Employees: ${selectedEmployees.join(', ')}`, 14, 37);
            }

            const tableColumn = ["Date", "Employee Name", "Payment Type", `Amount (${settings.currency})`];
            const tableRows = filteredSalary.map(p => [p.date, p.employee, p.type, p.amount.toFixed(2)]);
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 45 });
            doc.save(`Salary_Report_v${APP_VERSION}_${startDate}_to_${endDate}.pdf`);
        });

        // Salary CSV Download
        downloadSalaryCsvBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadSalaryCsvBtn, 'Please select a start and end date.');
                return;
            }

            let filteredSalary = salary.filter(p => p.date >= startDate && p.date <= endDate);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(p => selectedEmployees.includes(p.employee));
            }
            
            if (filteredSalary.length === 0) {
                showTemporaryMessage(downloadSalaryCsvBtn, 'No salary data for the selected criteria.');
                return;
            }

            const headers = ["Date", "Employee Name", "Payment Type", "Amount"];
            const rows = filteredSalary.map(p => [`"${p.date}"`, `"${p.employee.replace(/"/g, '""')}"`, `"${p.type}"`, p.amount].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Salary_Report_v${APP_VERSION}_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Collapsible Sections Logic ---
        document.getElementById('toggle-manage-ingredients').addEventListener('click', () => {
            document.getElementById('manage-ingredients-details').classList.toggle('hidden');
            document.getElementById('chevron-manage-ingredients').classList.toggle('rotate-180');
        });
        document.getElementById('toggle-download-sales').addEventListener('click', () => {
            document.getElementById('download-sales-details').classList.toggle('hidden');
            document.getElementById('chevron-download-sales').classList.toggle('rotate-180');
        });
        document.getElementById('toggle-download-purchases').addEventListener('click', () => {
            document.getElementById('download-purchases-details').classList.toggle('hidden');
            document.getElementById('chevron-download-purchases').classList.toggle('rotate-180');
        });
        document.getElementById('toggle-download-salary').addEventListener('click', () => {
            document.getElementById('download-salary-details').classList.toggle('hidden');
            document.getElementById('chevron-download-salary').classList.toggle('rotate-180');
        });

        // --- Settings Logic ---
        const currencies = {
            "EUR": "â¬",
            "GBP": "Â£",
            "PLN": "zÅ",
            "USD": "$",
            "BDT": "à§³"
        };

        function populateCurrencyDropdown() {
            for (const code in currencies) {
                const option = document.createElement('option');
                option.value = currencies[code];
                option.textContent = `${code} (${currencies[code]})`;
                currencySelect.appendChild(option);
            }
        }
        populateCurrencyDropdown();

        currencySelect.addEventListener('change', async (e) => { // **UPDATED** to be async
            settings.currency = e.target.value;
            try {
                // **UPDATED** Save settings to its own document
                await setDoc(doc(db, 'settings', 'appSettings'), settings);
            } catch (e) {
                console.error("Error saving settings:", e);
            }
            rerenderAllTabs();
        });

        function rerenderAllTabs() {
            renderIngredients();
            renderMenuItems();
            renderDailySales();
            renderPurchases();
            renderSalary();
            updatePlaceholdersAndHeaders();
            setupAllAutocomplete();
        }

        function updatePlaceholdersAndHeaders() {
            const currency = settings.currency;
            document.getElementById('ingredient-cost').placeholder = `Cost per Unit (${currency})`;
            document.getElementById('dine-in-price').placeholder = `Dine-In Price (${currency})`;
            document.getElementById('take-away-price').placeholder = `Take-Away Price (${currency})`;
            document.getElementById('sales-cash').placeholder = `Cash (${currency})`;
            document.getElementById('sales-card').placeholder = `Card (${currency})`;
            document.getElementById('sales-uber').placeholder = `Uber Eats (${currency})`;
            document.getElementById('sales-justeat').placeholder = `Just Eat (${currency})`;
            document.getElementById('sales-deliveroo').placeholder = `Deliveroo (${currency})`;
            document.getElementById('sales-website').placeholder = `Website (${currency})`;
            document.getElementById('sales-advance').placeholder = `Booking Advance (${currency})`;
            document.getElementById('sales-toogoodtogo').placeholder = `Too Good To Go (${currency})`;
            document.getElementById('purchase-cost').placeholder = `Total Cost (${currency})`;
            document.getElementById('salary-amount').placeholder = `Amount (${currency})`;
            
            document.querySelectorAll('.currency-header').forEach(header => {
                const baseText = header.dataset.baseText;
                const arrow = header.querySelector('.sort-arrow').outerHTML;
                header.innerHTML = `${baseText} (${currency}) ${arrow}`;
            });
        }

        // --- Reports Logic ---
        generateReportBtn.addEventListener('click', () => {
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;

            if (!startDate || !endDate) {
                reportOutput.innerHTML = `<p class="text-red-500">Please select a start and end date.</p>`;
                return;
            }

            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);
            const filteredPurchases = dailyPurchases.filter(p => p.date >= startDate && p.date <= endDate);
            const filteredSalary = salary.filter(s => s.date >= startDate && s.date <= endDate);

            const totalSales = filteredSales.reduce((acc, sale) => {
                return acc + (sale.cash || 0) + (sale.card || 0) + (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.advance || 0) + (sale.toogoodtogo || 0);
            }, 0);

            const totalPurchases = filteredPurchases.reduce((acc, p) => acc + p.cost, 0);
            const totalSalary = filteredSalary.reduce((acc, s) => acc + s.amount, 0);
            const totalExpenses = totalPurchases + totalSalary;
            const netProfit = totalSales - totalExpenses;

            reportOutput.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 bg-green-100 rounded-lg">
                        <span class="font-semibold text-green-800">Total Sales:</span>
                        <span class="font-bold text-green-800">${settings.currency}${totalSales.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-100 rounded-lg">
                        <span class="font-semibold text-red-800">Total Expenses:</span>
                        <span class="font-bold text-red-800">${settings.currency}${totalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-blue-100 rounded-lg">
                        <span class="font-semibold text-blue-800">Net Profit:</span>
                        <span class="font-bold text-blue-800">${settings.currency}${netProfit.toFixed(2)}</span>
                    </div>
                </div>
            `;

            renderReportCharts(totalPurchases, totalSalary);
        });

        function renderReportCharts(purchaseTotal, salaryTotal) {
            if (expensesChart) expensesChart.destroy();

            // Expenses Breakdown Chart (Doughnut)
            const expensesCtx = document.getElementById('expenses-chart').getContext('2d');
            expensesChart = new Chart(expensesCtx, {
                type: 'doughnut',
                data: {
                    labels: ['Purchases', 'Salary'],
                    datasets: [{
                        label: 'Expenses',
                        data: [purchaseTotal, salaryTotal],
                        backgroundColor: ['rgb(220, 38, 38)', 'rgb(219, 39, 119)'],
                        hoverOffset: 4
                    }]
                }
            });
        }

        // --- Data Backup & Restore ---
        backupDataBtn.addEventListener('click', () => {
            const allData = {
                masterIngredients,
                menuItems,
                dailySales,
                dailyPurchases,
                salary,
                settings
            };
            const dataStr = JSON.stringify(allData, null, 2);
            const blob = new Blob([dataStr], {type: "application/json"});
            const url = URL.createObjectURL(blob);
            const a = document.createElement('a');
            a.href = url;
            a.download = `restaurant_manager_backup_v${APP_VERSION}_${new Date().toISOString().split('T')[0]}.json`;
            document.body.appendChild(a);
            a.click();
            document.body.removeChild(a);
            URL.revokeObjectURL(url);
        });

        restoreDataBtn.addEventListener('click', () => {
            const file = restoreDataInput.files[0];
            if (!file) {
                showTemporaryMessage(restoreDataBtn, 'Please select a backup file to restore.');
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                try {
                    const data = JSON.parse(e.target.result);
                    confirmTitle.textContent = 'Confirm Restore';
                    confirmMessage.textContent = 'Are you sure you want to restore from this backup? This will overwrite all current data in the application.';
                    pendingAction = async () => {
                        // **UPDATED** This is now a more complex operation.
                        // It requires deleting all docs in all collections and then adding the new ones.
                        // This is an advanced topic. For now, we will show a message.
                        // A full implementation would require batch writes.
                        alert("Restoring from backup with the new database structure requires a more complex migration. This feature is temporarily disabled in this version.");
                    };
                    confirmModal.classList.remove('hidden');
                } catch (error) {
                    showTemporaryMessage(restoreDataBtn, 'Error: Invalid backup file format.');
                    console.error("Error parsing backup file:", error);
                }
            };
            reader.readAsText(file);
        });


        // --- Enter Key Navigation & Autocomplete Logic ---
        function setupEnterKeyNavigation(formElements, submitButton) {
            formElements.forEach((element, index) => {
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextElement = formElements[index + 1];
                        if (nextElement) {
                            nextElement.focus();
                        } else {
                            submitButton.click();
                        }
                    }
                });
            });
        }

        function setupAutocomplete(inputElement, data) {
            let currentFocus;
            inputElement.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-suggestions");
                this.parentNode.appendChild(a);
                for (i = 0; i < data.length; i++) {
                    if (data[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.setAttribute("class", "autocomplete-suggestion");
                        b.innerHTML = "<strong>" + data[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += data[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + data[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inputElement.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-suggestions");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inputElement) {
                    x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function setupAllAutocomplete() {
            const purchaseItems = [...new Set(dailyPurchases.map(p => p.item))];
            const paidByNames = [...new Set(dailyPurchases.map(p => p.paidBy).filter(Boolean))];
            const employeeNames = [...new Set(salary.map(s => s.employee))];
            
            setupAutocomplete(purchaseItemInput, purchaseItems);
            setupAutocomplete(purchasePaidByInput, paidByNames);
            setupAutocomplete(salaryEmployeeInput, employeeNames);
        }

        setupEnterKeyNavigation([ingredientNameInput, ingredientUnitInput, ingredientCostInput], addIngredientBtn);
        setupEnterKeyNavigation([menuItemNameInput, itemTypeSelect, dineInPriceInput, takeAwayPriceInput], addMenuItemBtn);
        setupEnterKeyNavigation([salesDateInput, salesCashInput, salesCardInput, salesUberInput, salesJustEatInput, salesDeliverooInput, salesWebsiteInput, salesAdvanceInput, salesTooGoodToGoInput], addSalesBtn);
        setupEnterKeyNavigation([purchaseDateInput, purchaseItemInput, purchaseCostInput, purchasePaymentMethodInput, purchasePaidByInput], addPurchaseBtn);
        setupEnterKeyNavigation([salaryDateInput, salaryEmployeeInput, salaryTypeInput, salaryAmountInput], addSalaryBtn);

        // --- Sorting Logic ---
        function handleSort(table, key) {
            if (sortState[table].key === key) {
                sortState[table].order = sortState[table].order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[table].key = key;
                sortState[table].order = 'asc';
            }
            rerenderAllTabs();
        }

        function updateSortIndicator(table) {
            document.querySelectorAll(`#${table}-section .sortable`).forEach(header => {
                const key = header.dataset.sort;
                const arrow = header.querySelector('.sort-arrow');
                header.classList.remove('sorted');
                if(arrow) arrow.innerHTML = '';

                if (sortState[table].key === key) {
                    header.classList.add('sorted');
                    if(arrow) arrow.innerHTML = sortState[table].order === 'asc' ? 'â²' : 'â¼';
                }
            });
        }

        appContent.addEventListener('click', (e) => {
            const header = e.target.closest('.sortable');
            if (header) {
                const table = header.closest('div[id$="-section"]').id.split('-')[0];
                const key = header.dataset.sort;
                handleSort(table, key);
            }
        });

    </script>
</body>
</html>
