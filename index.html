<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Manager</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Google Fonts for a modern look -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* Use the Inter font family */
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1200px; /* Increased max-width for better layout on larger screens */
        }
        /* Hide number input spinners for a cleaner look */
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        /* Simple transition for tab content visibility */
        .tab-content {
            transition: opacity 0.3s ease-in-out;
        }
        .hidden {
            display: none;
        }
        /* Autocomplete styles */
        .autocomplete-suggestions {
            border: 1px solid #ddd;
            max-height: 150px;
            overflow-y: auto;
            position: absolute;
            background-color: white;
            z-index: 10;
            width: 100%;
        }
        .autocomplete-suggestion {
            padding: 8px;
            cursor: pointer;
        }
        .autocomplete-suggestion:hover {
            background-color: #f0f0f0;
        }
        /* Sorting arrows */
        .sortable {
            cursor: pointer;
        }
        .sort-arrow {
            display: inline-block;
            margin-left: 5px;
            opacity: 0.5;
        }
        .sortable.sorted .sort-arrow {
            opacity: 1;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-2 sm:p-4">

    <!-- Login/Password Form -->
    <div id="login-container" class="container bg-white rounded-xl shadow-2xl p-6 sm:p-8 w-full max-w-md">
        <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800 text-center mb-4">Restaurant Manager</h1>
        <p class="text-center text-gray-500 mb-6">Enter the password to access the app.</p>
        <form id="login-form">
            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            <button type="submit" class="w-full mt-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                Log In
            </button>
        </form>
        <div id="login-message" class="mt-4 text-center text-sm font-medium text-red-500 hidden">Incorrect password. Please try again.</div>
    </div>

    <!-- Main Application Content -->
    <div id="app-content" class="container bg-white rounded-xl shadow-2xl p-4 sm:p-6 md:p-8 w-full hidden">
        <!-- Header -->
        <div class="text-center mb-8">
            <h1 class="text-3xl sm:text-4xl font-extrabold text-gray-800">Restaurant Manager</h1>
            <p class="mt-2 text-lg text-gray-500">Your all-in-one tool for costing, sales, and purchases.</p>
        </div>

        <!-- Navigation Tabs -->
        <div class="relative border-b border-gray-200 mb-6">
            <!-- Mobile Menu Button -->
            <div class="md:hidden flex justify-end">
                <button id="mobile-menu-button" class="p-2 rounded-md text-gray-600 hover:bg-gray-100">
                    <svg class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16m-7 6h7" />
                    </svg>
                </button>
            </div>
            <!-- Desktop Tabs -->
            <div id="desktop-tabs" class="hidden md:flex flex-wrap">
                <button id="master-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Master Ingredients
                </button>
                <button id="menu-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Menu Costing
                </button>
                <button id="sales-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Daily Sales
                </button>
                <button id="purchases-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Purchases
                </button>
                <button id="salary-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Salary
                </button>
                <button id="reports-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Reports
                </button>
                <button id="settings-tab" class="py-3 px-4 lg:px-6 text-sm md:text-base font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                    Settings
                </button>
            </div>
             <!-- Mobile Menu Dropdown -->
            <div id="mobile-menu" class="hidden md:hidden absolute right-0 mt-2 w-48 bg-white rounded-md shadow-lg z-20">
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="master">Master Ingredients</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="menu">Menu Costing</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="sales">Daily Sales</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="purchases">Purchases</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="salary">Salary</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="reports">Reports</a>
                <a href="#" class="block px-4 py-2 text-sm text-gray-700 hover:bg-gray-100" data-tab="settings">Settings</a>
            </div>
        </div>

        <!-- Content Sections -->

        <!-- Master Ingredients Section -->
        <div id="master-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Master Ingredients</h2>
            
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Add a New Ingredient</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="ingredient-name" placeholder="Ingredient Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="ingredient-unit" placeholder="Unit (e.g., kg, gram)" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="ingredient-cost" placeholder="Cost per Unit" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-ingredient-btn" class="w-full p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Ingredient
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" id="master-search" placeholder="Search ingredients..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="name">Ingredient <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Unit</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="cost">Cost per Unit <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="ingredients-table-body">
                            <!-- Ingredient rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
            
            <div id="master-message" class="mt-4 p-3 text-center text-sm font-medium text-gray-600 rounded-lg"></div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-manage-ingredients">
                    <h3 class="text-xl font-semibold text-gray-600">Manage Ingredient Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-manage-ingredients" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="manage-ingredients-details" class="hidden mt-4">
                    <div class="mb-6">
                        <h4 class="text-lg font-medium text-gray-700 mb-2">Download All Ingredients</h4>
                        <div class="flex flex-col sm:flex-row gap-4">
                            <button id="download-ingredients-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                                Download as PDF
                            </button>
                            <button id="download-ingredients-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                                Download as Google Sheet (CSV)
                            </button>
                        </div>
                    </div>

                    <div>
                        <h4 class="text-lg font-medium text-gray-700 mb-2">Upload Ingredients (CSV)</h4>
                        <p class="text-sm text-gray-500 mb-2">CSV file should have headers: "Ingredient Name", "Unit", "Cost per Unit"</p>
                        <div class="flex flex-col sm:flex-row gap-4 items-center">
                            <input type="file" id="upload-ingredients-file" accept=".csv" class="flex-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                            <button id="upload-ingredients-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                                Upload & Replace
                            </button>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Items & Platters Section -->
        <div id="menu-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Menu Costing</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Add New Dish or Platter</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="menu-item-name" placeholder="Name" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="item-type-select" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="dish">Dish</option>
                        <option value="platter">Platter</option>
                        <option value="starter">Starter</option>
                        <option value="sides">Sides</option>
                        <option value="salads">Salads</option>
                        <option value="dessert">Dessert</option>
                        <option value="drinks">Drinks</option>
                        <option value="wraps">Wraps</option>
                    </select>
                    <input type="number" id="dine-in-price" placeholder="Dine-In Price" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="take-away-price" placeholder="Take-Away Price" class="md:col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-menu-item-btn" class="md:col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Item
                    </button>
                </div>
            </div>

            <div class="mb-4">
                <input type="text" id="menu-search" placeholder="Search menu items..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div id="menu-items-container" class="space-y-6 overflow-y-auto max-h-96">
                <!-- Menu item cards will be dynamically inserted here -->
            </div>
        </div>
        
        <!-- Daily Sales Section -->
        <div id="sales-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Daily Sales & Bookings</h2>
            
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Record Today's Sales</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <input type="date" id="sales-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-cash" placeholder="Cash" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-card" placeholder="Card" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-uber" placeholder="Uber Eats" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-justeat" placeholder="Just Eat" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-deliveroo" placeholder="Deliveroo" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-website" placeholder="Website" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-advance" placeholder="Booking Advance" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-toogoodtogo" placeholder="Too Good To Go" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-sales-btn" class="md:col-span-3 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Sales
                    </button>
                </div>
                <div id="sales-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>
            
            <div class="mb-4">
                <input type="text" id="sales-search" placeholder="Search sales by date..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="date">Date <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="cash">Cash <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="card">Card <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="online">Online <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="total">Total <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="sales-history-body">
                            <!-- Sales history will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-download-sales">
                    <h3 class="text-xl font-semibold text-gray-600">Download Sales Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-download-sales" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="download-sales-details" class="hidden mt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Sales History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchases Section -->
        <div id="purchases-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Purchases & Expenses</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Record a Purchase</h3>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-4 items-end">
                    <input type="date" id="purchase-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <div class="relative">
                        <input type="text" id="purchase-item" placeholder="Item/Service Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    </div>
                    <input type="number" id="purchase-cost" placeholder="Total Cost" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="purchase-payment-method" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="">Payment Method</option>
                        <option value="Credit">Credit</option>
                        <option value="Cash">Cash</option>
                        <option value="Bank Transfer">Bank Transfer</option>
                        <option value="Card Payment">Card Payment</option>
                        <option value="Direct Debit">Direct Debit</option>
                        <option value="Other">Other</option>
                    </select>
                    <div class="relative">
                        <input type="text" id="purchase-paid-by" placeholder="Paid By" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    </div>
                    <button id="add-purchase-btn" class="md:col-span-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Purchase
                    </button>
                </div>
                <div id="purchase-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="purchases-search" placeholder="Search purchases..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="date">Date <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="item">Item/Service <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="cost">Total Cost <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Payment Method</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Paid By</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="purchases-history-body">
                            <!-- Purchases history will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-download-purchases">
                    <h3 class="text-xl font-semibold text-gray-600">Download Purchases Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-download-purchases" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="download-purchases-details" class="hidden mt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Purchases History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-purchase-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-purchase-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-purchase-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-purchase-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-purchase-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-purchase-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Salary Section -->
        <div id="salary-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Salary</h2>

            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Record Salary Payment</h3>
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 items-end">
                    <input type="date" id="salary-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <div class="relative">
                        <input type="text" id="salary-employee" placeholder="Employee Name" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    </div>
                    <select id="salary-type" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="">Select Payment Type</option>
                        <option value="Weekly Salary">Weekly Salary</option>
                        <option value="Monthly Salary">Monthly Salary</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Overtime">Overtime</option>
                    </select>
                    <input type="number" id="salary-amount" placeholder="Amount" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-salary-btn" class="md:col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Payment
                    </button>
                </div>
                <div id="salary-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <div class="mb-4">
                <input type="text" id="salary-search" placeholder="Search employees..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-x-auto">
                <div class="overflow-y-auto max-h-96">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                            <tr>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="date">Date <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 sortable" data-sort="employee">Employee Name <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Payment Type</th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600 currency-header sortable" data-sort="amount">Amount <span class="sort-arrow"></span></th>
                                <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                            </tr>
                        </thead>
                        <tbody id="salary-history-body">
                            <!-- Salary history will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>

            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="flex items-center justify-between cursor-pointer" id="toggle-download-salary">
                    <h3 class="text-xl font-semibold text-gray-600">Download Salary Data</h3>
                    <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-download-salary" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                        <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                    </svg>
                </div>
                <div id="download-salary-details" class="hidden mt-4">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Salary History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end mb-4">
                        <div>
                            <label for="download-salary-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-salary-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-salary-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-salary-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="download-salary-employees" class="block text-sm font-medium text-gray-700 mb-1">Select Employees</label>
                        <select id="download-salary-employees" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-salary-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-salary-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Reports Section -->
        <div id="reports-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Profit & Loss Report</h2>
            <div class="p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <div class="grid grid-cols-1 sm:grid-cols-3 gap-4 items-end">
                    <div>
                        <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="report-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div>
                        <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="report-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <button id="generate-report-btn" class="w-full p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Generate Report
                    </button>
                </div>
                <div id="report-output" class="mt-6 space-y-4">
                    <!-- Report will be displayed here -->
                </div>
            </div>
        </div>

        <!-- Settings Section -->
        <div id="settings-section" class="tab-content p-2 sm:p-6 bg-gray-50 rounded-lg hidden">
            <h2 class="text-xl sm:text-2xl font-bold mb-4 text-gray-700">Settings</h2>
            <div class="p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Currency</h3>
                <div class="max-w-xs">
                    <label for="currency-select" class="block text-sm font-medium text-gray-700 mb-1">Select Currency</label>
                    <select id="currency-select" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <!-- Currency options will be populated here by JavaScript -->
                    </select>
                </div>
            </div>
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-lg sm:text-xl font-semibold text-gray-600 mb-3">Version History</h3>
                <div class="text-sm text-gray-600">
                    <p><span class="font-semibold">Version 1.3</span> (Latest)</p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Added clickable table headers for sorting data.</li>
                        <li>Added version history section.</li>
                    </ul>
                </div>
                 <div class="text-sm text-gray-600 mt-4">
                    <p><span class="font-semibold">Version 1.2</span></p>
                    <ul class="list-disc list-inside ml-4">
                        <li>Added "Enter" key navigation and autocomplete for faster data entry.</li>
                        <li>Made UI more mobile-friendly.</li>
                    </ul>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h4 class="text-lg font-bold text-gray-800 mb-4">Confirm Deletion</h4>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">
                    No, Cancel
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- JS PDF libraries for PDF generation (fixed order) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        // IMPORTANT: Replace with your actual Firebase project configuration
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getFirestore, doc, setDoc, onSnapshot, getDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration 
        const firebaseConfig = {
          apiKey: "AIzaSyAoWY28i0hP3DN2t8fw2A61rBDw2yoIwS0",
          authDomain: "my-web-app2-c8dd0.firebaseapp.com",
          projectId: "my-web-app2-c8dd0",
          storageBucket: "my-web-app2-c8dd0.appspot.com",
          messagingSenderId: "430499672591",
          appId: "1:430499672591:web:f11185605aece22dbee97a"
        };
        
        let db;
        // The single document to store all data.
        const mainDocId = 'restaurant-data';
        
        // --- Core Data Structures & Firestore Functions ---
        let masterIngredients = [];
        let menuItems = [];
        let dailySales = [];
        let dailyPurchases = [];
        let salary = [];
        let settings = { currency: '£' };
        let openMenuItems = new Set(); // Keep track of open menu items
        let sortState = {
            master: { key: 'name', order: 'asc' },
            sales: { key: 'date', order: 'desc' },
            purchases: { key: 'date', order: 'desc' },
            salary: { key: 'date', order: 'desc' }
        };
        
        // Initialize Firebase.
        try {
            const app = initializeApp(firebaseConfig);
            db = getFirestore(app);
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // Firestore data saving function
        async function saveDataToFirestore() {
            if (!db) return;
            const dataRef = doc(db, 'public', mainDocId);
            const data = {
                masterIngredients,
                menuItems,
                dailySales,
                dailyPurchases,
                salary,
                settings
            };
            try {
                await setDoc(dataRef, data, { merge: true });
            } catch (e) {
                console.error("Error writing document: ", e);
            }
        }
        
        // Use onSnapshot to get real-time updates for all data
        function setupFirestoreListeners() {
            if (!db) return;
            const dataRef = doc(db, 'public', mainDocId);

            onSnapshot(dataRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    masterIngredients = data.masterIngredients || [];
                    menuItems = data.menuItems || [];
                    dailySales = data.dailySales || [];
                    dailyPurchases = data.dailyPurchases || [];
                    salary = data.salary || [];
                    settings = data.settings || { currency: '£' };
                } else {
                    // Initialize with empty arrays if doc doesn't exist
                    masterIngredients = [];
                    menuItems = [];
                    dailySales = [];
                    dailyPurchases = [];
                    salary = [];
                    settings = { currency: '£' };
                }
                // Re-render everything with the latest data
                rerenderAllTabs();
                document.getElementById('currency-select').value = settings.currency;
            }, (error) => {
                console.error("Error listening to data:", error);
            });
        }
        
        // --- DOM Elements & Event Listeners ---
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginMessage = document.getElementById('login-message');
        const appContent = document.getElementById('app-content');
        
        const masterTab = document.getElementById('master-tab');
        const menuTab = document.getElementById('menu-tab');
        const salesTab = document.getElementById('sales-tab');
        const purchasesTab = document.getElementById('purchases-tab');
        const salaryTab = document.getElementById('salary-tab');
        const reportsTab = document.getElementById('reports-tab');
        const settingsTab = document.getElementById('settings-tab');

        const masterSection = document.getElementById('master-section');
        const menuSection = document.getElementById('menu-section');
        const salesSection = document.getElementById('sales-section');
        const purchasesSection = document.getElementById('purchases-section');
        const salarySection = document.getElementById('salary-section');
        const reportsSection = document.getElementById('reports-section');
        const settingsSection = document.getElementById('settings-section');
        
        const masterSearchInput = document.getElementById('master-search');
        const ingredientsTableBody = document.getElementById('ingredients-table-body');
        const addIngredientBtn = document.getElementById('add-ingredient-btn');
        const ingredientNameInput = document.getElementById('ingredient-name');
        const ingredientUnitInput = document.getElementById('ingredient-unit');
        const ingredientCostInput = document.getElementById('ingredient-cost');
        const masterMessage = document.getElementById('master-message');

        const menuSearchInput = document.getElementById('menu-search');
        const menuItemsContainer = document.getElementById('menu-items-container');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuItemNameInput = document.getElementById('menu-item-name');
        const itemTypeSelect = document.getElementById('item-type-select');
        const dineInPriceInput = document.getElementById('dine-in-price');
        const takeAwayPriceInput = document.getElementById('take-away-price');
        
        const salesSearchInput = document.getElementById('sales-search');
        const salesDateInput = document.getElementById('sales-date');
        const salesCashInput = document.getElementById('sales-cash');
        const salesCardInput = document.getElementById('sales-card');
        const salesUberInput = document.getElementById('sales-uber');
        const salesJustEatInput = document.getElementById('sales-justeat');
        const salesDeliverooInput = document.getElementById('sales-deliveroo');
        const salesWebsiteInput = document.getElementById('sales-website');
        const salesAdvanceInput = document.getElementById('sales-advance');
        const salesTooGoodToGoInput = document.getElementById('sales-toogoodtogo');
        const addSalesBtn = document.getElementById('add-sales-btn');
        const salesMessage = document.getElementById('sales-message');
        const salesHistoryBody = document.getElementById('sales-history-body');
        
        const purchasesSearchInput = document.getElementById('purchases-search');
        const purchaseDateInput = document.getElementById('purchase-date');
        const purchaseItemInput = document.getElementById('purchase-item');
        const purchaseCostInput = document.getElementById('purchase-cost');
        const purchasePaymentMethodInput = document.getElementById('purchase-payment-method');
        const purchasePaidByInput = document.getElementById('purchase-paid-by');
        const addPurchaseBtn = document.getElementById('add-purchase-btn');
        const purchaseMessage = document.getElementById('purchase-message');
        const purchasesHistoryBody = document.getElementById('purchases-history-body');
        
        const salarySearchInput = document.getElementById('salary-search');
        const salaryDateInput = document.getElementById('salary-date');
        const salaryEmployeeInput = document.getElementById('salary-employee');
        const salaryTypeInput = document.getElementById('salary-type');
        const salaryAmountInput = document.getElementById('salary-amount');
        const addSalaryBtn = document.getElementById('add-salary-btn');
        const salaryMessage = document.getElementById('salary-message');
        const salaryHistoryBody = document.getElementById('salary-history-body');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        let pendingDeleteIndex = -1;
        let pendingDeleteType = '';

        const downloadStartDateInput = document.getElementById('download-start-date');
        const downloadEndDateInput = document.getElementById('download-end-date');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        
        const downloadPurchaseStartDateInput = document.getElementById('download-purchase-start-date');
        const downloadPurchaseEndDateInput = document.getElementById('download-purchase-end-date');
        const downloadPurchasePdfBtn = document.getElementById('download-purchase-pdf-btn');
        const downloadPurchaseCsvBtn = document.getElementById('download-purchase-csv-btn');

        const downloadSalaryStartDateInput = document.getElementById('download-salary-start-date');
        const downloadSalaryEndDateInput = document.getElementById('download-salary-end-date');
        const downloadSalaryEmployeesSelect = document.getElementById('download-salary-employees');
        const downloadSalaryPdfBtn = document.getElementById('download-salary-pdf-btn');
        const downloadSalaryCsvBtn = document.getElementById('download-salary-csv-btn');

        const downloadIngredientsPdfBtn = document.getElementById('download-ingredients-pdf-btn');
        const downloadIngredientsCsvBtn = document.getElementById('download-ingredients-csv-btn');
        const uploadIngredientsFile = document.getElementById('upload-ingredients-file');
        const uploadIngredientsBtn = document.getElementById('upload-ingredients-btn');
        const currencySelect = document.getElementById('currency-select');

        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const generateReportBtn = document.getElementById('generate-report-btn');
        const reportOutput = document.getElementById('report-output');

        const mobileMenuButton = document.getElementById('mobile-menu-button');
        const mobileMenu = document.getElementById('mobile-menu');


        // Set today's date on the date pickers
        const today = new Date().toISOString().split('T')[0];
        salesDateInput.value = today;
        purchaseDateInput.value = today;
        salaryDateInput.value = today;
        downloadStartDateInput.value = today;
        downloadEndDateInput.value = today;
        downloadPurchaseStartDateInput.value = today;
        downloadPurchaseEndDateInput.value = today;
        downloadSalaryStartDateInput.value = today;
        downloadSalaryEndDateInput.value = today;
        reportStartDateInput.value = today;
        reportEndDateInput.value = today;


        // --- Password Logic ---
        const correctPassword = "Summer2025";
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === correctPassword) {
                loginContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                // Initiate the Firebase listener after successful login
                setupFirestoreListeners();
                switchTab(masterTab, masterSection);
            } else {
                loginMessage.classList.remove('hidden');
            }
        });


        // Function to switch tabs
        function switchTab(activeTab, activeSection) {
            const tabs = [masterTab, menuTab, salesTab, purchasesTab, salaryTab, reportsTab, settingsTab];
            const sections = [masterSection, menuSection, salesSection, purchasesSection, salarySection, reportsSection, settingsSection];
            tabs.forEach(tab => tab.classList.remove('border-indigo-500', 'text-indigo-600'));
            sections.forEach(section => section.classList.add('hidden'));
            activeTab.classList.add('border-indigo-500', 'text-indigo-600');
            activeSection.classList.remove('hidden');
        }

        // Tab click handlers
        const desktopTabs = [masterTab, menuTab, salesTab, purchasesTab, salaryTab, reportsTab, settingsTab];
        const sections = [masterSection, menuSection, salesSection, purchasesSection, salarySection, reportsSection, settingsSection];

        desktopTabs.forEach((tab, index) => {
            tab.addEventListener('click', () => switchTab(tab, sections[index]));
        });

        // Mobile Menu Logic
        mobileMenuButton.addEventListener('click', () => {
            mobileMenu.classList.toggle('hidden');
        });

        document.querySelectorAll('#mobile-menu a').forEach(link => {
            link.addEventListener('click', (e) => {
                e.preventDefault();
                const tabName = e.target.dataset.tab;
                const tabButton = document.getElementById(`${tabName}-tab`);
                const section = document.getElementById(`${tabName}-section`);
                switchTab(tabButton, section);
                mobileMenu.classList.add('hidden');
            });
        });

        // --- Master Ingredients Logic ---
        function renderIngredients() {
            let data = [...masterIngredients];
            const { key, order } = sortState.master;
            data.sort((a, b) => {
                if (a[key] < b[key]) return order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return order === 'asc' ? 1 : -1;
                return 0;
            });

            ingredientsTableBody.innerHTML = '';
            if (data.length === 0) {
                masterMessage.textContent = 'No ingredients found.';
                return;
            }
            masterMessage.textContent = '';
            data.forEach((ingredient, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${ingredient.name}</td>
                    <td class="py-3 px-4 text-gray-800">${ingredient.unit}</td>
                    <td class="py-3 px-4 text-gray-800">
                        ${settings.currency}<input type="number" value="${ingredient.cost.toFixed(2)}" class="w-24 p-1 border rounded text-right" data-index="${index}">
                    </td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-ingredient-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                ingredientsTableBody.appendChild(row);
            });
            attachIngredientEventListeners();
            updateSortIndicator('master');
        }

        masterSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredIngredients = masterIngredients.filter(ing => ing.name.toLowerCase().includes(query));
            renderIngredients(filteredIngredients);
        });

        function attachIngredientEventListeners() {
            // Delete button
            document.querySelectorAll('#ingredients-table-body .delete-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'master-ingredient';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the ingredient "${masterIngredients[index].name}"? This will affect any menu items that use it.`;
                });
            });

            // Editable cost input
            document.querySelectorAll('#ingredients-table-body input[type="number"]').forEach(input => {
                input.addEventListener('change', (e) => { // Use 'change' to save only when focus is lost
                    const index = e.target.dataset.index;
                    const newCost = parseFloat(e.target.value);
                    if (!isNaN(newCost) && newCost >= 0) {
                        masterIngredients[index].cost = newCost;
                        saveDataToFirestore();
                        renderMenuItems(); // Recalculate all COGS
                    }
                });
            });
        }
        
        addIngredientBtn.addEventListener('click', () => {
            const name = ingredientNameInput.value.trim();
            const unit = ingredientUnitInput.value.trim();
            const cost = parseFloat(ingredientCostInput.value);
            if (!name || !unit || isNaN(cost) || cost <= 0) {
                masterMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            masterIngredients.push({ name, unit, cost });
            saveDataToFirestore();
            ingredientNameInput.value = '';
            ingredientUnitInput.value = '';
            ingredientCostInput.value = '';
            masterMessage.textContent = 'Ingredient added successfully!';
        });

        // Master Ingredients Download
        downloadIngredientsPdfBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                showTemporaryMessage(downloadIngredientsPdfBtn, 'No ingredients to download.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Master Ingredients List", 14, 20);
            const tableColumn = ["Ingredient Name", "Unit", `Cost per Unit (${settings.currency})`];
            const tableRows = masterIngredients.map(ing => [ing.name, ing.unit, ing.cost.toFixed(2)]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save('Master_Ingredients.pdf');
        });

        downloadIngredientsCsvBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                showTemporaryMessage(downloadIngredientsCsvBtn, 'No ingredients to download.');
                return;
            }
            const headers = ["Ingredient Name", "Unit", "Cost per Unit"];
            const rows = masterIngredients.map(ing => [
                `"${ing.name.replace(/"/g, '""')}"`, // Handle quotes in names
                `"${ing.unit.replace(/"/g, '""')}"`,
                ing.cost
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Master_Ingredients.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Master Ingredients Upload
        uploadIngredientsBtn.addEventListener('click', () => {
            const file = uploadIngredientsFile.files[0];
            if (!file) {
                masterMessage.textContent = 'Please select a CSV file to upload.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split(/\r?\n/); // Handle different line endings
                const newIngredients = [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                if (headers[0] !== 'Ingredient Name' || headers[1] !== 'Unit' || headers[2] !== 'Cost per Unit') {
                    masterMessage.textContent = 'Error: Invalid CSV headers. Expected "Ingredient Name", "Unit", "Cost per Unit".';
                    return;
                }
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
                        const name = parts[0];
                        const unit = parts[1];
                        const cost = parseFloat(parts[2]);
                        if (name && unit && !isNaN(cost) && cost > 0) {
                            newIngredients.push({ name, unit, cost });
                        }
                    }
                }
                masterIngredients = newIngredients;
                saveDataToFirestore();
                renderIngredients();
                renderMenuItems();
                masterMessage.textContent = `Successfully uploaded ${newIngredients.length} ingredients!`;
            };
            reader.readAsText(file);
        });


        // --- Menu Items & Platters Logic ---
        function calculateCogs(ingredients) {
            let totalCogs = 0;
            if (!ingredients) return 0;
            ingredients.forEach(item => {
                let cost = 0;
                if (item.type === 'ingredient') {
                    const masterIng = masterIngredients.find(ing => ing.name === item.name);
                    cost = masterIng ? masterIng.cost * item.quantity : 0;
                } else { // It's a dish/platter etc.
                    const dish = menuItems.find(menuItem => menuItem.name === item.name);
                    cost = dish ? calculateCogs(dish.ingredients) * item.quantity : 0; // Recursive calculation
                }
                totalCogs += cost;
            });
            return totalCogs;
        }
        
        // Helper function to get the COGS star icon based on percentage
        function getCogsStar(percent) {
            let colorClass = 'text-gray-400';
            if (percent > 0 && percent <= 30) {
                colorClass = 'text-yellow-400';
            } else if (percent > 30 && percent <= 35) {
                colorClass = 'text-green-500';
            } else if (percent > 35 && percent <= 40) {
                colorClass = 'text-amber-500';
            } else if (percent > 40) {
                colorClass = 'text-red-500';
            }
            
            return `
                <div class="flex items-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} fill-current" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    <span class="text-xs font-semibold text-gray-600">${percent.toFixed(0)}%</span>
                </div>
            `;
        }

        function renderMenuItems(data = menuItems) {
            menuItemsContainer.innerHTML = '';
            if (data.length === 0) {
                menuItemsContainer.innerHTML = '<div class="text-center text-gray-600">No menu items found.</div>';
                return;
            }
            data.forEach((item, index) => {
                const cogs = calculateCogs(item.ingredients);
                const dineInVat = item.dineInPrice ? item.dineInPrice * 0.20 : 0;
                const takeAwayVat = item.takeAwayPrice ? item.takeAwayPrice * 0.20 : 0;
                
                const dineInCogsPercent = item.dineInPrice > 0 ? (cogs / item.dineInPrice) * 100 : 0;
                const takeAwayCogsPercent = item.takeAwayPrice > 0 ? (cogs / item.takeAwayPrice) * 100 : 0;
                
                const dineInCogsWithVat = cogs + dineInVat;
                const takeAwayCogsWithVat = cogs + takeAwayVat;

                const itemCard = document.createElement('div');
                itemCard.className = 'p-6 bg-white rounded-lg shadow-md border border-gray-200';
                itemCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4 cursor-pointer toggle-menu-item" data-index="${index}">
                        <h3 class="text-xl font-bold text-gray-800">${item.name} (${item.type.charAt(0).toUpperCase() + item.type.slice(1)})</h3>
                        <div class="flex items-center space-x-4">
                            <span class="text-lg font-semibold text-gray-600">COGS:</span>
                            <span class="text-2xl font-extrabold text-indigo-600">${settings.currency}${cogs.toFixed(2)}</span>
                            <button class="delete-item-btn text-red-500 hover:text-red-700" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-${index}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div id="item-details-${index}" class="space-y-4 hidden">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In Price</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${item.dineInPrice ? item.dineInPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${dineInVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In COGS%</span>
                                ${item.dineInPrice > 0 ? getCogsStar(dineInCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away Price</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${item.takeAwayPrice ? item.takeAwayPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${takeAwayVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away COGS%</span>
                                ${item.takeAwayPrice > 0 ? getCogsStar(takeAwayCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Dine-In COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${dineInCogsWithVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Take-Away COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">${settings.currency}${takeAwayCogsWithVat.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- Online Markup Calculator -->
                        <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 mt-4">
                            <div class="flex items-center justify-between cursor-pointer toggle-online-pricing" data-index="${index}">
                                <h4 class="text-md font-semibold text-gray-700">Online Platform Pricing</h4>
                                <svg class="h-5 w-5 text-gray-400 transform transition-transform duration-200" id="online-chevron-${index}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                    <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                                </svg>
                            </div>
                            <div id="online-pricing-details-${index}" class="hidden mt-4 grid grid-cols-2 gap-4 items-center">
                                <div class="flex items-center space-x-2">
                                    <label for="online-markup-${index}" class="text-sm font-medium text-gray-700">Markup:</label>
                                    <input type="number" id="online-markup-${index}" min="0" max="500" value="0" class="w-24 p-2 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-lg font-bold text-gray-600">%</span>
                                </div>
                                <div>
                                    <span class="block text-gray-500 text-sm">Online Selling Price:</span>
                                    <span class="block text-gray-800 font-bold text-lg" id="online-price-display-${index}">${settings.currency}${item.dineInPrice ? item.dineInPrice.toFixed(2) : '0.00'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Component</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Quantity</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Unit/Type</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Cost</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-table-body-${index}">
                                    ${(item.ingredients || []).map((ing, i) => `
                                        <tr class="border-b border-gray-200 last:border-b-0">
                                            <td class="py-2 px-3 text-gray-700">${ing.name}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.quantity}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.type}</td>
                                            <td class="py-2 px-3 text-gray-700">${settings.currency}${calculateComponentCost(ing).toFixed(2)}</td>
                                            <td class="py-2 px-3">
                                                <button class="remove-component-btn text-red-500 hover:text-red-700" data-item-index="${index}" data-component-index="${i}">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Add Component to Recipe</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <select class="component-select p-2 border border-gray-300 rounded-lg" data-item-index="${index}">
                                    <option value="">Select...</option>
                                    <optgroup label="Ingredients">
                                        ${masterIngredients.map(ing => `<option value="${ing.name}" data-type="ingredient">${ing.name}</option>`).join('')}
                                    </optgroup>
                                    ${item.type === 'platter' ? `<optgroup label="Dishes">${menuItems.filter(m => m.type !== 'platter' && m.name !== item.name).map(d => `<option value="${d.name}" data-type="dish">${d.name}</option>`).join('')}</optgroup>` : ''}
                                </select>
                                <input type="number" placeholder="Quantity" class="component-quantity p-2 border border-gray-300 rounded-lg">
                                <button class="add-component-btn p-2 text-white font-bold rounded-lg bg-indigo-500 hover:bg-indigo-600 transition-colors" data-item-index="${index}">Add</button>
                            </div>
                        </div>
                    </div>
                `;
                menuItemsContainer.appendChild(itemCard);
            });
            
            // Restore open states
            openMenuItems.forEach(index => {
                const details = document.getElementById(`item-details-${index}`);
                const chevron = document.getElementById(`chevron-${index}`);
                if (details && chevron) {
                    details.classList.remove('hidden');
                    chevron.classList.add('rotate-180');
                }
            });

            attachMenuEventListeners();
        }

        menuSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredMenu = menuItems.filter(item => item.name.toLowerCase().includes(query));
            renderMenuItems(filteredMenu);
        });

        function calculateComponentCost(component) {
            if (component.type === 'ingredient') {
                const ing = masterIngredients.find(i => i.name === component.name);
                return ing ? ing.cost * component.quantity : 0;
            } else { // It's a dish/platter etc.
                const dish = menuItems.find(i => i.name === component.name);
                return dish ? calculateCogs(dish.ingredients) * component.quantity : 0;
            }
        }

        addMenuItemBtn.addEventListener('click', () => {
            const name = menuItemNameInput.value.trim();
            const type = itemTypeSelect.value;
            const dineInPrice = parseFloat(dineInPriceInput.value) || 0;
            const takeAwayPrice = parseFloat(takeAwayPriceInput.value) || 0;
            if (!name) { return; }
            menuItems.push({ name, type, ingredients: [], dineInPrice, takeAwayPrice });
            saveDataToFirestore();
            menuItemNameInput.value = '';
            dineInPriceInput.value = '';
            takeAwayPriceInput.value = '';
        });

        function attachMenuEventListeners() {
            document.querySelectorAll('.add-component-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    const itemIndex = btn.dataset.itemIndex;
                    const item = menuItems[itemIndex];
                    if (!item.ingredients) {
                        item.ingredients = [];
                    }
                    const card = btn.closest('.p-6');
                    const select = card.querySelector('.component-select');
                    const quantity = parseFloat(card.querySelector('.component-quantity').value);
                    const selectedOption = select.options[select.selectedIndex];
                    const name = selectedOption.value;
                    const type = selectedOption.dataset.type;

                    if (!name || isNaN(quantity) || quantity <= 0) { return; }
                    
                    item.ingredients.push({ name, quantity, type });
                    saveDataToFirestore();
                    
                    card.querySelector('.component-select').value = '';
                    card.querySelector('.component-quantity').value = '';
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.currentTarget.dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'menu-item';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the menu item "${menuItems[index].name}"?`;
                });
            });
            
            document.querySelectorAll('.remove-component-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const itemIndex = e.currentTarget.dataset.itemIndex;
                    const componentIndex = e.currentTarget.dataset.componentIndex;
                    menuItems[itemIndex].ingredients.splice(componentIndex, 1);
                    saveDataToFirestore();
                });
            });
            
            document.querySelectorAll('[id^="online-markup-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = e.target.id.split('-')[2];
                    const markup = parseFloat(e.target.value) || 0;
                    const dineInPrice = menuItems[index].dineInPrice;
                    const onlinePrice = dineInPrice + (dineInPrice * (markup / 100));
                    document.getElementById(`online-price-display-${index}`).textContent = `${settings.currency}${onlinePrice.toFixed(2)}`;
                });
            });

            // Toggle collapsible sections
            document.querySelectorAll('.toggle-menu-item').forEach(header => {
                header.addEventListener('click', (e) => {
                    if (e.target.closest('.delete-item-btn')) {
                        return;
                    }
                    const index = header.dataset.index;
                    const details = document.getElementById(`item-details-${index}`);
                    const chevron = document.getElementById(`chevron-${index}`);
                    
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');

                    if (details.classList.contains('hidden')) {
                        openMenuItems.delete(index);
                    } else {
                        openMenuItems.add(index);
                    }
                });
            });

            document.querySelectorAll('.toggle-online-pricing').forEach(header => {
                header.addEventListener('click', (e) => {
                    const index = header.dataset.index;
                    const details = document.getElementById(`online-pricing-details-${index}`);
                    const chevron = document.getElementById(`online-chevron-${index}`);
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                });
            });
        }
        
        // --- Daily Sales Logic ---
        function renderDailySales() {
            let data = [...dailySales];
            const { key, order } = sortState.sales;

            data.sort((a, b) => {
                let valA, valB;
                if (key === 'total') {
                    valA = (a.cash || 0) + (a.card || 0) + (a.uber || 0) + (a.justeat || 0) + (a.deliveroo || 0) + (a.website || 0) + (a.advance || 0) + (a.toogoodtogo || 0);
                    valB = (b.cash || 0) + (b.card || 0) + (b.uber || 0) + (b.justeat || 0) + (b.deliveroo || 0) + (b.website || 0) + (b.advance || 0) + (b.toogoodtogo || 0);
                } else if (key === 'online') {
                    valA = (a.uber || 0) + (a.justeat || 0) + (a.deliveroo || 0) + (a.website || 0) + (a.toogoodtogo || 0);
                    valB = (b.uber || 0) + (b.justeat || 0) + (b.deliveroo || 0) + (b.website || 0) + (b.toogoodtogo || 0);
                } else {
                    valA = a[key] || 0;
                    valB = b[key] || 0;
                }
                if (valA < valB) return order === 'asc' ? -1 : 1;
                if (valA > valB) return order === 'asc' ? 1 : -1;
                return 0;
            });

            salesHistoryBody.innerHTML = '';
            if (data.length === 0) {
                salesHistoryBody.innerHTML = `<tr><td colspan="6" class="text-center text-gray-600 py-4">No sales recorded yet.</td></tr>`;
                return;
            }
            data.forEach((sale) => {
                const onlineTotal = (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.toogoodtogo || 0);
                const total = (sale.cash || 0) + (sale.card || 0) + onlineTotal + (sale.advance || 0);
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${sale.date}</td>
                    <td class="py-3 px-4">${settings.currency}${(sale.cash || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${settings.currency}${(sale.card || 0).toFixed(2)}</td>
                    <td class="py-3 px-4">${settings.currency}${onlineTotal.toFixed(2)}</td>
                    <td class="py-3 px-4 font-bold">${settings.currency}${total.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-date="${sale.date}" class="delete-sales-record-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salesHistoryBody.appendChild(row);
            });
            attachSalesEventListeners();
            updateSortIndicator('sales');
        }

        salesSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredSales = dailySales.filter(sale => sale.date.includes(query));
            renderDailySales(filteredSales);
        });

        function attachSalesEventListeners() {
            document.querySelectorAll('.delete-sales-record-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const date = e.currentTarget.dataset.date;
                    const index = dailySales.findIndex(s => s.date === date);
                    if (index > -1) {
                        pendingDeleteIndex = index;
                        pendingDeleteType = 'sales';
                        confirmModal.classList.remove('hidden');
                        confirmMessage.textContent = `Are you sure you want to delete the sales record for ${dailySales[index].date}?`;
                    }
                });
            });
        }

        addSalesBtn.addEventListener('click', () => {
            const date = salesDateInput.value;
            const cash = parseFloat(salesCashInput.value) || 0;
            const card = parseFloat(salesCardInput.value) || 0;
            const uber = parseFloat(salesUberInput.value) || 0;
            const justeat = parseFloat(salesJustEatInput.value) || 0;
            const deliveroo = parseFloat(salesDeliverooInput.value) || 0;
            const website = parseFloat(salesWebsiteInput.value) || 0;
            const advance = parseFloat(salesAdvanceInput.value) || 0;
            const toogoodtogo = parseFloat(salesTooGoodToGoInput.value) || 0;

            if (!date) { 
                salesMessage.textContent = 'Please select a date.'; 
                return; 
            }
            
            const totalSales = cash + card + uber + justeat + deliveroo + website + advance + toogoodtogo;
            if (totalSales === 0) {
                salesMessage.textContent = 'Please enter a value for at least one sales category.';
                return;
            }

            // Check if a record for this date already exists
            const existingSaleIndex = dailySales.findIndex(sale => sale.date === date);
            if (existingSaleIndex > -1) {
                // Update existing record
                dailySales[existingSaleIndex] = { date, cash, card, uber, justeat, deliveroo, website, advance, toogoodtogo };
                salesMessage.textContent = 'Sales record updated successfully!';
            } else {
                // Add new record
                dailySales.push({ date, cash, card, uber, justeat, deliveroo, website, advance, toogoodtogo });
                salesMessage.textContent = 'Sales recorded successfully!';
            }
            
            saveDataToFirestore();
            
            // Clear input fields
            salesCashInput.value = '';
            salesCardInput.value = '';
            salesUberInput.value = '';
            salesJustEatInput.value = '';
            salesDeliverooInput.value = '';
            salesWebsiteInput.value = '';
            salesAdvanceInput.value = '';
            salesTooGoodToGoInput.value = '';
            salesDateInput.value = new Date().toISOString().split('T')[0];
        });

        // --- Purchases Logic ---
        function renderPurchases() {
            let data = [...dailyPurchases];
            const { key, order } = sortState.purchases;
            data.sort((a, b) => {
                if (a[key] < b[key]) return order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return order === 'asc' ? 1 : -1;
                return 0;
            });

            purchasesHistoryBody.innerHTML = '';
            if (data.length === 0) {
                purchasesHistoryBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-600 py-4">No purchases recorded yet.</td></tr>';
                return;
            }
            data.forEach((purchase, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${purchase.date}</td>
                    <td class="py-3 px-4">${purchase.item}</td>
                    <td class="py-3 px-4">${settings.currency}${purchase.cost.toFixed(2)}</td>
                    <td class="py-3 px-4">${purchase.paymentMethod || ''}</td>
                    <td class="py-3 px-4">${purchase.paidBy || ''}</td>
                    <td class="py-3 px-4">
                        <button data-id="${purchase.id}" class="delete-purchase-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                purchasesHistoryBody.appendChild(row);
            });
            attachPurchasesEventListeners();
            updateSortIndicator('purchases');
        }

        purchasesSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredPurchases = dailyPurchases.filter(purchase => purchase.item.toLowerCase().includes(query));
            renderPurchases(filteredPurchases);
        });
        
        function attachPurchasesEventListeners() {
            document.querySelectorAll('.delete-purchase-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const index = dailyPurchases.findIndex(p => p.id === id);
                    if (index > -1) {
                        pendingDeleteIndex = index;
                        pendingDeleteType = 'purchases';
                        confirmModal.classList.remove('hidden');
                        confirmMessage.textContent = `Are you sure you want to delete the purchase record for "${dailyPurchases[index].item}" on ${dailyPurchases[index].date}?`;
                    }
                });
            });
        }
        
        addPurchaseBtn.addEventListener('click', () => {
            const date = purchaseDateInput.value;
            const item = purchaseItemInput.value.trim();
            const cost = parseFloat(purchaseCostInput.value);
            const paymentMethod = purchasePaymentMethodInput.value;
            const paidBy = purchasePaidByInput.value.trim();
            if (!date || !item || isNaN(cost) || cost <= 0) {
                purchaseMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            const id = `purchase_${Date.now()}`; // Unique ID for each purchase
            dailyPurchases.push({ id, date, item, cost, paymentMethod, paidBy });
            saveDataToFirestore();
            purchaseDateInput.value = today;
            purchaseItemInput.value = '';
            purchaseCostInput.value = '';
            purchasePaymentMethodInput.value = '';
            purchasePaidByInput.value = '';
            purchaseMessage.textContent = 'Purchase recorded successfully!';
        });
        
        // --- Salary Logic ---
        function renderSalary() {
            let data = [...salary];
            const { key, order } = sortState.salary;
            data.sort((a, b) => {
                if (a[key] < b[key]) return order === 'asc' ? -1 : 1;
                if (a[key] > b[key]) return order === 'asc' ? 1 : -1;
                return 0;
            });

            salaryHistoryBody.innerHTML = '';
            if (data.length === 0) {
                salaryHistoryBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-600 py-4">No salary payments recorded yet.</td></tr>';
                return;
            }
            data.forEach((payment, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${payment.date}</td>
                    <td class="py-3 px-4">${payment.employee}</td>
                    <td class="py-3 px-4">${payment.type}</td>
                    <td class="py-3 px-4">${settings.currency}${payment.amount.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-id="${payment.id}" class="delete-salary-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salaryHistoryBody.appendChild(row);
            });
            attachSalaryEventListeners();
            populateEmployeeDropdown();
            updateSortIndicator('salary');
        }

        salarySearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredSalary = salary.filter(payment => payment.employee.toLowerCase().includes(query));
            renderSalary(filteredSalary);
        });
        
        function populateEmployeeDropdown() {
            const uniqueEmployees = [...new Set(salary.map(p => p.employee))].sort();
            downloadSalaryEmployeesSelect.innerHTML = `<option value="">All Employees</option>`;
            uniqueEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                downloadSalaryEmployeesSelect.appendChild(option);
            });
        }

        function attachSalaryEventListeners() {
            document.querySelectorAll('.delete-salary-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const id = e.currentTarget.dataset.id;
                    const index = salary.findIndex(p => p.id === id);
                    if (index > -1) {
                        pendingDeleteIndex = index;
                        pendingDeleteType = 'salary';
                        confirmModal.classList.remove('hidden');
                        confirmMessage.textContent = `Are you sure you want to delete the salary payment for "${salary[index].employee}" on ${salary[index].date}?`;
                    }
                });
            });
        }

        addSalaryBtn.addEventListener('click', () => {
            const date = salaryDateInput.value;
            const employee = salaryEmployeeInput.value.trim();
            const type = salaryTypeInput.value;
            const amount = parseFloat(salaryAmountInput.value);
            if (!date || !employee || !type || isNaN(amount) || amount <= 0) {
                salaryMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            const id = `salary_${Date.now()}`; // Unique ID
            salary.push({ id, date, employee, type, amount });
            saveDataToFirestore();
            salaryDateInput.value = today;
            salaryEmployeeInput.value = '';
            salaryTypeInput.value = '';
            salaryAmountInput.value = '';
            salaryMessage.textContent = 'Salary payment recorded successfully!';
        });

        // --- Global Data Management (Confirmation & Downloads) ---
        confirmDeleteBtn.addEventListener('click', async () => {
            if (pendingDeleteIndex !== -1) {
                if (pendingDeleteType === 'master-ingredient') {
                    masterIngredients.splice(pendingDeleteIndex, 1);
                } else if (pendingDeleteType === 'menu-item') {
                    menuItems.splice(pendingDeleteIndex, 1);
                } else if (pendingDeleteType === 'sales') {
                    dailySales.splice(pendingDeleteIndex, 1);
                } else if (pendingDeleteType === 'purchases') {
                    dailyPurchases.splice(pendingDeleteIndex, 1);
                } else if (pendingDeleteType === 'salary') {
                    salary.splice(pendingDeleteIndex, 1);
                }
                await saveDataToFirestore();
            }
            pendingDeleteIndex = -1;
            pendingDeleteType = '';
            confirmModal.classList.add('hidden');
        });

        cancelDeleteBtn.addEventListener('click', () => {
            pendingDeleteIndex = -1;
            pendingDeleteType = '';
            confirmModal.classList.add('hidden');
        });
        
        // --- Helper function for temporary messages ---
        function showTemporaryMessage(element, message, isError = true) {
            const messageDiv = document.createElement('div');
            messageDiv.className = `mt-2 text-sm font-medium ${isError ? 'text-red-500' : 'text-green-500'}`;
            messageDiv.textContent = message;
            // Insert after the button's container
            element.closest('div').insertAdjacentElement('afterend', messageDiv);
            setTimeout(() => messageDiv.remove(), 3000);
        }

        // --- Download Functions ---

        // Sales PDF Download
        downloadPdfBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadPdfBtn, 'Please select a start and end date.');
                return;
            }
            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);
            if (filteredSales.length === 0) {
                showTemporaryMessage(downloadPdfBtn, 'No sales data for the selected date range.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Daily Sales Report", 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", `Cash (${settings.currency})`, `Card (${settings.currency})`, `Online (${settings.currency})`, `Total (${settings.currency})`];
            const tableRows = filteredSales.map(sale => {
                const onlineTotal = (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.toogoodtogo || 0);
                const total = (sale.cash || 0) + (sale.card || 0) + onlineTotal + (sale.advance || 0);
                return [sale.date, (sale.cash || 0).toFixed(2), (sale.card || 0).toFixed(2), onlineTotal.toFixed(2), total.toFixed(2)];
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40
            });
            doc.save(`Sales_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Sales CSV Download
        downloadCsvBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadCsvBtn, 'Please select a start and end date.');
                return;
            }
            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);
            if (filteredSales.length === 0) {
                showTemporaryMessage(downloadCsvBtn, 'No sales data for the selected date range.');
                return;
            }
            const headers = ["Date", "Cash", "Card", "Uber Eats", "Just Eat", "Deliveroo", "Website", "Booking Advance", "Too Good To Go", "Total"];
            const rows = filteredSales.map(sale => {
                const total = (sale.cash || 0) + (sale.card || 0) + (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.advance || 0) + (sale.toogoodtogo || 0);
                return [
                    `"${sale.date}"`, sale.cash || 0, sale.card || 0, sale.uber || 0, sale.justeat || 0, sale.deliveroo || 0, sale.website || 0, sale.advance || 0, sale.toogoodtogo || 0, total
                ].join(",");
            });
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Sales_Report_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Purchases PDF Download
        downloadPurchasePdfBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadPurchasePdfBtn, 'Please select a start and end date.');
                return;
            }
            const filteredPurchases = dailyPurchases.filter(p => p.date >= startDate && p.date <= endDate);
            if (filteredPurchases.length === 0) {
                showTemporaryMessage(downloadPurchasePdfBtn, 'No purchase data for the selected date range.');
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Purchases Report", 14, 20);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", "Item/Service", `Total Cost (${settings.currency})`, "Payment Method", "Paid By"];
            const tableRows = filteredPurchases.map(p => [p.date, p.item, p.cost.toFixed(2), p.paymentMethod, p.paidBy]);
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 40 });
            doc.save(`Purchases_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Purchases CSV Download
        downloadPurchaseCsvBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadPurchaseCsvBtn, 'Please select a start and end date.');
                return;
            }
            const filteredPurchases = dailyPurchases.filter(p => p.date >= startDate && p.date <= endDate);
            if (filteredPurchases.length === 0) {
                showTemporaryMessage(downloadPurchaseCsvBtn, 'No purchase data for the selected date range.');
                return;
            }
            const headers = ["Date", "Item/Service", "Total Cost", "Payment Method", "Paid By"];
            const rows = filteredPurchases.map(p => [`"${p.date}"`, `"${p.item.replace(/"/g, '""')}"`, p.cost, `"${p.paymentMethod}"`, `"${p.paidBy}"`].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Purchases_Report_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Salary PDF Download
        downloadSalaryPdfBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadSalaryPdfBtn, 'Please select a start and end date.');
                return;
            }

            let filteredSalary = salary.filter(p => p.date >= startDate && p.date <= endDate);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(p => selectedEmployees.includes(p.employee));
            }

            if (filteredSalary.length === 0) {
                showTemporaryMessage(downloadSalaryPdfBtn, 'No salary data for the selected criteria.');
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.text("Salary Report", 14, 20);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                doc.text(`Employees: ${selectedEmployees.join(', ')}`, 14, 37);
            }

            const tableColumn = ["Date", "Employee Name", "Payment Type", `Amount (${settings.currency})`];
            const tableRows = filteredSalary.map(p => [p.date, p.employee, p.type, p.amount.toFixed(2)]);
            doc.autoTable({ head: [tableColumn], body: tableRows, startY: 45 });
            doc.save(`Salary_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Salary CSV Download
        downloadSalaryCsvBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                showTemporaryMessage(downloadSalaryCsvBtn, 'Please select a start and end date.');
                return;
            }

            let filteredSalary = salary.filter(p => p.date >= startDate && p.date <= endDate);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(p => selectedEmployees.includes(p.employee));
            }
            
            if (filteredSalary.length === 0) {
                showTemporaryMessage(downloadSalaryCsvBtn, 'No salary data for the selected criteria.');
                return;
            }

            const headers = ["Date", "Employee Name", "Payment Type", "Amount"];
            const rows = filteredSalary.map(p => [`"${p.date}"`, `"${p.employee.replace(/"/g, '""')}"`, `"${p.type}"`, p.amount].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Salary_Report_${startDate}_to_${endDate}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Collapsible Sections Logic ---
        document.getElementById('toggle-manage-ingredients').addEventListener('click', () => {
            document.getElementById('manage-ingredients-details').classList.toggle('hidden');
            document.getElementById('chevron-manage-ingredients').classList.toggle('rotate-180');
        });
        document.getElementById('toggle-download-sales').addEventListener('click', () => {
            document.getElementById('download-sales-details').classList.toggle('hidden');
            document.getElementById('chevron-download-sales').classList.toggle('rotate-180');
        });
        document.getElementById('toggle-download-purchases').addEventListener('click', () => {
            document.getElementById('download-purchases-details').classList.toggle('hidden');
            document.getElementById('chevron-download-purchases').classList.toggle('rotate-180');
        });
        document.getElementById('toggle-download-salary').addEventListener('click', () => {
            document.getElementById('download-salary-details').classList.toggle('hidden');
            document.getElementById('chevron-download-salary').classList.toggle('rotate-180');
        });

        // --- Settings Logic ---
        const currencies = {
            "EUR": "€",
            "GBP": "£",
            "PLN": "zł",
            "USD": "$",
            "BDT": "৳"
        };

        function populateCurrencyDropdown() {
            for (const code in currencies) {
                const option = document.createElement('option');
                option.value = currencies[code];
                option.textContent = `${code} (${currencies[code]})`;
                currencySelect.appendChild(option);
            }
        }
        populateCurrencyDropdown();

        currencySelect.addEventListener('change', (e) => {
            settings.currency = e.target.value;
            saveDataToFirestore();
            rerenderAllTabs();
        });

        function rerenderAllTabs() {
            renderIngredients();
            renderMenuItems();
            renderDailySales();
            renderPurchases();
            renderSalary();
            updatePlaceholdersAndHeaders();
            setupAllAutocomplete();
        }

        function updatePlaceholdersAndHeaders() {
            const currency = settings.currency;
            document.getElementById('ingredient-cost').placeholder = `Cost per Unit (${currency})`;
            document.getElementById('dine-in-price').placeholder = `Dine-In Price (${currency})`;
            document.getElementById('take-away-price').placeholder = `Take-Away Price (${currency})`;
            document.getElementById('sales-cash').placeholder = `Cash (${currency})`;
            document.getElementById('sales-card').placeholder = `Card (${currency})`;
            document.getElementById('sales-uber').placeholder = `Uber Eats (${currency})`;
            document.getElementById('sales-justeat').placeholder = `Just Eat (${currency})`;
            document.getElementById('sales-deliveroo').placeholder = `Deliveroo (${currency})`;
            document.getElementById('sales-website').placeholder = `Website (${currency})`;
            document.getElementById('sales-advance').placeholder = `Booking Advance (${currency})`;
            document.getElementById('sales-toogoodtogo').placeholder = `Too Good To Go (${currency})`;
            document.getElementById('purchase-cost').placeholder = `Total Cost (${currency})`;
            document.getElementById('salary-amount').placeholder = `Amount (${currency})`;
            
            document.querySelectorAll('.currency-header').forEach(header => {
                header.textContent = `${header.textContent.split('(')[0]} (${currency})`;
            });
        }

        // --- Reports Logic ---
        generateReportBtn.addEventListener('click', () => {
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;

            if (!startDate || !endDate) {
                reportOutput.innerHTML = `<p class="text-red-500">Please select a start and end date.</p>`;
                return;
            }

            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);
            const filteredPurchases = dailyPurchases.filter(p => p.date >= startDate && p.date <= endDate);
            const filteredSalary = salary.filter(s => s.date >= startDate && s.date <= endDate);

            const totalSales = filteredSales.reduce((acc, sale) => {
                return acc + (sale.cash || 0) + (sale.card || 0) + (sale.uber || 0) + (sale.justeat || 0) + (sale.deliveroo || 0) + (sale.website || 0) + (sale.advance || 0) + (sale.toogoodtogo || 0);
            }, 0);

            const totalPurchases = filteredPurchases.reduce((acc, p) => acc + p.cost, 0);
            const totalSalary = filteredSalary.reduce((acc, s) => acc + s.amount, 0);
            const totalExpenses = totalPurchases + totalSalary;
            const netProfit = totalSales - totalExpenses;

            reportOutput.innerHTML = `
                <div class="space-y-2">
                    <div class="flex justify-between items-center p-3 bg-green-100 rounded-lg">
                        <span class="font-semibold text-green-800">Total Sales:</span>
                        <span class="font-bold text-green-800">${settings.currency}${totalSales.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-red-100 rounded-lg">
                        <span class="font-semibold text-red-800">Total Expenses:</span>
                        <span class="font-bold text-red-800">${settings.currency}${totalExpenses.toFixed(2)}</span>
                    </div>
                    <div class="flex justify-between items-center p-3 bg-blue-100 rounded-lg">
                        <span class="font-semibold text-blue-800">Net Profit:</span>
                        <span class="font-bold text-blue-800">${settings.currency}${netProfit.toFixed(2)}</span>
                    </div>
                </div>
            `;
        });

        // --- Enter Key Navigation & Autocomplete Logic ---
        function setupEnterKeyNavigation(formElements, submitButton) {
            formElements.forEach((element, index) => {
                element.addEventListener('keydown', (e) => {
                    if (e.key === 'Enter') {
                        e.preventDefault();
                        const nextElement = formElements[index + 1];
                        if (nextElement) {
                            nextElement.focus();
                        } else {
                            submitButton.click();
                        }
                    }
                });
            });
        }

        function setupAutocomplete(inputElement, data) {
            let currentFocus;
            inputElement.addEventListener("input", function(e) {
                let a, b, i, val = this.value;
                closeAllLists();
                if (!val) { return false;}
                currentFocus = -1;
                a = document.createElement("DIV");
                a.setAttribute("id", this.id + "autocomplete-list");
                a.setAttribute("class", "autocomplete-suggestions");
                this.parentNode.appendChild(a);
                for (i = 0; i < data.length; i++) {
                    if (data[i].substr(0, val.length).toUpperCase() == val.toUpperCase()) {
                        b = document.createElement("DIV");
                        b.setAttribute("class", "autocomplete-suggestion");
                        b.innerHTML = "<strong>" + data[i].substr(0, val.length) + "</strong>";
                        b.innerHTML += data[i].substr(val.length);
                        b.innerHTML += "<input type='hidden' value='" + data[i] + "'>";
                        b.addEventListener("click", function(e) {
                            inputElement.value = this.getElementsByTagName("input")[0].value;
                            closeAllLists();
                        });
                        a.appendChild(b);
                    }
                }
            });
            function closeAllLists(elmnt) {
                var x = document.getElementsByClassName("autocomplete-suggestions");
                for (var i = 0; i < x.length; i++) {
                    if (elmnt != x[i] && elmnt != inputElement) {
                    x[i].parentNode.removeChild(x[i]);
                    }
                }
            }
            document.addEventListener("click", function (e) {
                closeAllLists(e.target);
            });
        }

        function setupAllAutocomplete() {
            const purchaseItems = [...new Set(dailyPurchases.map(p => p.item))];
            const paidByNames = [...new Set(dailyPurchases.map(p => p.paidBy).filter(Boolean))];
            const employeeNames = [...new Set(salary.map(s => s.employee))];
            
            setupAutocomplete(purchaseItemInput, purchaseItems);
            setupAutocomplete(purchasePaidByInput, paidByNames);
            setupAutocomplete(salaryEmployeeInput, employeeNames);
        }

        setupEnterKeyNavigation([ingredientNameInput, ingredientUnitInput, ingredientCostInput], addIngredientBtn);
        setupEnterKeyNavigation([menuItemNameInput, itemTypeSelect, dineInPriceInput, takeAwayPriceInput], addMenuItemBtn);
        setupEnterKeyNavigation([salesDateInput, salesCashInput, salesCardInput, salesUberInput, salesJustEatInput, salesDeliverooInput, salesWebsiteInput, salesAdvanceInput, salesTooGoodToGoInput], addSalesBtn);
        setupEnterKeyNavigation([purchaseDateInput, purchaseItemInput, purchaseCostInput, purchasePaymentMethodInput, purchasePaidByInput], addPurchaseBtn);
        setupEnterKeyNavigation([salaryDateInput, salaryEmployeeInput, salaryTypeInput, salaryAmountInput], addSalaryBtn);

        // --- Sorting Logic ---
        function handleSort(table, key) {
            if (sortState[table].key === key) {
                sortState[table].order = sortState[table].order === 'asc' ? 'desc' : 'asc';
            } else {
                sortState[table].key = key;
                sortState[table].order = 'asc';
            }
            rerenderAllTabs();
        }

        function updateSortIndicator(table) {
            document.querySelectorAll(`#${table}-section .sortable`).forEach(header => {
                const key = header.dataset.sort;
                const arrow = header.querySelector('.sort-arrow');
                header.classList.remove('sorted');
                if(arrow) arrow.innerHTML = '';

                if (sortState[table].key === key) {
                    header.classList.add('sorted');
                    if(arrow) arrow.innerHTML = sortState[table].order === 'asc' ? '▲' : '▼';
                }
            });
        }

        appContent.addEventListener('click', (e) => {
            const header = e.target.closest('.sortable');
            if (header) {
                const table = header.closest('div[id$="-section"]').id.split('-')[0];
                const key = header.dataset.sort;
                handleSort(table, key);
            }
        });

    </script>
</body>
</html>
