<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Manager</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <!-- Chart.js CDN for charts -->
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1100px;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .logo-placeholder {
            width: 80px;
            height: 80px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            background-color: #e5e7eb;
            color: #9ca3af;
            font-size: 1.5rem;
            font-weight: bold;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Authentication Section (visible on load) -->
    <div id="auth-section" class="bg-white p-8 rounded-2xl shadow-xl max-w-sm w-full">
        <h2 class="text-3xl font-bold text-center text-gray-800 mb-6">Welcome Back</h2>
        <div class="mb-4">
            <label for="auth-email" class="block text-sm font-medium text-gray-700">Email</label>
            <input type="email" id="auth-email" placeholder="email@example.com" class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="mb-2">
            <label for="auth-password" class="block text-sm font-medium text-gray-700">Password</label>
            <input type="password" id="auth-password" placeholder="Password" class="mt-1 p-3 w-full border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
        </div>
        <div class="flex justify-end mb-6">
            <button id="forgot-password-btn" class="text-sm font-medium text-indigo-600 hover:text-indigo-800 transition-colors duration-200">
                Forgot Password?
            </button>
        </div>
        <div class="space-y-4">
            <button id="auth-signin-btn" class="w-full p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200">
                Sign In
            </button>
            <button id="auth-signup-btn" class="w-full p-3 text-indigo-600 font-bold rounded-lg border border-indigo-600 hover:bg-indigo-50 transition-colors duration-200">
                Create Account
            </button>
            <div class="flex items-center my-4">
                <div class="flex-grow border-t border-gray-300"></div>
                <span class="flex-shrink mx-4 text-gray-400">OR</span>
                <div class="flex-grow border-t border-gray-300"></div>
            </div>
            <button id="auth-google-btn" class="w-full p-3 text-gray-800 font-bold rounded-lg bg-white border border-gray-300 hover:bg-gray-100 transition-colors duration-200 flex items-center justify-center space-x-2">
                <svg class="h-5 w-5" viewBox="0 0 48 48" fill="none" xmlns="http://www.w3.org/2000/svg">
                    <path fill="#FFC107" d="M43.611 20.083H42V20H24v8h11.303c-1.619 4.357-6.527 6.32-10.703 6.32-6.101 0-11.104-5.021-11.104-11.233 0-6.213 5.003-11.234 11.104-11.234 3.359 0 6.042 1.139 8.325 3.322l7.57-7.573c-4.646-4.511-10.934-7.247-18.195-7.247-13.375 0-24.168 10.875-24.168 24.25S10.375 48 23.75 48c12.75 0 22.952-11.17 22.952-24.25 0-1.554-.188-3.111-.462-4.629z"/>
                    <path fill="#FF3D00" d="M6.321 14.853l7.575 7.643c.87-2.584 2.895-5.006 5.86-7.583H6.321z"/>
                    <path fill="#4CAF50" d="M23.75 44c-5.166 0-9.945-2.29-13.24-6.002l-7.581 7.58c3.463 4.295 8.358 6.582 13.521 6.582 8.783 0 16.033-6.299 18.714-14.718l-7.572-7.571c-2.355 5.753-8.835 10.11-12.835 10.11z"/>
                    <path fill="#1976D2" d="M43.611 20.083H42V20h-18v8h11.303a12.16 12.16 0 01-2.923 5.795l7.579 7.576A23.518 23.518 0 0023.75 4c-4.845 0-9.351 1.83-12.735 4.972l7.576 7.576c2.449-1.849 5.378-2.926 8.163-2.926 2.062 0 4.041.678 5.642 2.05z"/>
                </svg>
                <span>Sign in with Google</span>
            </button>
        </div>
        <p id="auth-message" class="mt-4 text-center text-sm font-medium text-red-500"></p>
    </div>

    <!-- Main App Content (hidden on load) -->
    <div id="app-container" class="container bg-white rounded-xl shadow-2xl p-8 w-full hidden">
        <!-- Header with Sign Out button -->
        <div class="flex items-center justify-between mb-8">
            <div class="text-left">
                <h1 id="app-title" class="text-4xl font-extrabold text-gray-800">Restaurant Manager</h1>
                <p class="mt-2 text-lg text-gray-500">Your all-in-one tool for costing, sales, and purchases.</p>
            </div>
            <div class="flex flex-col items-end">
                <button id="main-logout-btn" class="p-2 text-white bg-red-500 hover:bg-red-600 rounded-lg shadow transition-colors duration-200">
                    Sign Out
                </button>
                <div id="user-info" class="text-xs font-mono text-gray-500 mt-2">
                    User ID: <span id="user-id"></span>
                </div>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap border-b border-gray-200 mb-6">
            <button id="master-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Master Ingredients
            </button>
            <button id="menu-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Menu Costing
            </button>
            <button id="sales-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Daily Sales
            </button>
            <button id="purchases-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Purchases
            </button>
            <button id="salary-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Salary
            </button>
            <button id="documents-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Documents
            </button>
            <button id="reports-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Reports
            </button>
        </div>

        <!-- Content Sections -->

        <!-- Master Ingredients Section -->
        <div id="master-section" class="p-6 bg-gray-50 rounded-lg transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Master Ingredients</h2>
            
            <!-- Add New Ingredient Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Add a New Ingredient</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="ingredient-name" placeholder="Ingredient Name" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="ingredient-unit" placeholder="Unit (e.g., kg, gram)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="ingredient-cost" placeholder="Cost per Unit (£)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-ingredient-btn" class="col-span-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Ingredient
                    </button>
                </div>
            </div>

            <!-- Ingredients Table -->
            <div class="overflow-x-auto">
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Ingredient</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Unit</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Cost per Unit</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ingredients-table-body">
                        <!-- Ingredient rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Message container -->
            <div id="master-message" class="mt-4 p-3 text-center text-sm font-medium text-gray-600 rounded-lg"></div>

            <!-- Import/Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Manage Ingredient Data</h3>
                
                <!-- Download Records Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download All Ingredients</h4>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="download-ingredients-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-ingredients-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>

                <!-- Upload Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Upload Ingredients (CSV)</h4>
                    <p class="text-sm text-gray-500 mb-2">CSV file should have headers: "Ingredient Name", "Unit", "Cost per Unit"</p>
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <input type="file" id="upload-ingredients-file" accept=".csv" class="flex-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <button id="upload-ingredients-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Upload & Replace
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Items & Platters Section -->
        <div id="menu-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Menu Costing</h2>

            <!-- Add New Menu Item Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Add New Dish or Platter</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="menu-item-name" placeholder="Name" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="item-type-select" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="dish">Dish</option>
                        <option value="platter">Platter</option>
                        <option value="starter">Starter</option>
                        <option value="sides">Sides</option>
                        <option value="salads">Salads</option>
                        <option value="dessert">Dessert</option>
                        <option value="drinks">Drinks</option>
                        <option value="wraps">Wraps</option>
                    </select>
                    <input type="number" id="dine-in-price" placeholder="Dine-In Price (£)" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="take-away-price" placeholder="Take-Away Price (£)" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-menu-item-btn" class="col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Item
                    </button>
                </div>
            </div>

            <!-- Menu Items List -->
            <div id="menu-items-container" class="space-y-6">
                <!-- Menu item cards will be dynamically inserted here -->
            </div>
        </div>
        
        <!-- Daily Sales Section -->
        <div id="sales-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Daily Sales & Bookings</h2>
            
            <!-- Record Sales Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Record Today's Sales</h3>
                <div class="grid md:grid-cols-3 gap-4 items-end">
                    <input type="date" id="sales-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-cash" placeholder="Cash (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-card" placeholder="Card (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-uber" placeholder="Uber Eats (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-justeat" placeholder="Just Eat (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-deliveroo" placeholder="Deliveroo (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-website" placeholder="Website (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-advance" placeholder="Booking Advance (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-toogoodtogo" placeholder="Too Good To Go (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-sales-btn" class="col-span-3 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Sales
                    </button>
                </div>
                <div id="sales-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>
            
            <!-- Daily Sales Summary Table -->
            <div class="overflow-x-auto">
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Sales History</h3>
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Date</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Cash (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Card (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Online (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Total (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sales-history-body">
                        <!-- Sales history will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Download Sales Data</h3>
                
                <!-- Download Records Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Sales History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchases Section -->
        <div id="purchases-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Purchases & Expenses</h2>

            <!-- Record Purchase Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Record a Purchase</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="date" id="purchase-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="purchase-item" placeholder="Item/Service Name" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="purchase-cost" placeholder="Total Cost (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-purchase-btn" class="p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Purchase
                    </button>
                </div>
                <div id="purchase-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <!-- Purchases History Table -->
            <div class="overflow-x-auto">
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Purchases History</h3>
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Date</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Item/Service</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Total Cost (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="purchases-history-body">
                        <!-- Purchases history will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Download Purchases Data</h3>
                
                <!-- Download Records Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Purchases History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-purchase-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-purchase-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-purchase-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-purchase-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-purchase-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-purchase-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Salary Section -->
        <div id="salary-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Salary</h2>

            <!-- Record Salary Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Record Salary Payment</h3>
                <div class="grid md:grid-cols-5 gap-4 items-end">
                    <input type="date" id="salary-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="salary-employee" placeholder="Employee Name" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="salary-hours" placeholder="Hours" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="salary-rate" placeholder="Hourly Rate (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="salary-type" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="">Select Payment Type</option>
                        <option value="Daily Salary">Daily Salary</option>
                        <option value="Weekly Salary">Weekly Salary</option>
                        <option value="Monthly Salary">Monthly Salary</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Overtime">Overtime</option>
                    </select>
                    <button id="add-salary-btn" class="col-span-5 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Payment
                    </button>
                </div>
                <div id="salary-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <!-- Salary History Table -->
            <div class="overflow-x-auto">
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Salary History</h3>
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Date</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Employee Name</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Payment Type</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Hours</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Hourly Rate (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Amount (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salary-history-body">
                        <!-- Salary history will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Download Salary Data</h3>
                
                <!-- Download Records Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Salary History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end mb-4">
                        <div>
                            <label for="download-salary-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-salary-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-salary-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-salary-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="download-salary-employees" class="block text-sm font-medium text-gray-700 mb-1">Select Employees</label>
                        <select id="download-salary-employees" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-salary-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-salary-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Documents Section (New) -->
        <div id="documents-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Documents</h2>
            
            <!-- Upload Document Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Upload a Document</h3>
                <div class="flex flex-col sm:flex-row gap-4 items-center">
                    <input type="file" id="document-file" class="flex-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                    <button id="upload-document-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Upload Document
                    </button>
                </div>
                <div id="document-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <!-- Documents List Table -->
            <div class="overflow-x-auto">
                <h3 class="text-xl font-semibold mb-2 text-gray-700">Uploaded Documents</h3>
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Document Name</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Type</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Size</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="documents-table-body">
                        <!-- Document rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
        </div>

        <!-- Reports Section (New) -->
        <div id="reports-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Reports & Analytics</h2>
            
            <!-- Sales Trends Chart -->
            <div class="mb-8 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold mb-4 text-gray-600">Daily Sales Trends</h3>
                
                <div class="grid grid-cols-1 md:grid-cols-4 gap-4 mb-4 items-end">
                    <div class="md:col-span-1">
                        <label for="report-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                        <input type="date" id="report-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="report-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                        <input type="date" id="report-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="md:col-span-1">
                        <label for="sales-target-input" class="block text-sm font-medium text-gray-700 mb-1">Daily Sales Target (£)</label>
                        <input type="number" id="sales-target-input" placeholder="e.g. 500" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                    </div>
                    <div class="flex gap-4 md:col-span-1">
                        <button id="filter-sales-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Apply Filter
                        </button>
                        <button id="download-sales-report-pdf" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download PDF
                        </button>
                    </div>
                </div>
                
                <canvas id="salesChart"></canvas>
            </div>

            <!-- Profitability Report -->
            <div class="p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold mb-4 text-gray-600">Menu Item Profitability</h3>
                <div class="overflow-x-auto">
                    <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                        <thead class="bg-gray-100 border-b border-gray-200">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Menu Item</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">COGS (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Dine-In Price (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Profit (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Profit Margin (%)</th>
                        </tr>
                        </thead>
                        <tbody id="profit-report-body">
                        <!-- Profit report rows will be dynamically inserted here -->
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h4 class="text-lg font-bold text-gray-800 mb-4">Confirm Deletion</h4>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">
                    No, Cancel
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- JS PDF libraries for PDF generation (fixed order) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDK Imports -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, onAuthStateChanged, createUserWithEmailAndPassword, signInWithEmailAndPassword, signOut, sendPasswordResetEmail, GoogleAuthProvider, signInWithPopup } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, collection, doc, onSnapshot, setDoc, addDoc, updateDoc, deleteDoc, query, where } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // --- Firebase Configuration & Initialization ---
        // Your Firebase configuration object.
        const firebaseConfig = {
            apiKey: "AIzaSyAbg7QkC0I9saYVTgnlOSiWgJOoGlBIJ4k",
            authDomain: "my-web-app-4da9b.firebaseapp.com",
            projectId: "my-web-app-4da9b",
            storageBucket: "my-web-app-4da9b.firebasestorage.app",
            messagingSenderId: "981498815324",
            appId: "1:981498815324:web:2a4dec6a183768efffd799"
        };
        
        // Initialize Firebase
        const app = initializeApp(firebaseConfig);
        const db = getFirestore(app);
        const auth = getAuth(app);
        const appId = typeof __app_id !== 'undefined' ? __app_id : 'default-app-id';

        // Global variables for data
        let masterIngredients = [];
        let menuItems = [];
        let dailySales = [];
        let dailyPurchases = [];
        let salary = [];
        let documents = [];

        let userId = null;
        let isAuthReady = false;

        // Document ID for single-document data storage
        const DOC_ID = 'restaurant-data';

        // --- DOM Elements & Event Listeners ---
        const authSection = document.getElementById('auth-section');
        const appContainer = document.getElementById('app-container');
        const authEmailInput = document.getElementById('auth-email');
        const authPasswordInput = document.getElementById('auth-password');
        const authSigninBtn = document.getElementById('auth-signin-btn');
        const authSignupBtn = document.getElementById('auth-signup-btn');
        const forgotPasswordBtn = document.getElementById('forgot-password-btn'); // New forgot password button
        const authGoogleBtn = document.getElementById('auth-google-btn');
        const mainLogoutBtn = document.getElementById('main-logout-btn');
        const authMessage = document.getElementById('auth-message');
        const userIdSpan = document.getElementById('user-id');
        
        // The rest of the DOM elements from the original code
        const masterTab = document.getElementById('master-tab');
        const menuTab = document.getElementById('menu-tab');
        const salesTab = document.getElementById('sales-tab');
        const purchasesTab = document.getElementById('purchases-tab');
        const salaryTab = document.getElementById('salary-tab');
        const documentsTab = document.getElementById('documents-tab');
        const reportsTab = document.getElementById('reports-tab');

        const masterSection = document.getElementById('master-section');
        const menuSection = document.getElementById('menu-section');
        const salesSection = document.getElementById('sales-section');
        const purchasesSection = document.getElementById('purchases-section');
        const salarySection = document.getElementById('salary-section');
        const documentsSection = document.getElementById('documents-section');
        const reportsSection = document.getElementById('reports-section');
        
        const ingredientsTableBody = document.getElementById('ingredients-table-body');
        const addIngredientBtn = document.getElementById('add-ingredient-btn');
        const ingredientNameInput = document.getElementById('ingredient-name');
        const ingredientUnitInput = document.getElementById('ingredient-unit');
        const ingredientCostInput = document.getElementById('ingredient-cost');
        const masterMessage = document.getElementById('master-message');

        const menuItemsContainer = document.getElementById('menu-items-container');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuItemNameInput = document.getElementById('menu-item-name');
        const itemTypeSelect = document.getElementById('item-type-select');
        const dineInPriceInput = document.getElementById('dine-in-price');
        const takeAwayPriceInput = document.getElementById('take-away-price');

        const salesDateInput = document.getElementById('sales-date');
        const salesCashInput = document.getElementById('sales-cash');
        const salesCardInput = document.getElementById('sales-card');
        const salesUberInput = document.getElementById('sales-uber');
        const salesJustEatInput = document.getElementById('sales-justeat');
        const salesDeliverooInput = document.getElementById('sales-deliveroo');
        const salesWebsiteInput = document.getElementById('sales-website');
        const salesAdvanceInput = document.getElementById('sales-advance');
        const salesTooGoodToGoInput = document.getElementById('sales-toogoodtogo');
        const addSalesBtn = document.getElementById('add-sales-btn');
        const salesMessage = document.getElementById('sales-message');
        const salesHistoryBody = document.getElementById('sales-history-body');
        
        const purchaseDateInput = document.getElementById('purchase-date');
        const purchaseItemInput = document.getElementById('purchase-item');
        const purchaseCostInput = document.getElementById('purchase-cost');
        const addPurchaseBtn = document.getElementById('add-purchase-btn');
        const purchaseMessage = document.getElementById('purchase-message');
        const purchasesHistoryBody = document.getElementById('purchases-history-body');
        
        const salaryDateInput = document.getElementById('salary-date');
        const salaryEmployeeInput = document.getElementById('salary-employee');
        const salaryHoursInput = document.getElementById('salary-hours');
        const salaryRateInput = document.getElementById('salary-rate');
        const salaryTypeInput = document.getElementById('salary-type');
        const addSalaryBtn = document.getElementById('add-salary-btn');
        const salaryMessage = document.getElementById('salary-message');
        const salaryHistoryBody = document.getElementById('salary-history-body');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        let pendingDeleteIndex = -1;
        let pendingDeleteType = '';

        const downloadStartDateInput = document.getElementById('download-start-date');
        const downloadEndDateInput = document.getElementById('download-end-date');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        
        const downloadPurchaseStartDateInput = document.getElementById('download-purchase-start-date');
        const downloadPurchaseEndDateInput = document.getElementById('download-purchase-end-date');
        const downloadPurchasePdfBtn = document.getElementById('download-purchase-pdf-btn');
        const downloadPurchaseCsvBtn = document.getElementById('download-purchase-csv-btn');

        const downloadSalaryStartDateInput = document.getElementById('download-salary-start-date');
        const downloadSalaryEndDateInput = document.getElementById('download-salary-end-date');
        const downloadSalaryEmployeesSelect = document.getElementById('download-salary-employees');
        const downloadSalaryPdfBtn = document.getElementById('download-salary-pdf-btn');
        const downloadSalaryCsvBtn = document.getElementById('download-salary-csv-btn');

        const downloadIngredientsPdfBtn = document.getElementById('download-ingredients-pdf-btn');
        const downloadIngredientsCsvBtn = document.getElementById('download-ingredients-csv-btn');
        const uploadIngredientsFile = document.getElementById('upload-ingredients-file');
        const uploadIngredientsBtn = document.getElementById('upload-ingredients-btn');

        const documentFile = document.getElementById('document-file');
        const uploadDocumentBtn = document.getElementById('upload-document-btn');
        const documentsTableBody = document.getElementById('documents-table-body');
        const documentMessage = document.getElementById('document-message');
        
        const salesChartCanvas = document.getElementById('salesChart');
        const profitReportBody = document.getElementById('profit-report-body');
        
        const reportStartDateInput = document.getElementById('report-start-date');
        const reportEndDateInput = document.getElementById('report-end-date');
        const salesTargetInput = document.getElementById('sales-target-input');
        const filterSalesBtn = document.getElementById('filter-sales-btn');
        const downloadSalesReportPdfBtn = document.getElementById('download-sales-report-pdf');

        // Set today's date on the date pickers
        const today = new Date().toISOString().split('T')[0];
        salesDateInput.value = today;
        purchaseDateInput.value = today;
        salaryDateInput.value = today;
        downloadStartDateInput.value = today;
        downloadEndDateInput.value = today;
        downloadPurchaseStartDateInput.value = today;
        downloadPurchaseEndDateInput.value = today;
        downloadSalaryStartDateInput.value = today;
        downloadSalaryEndDateInput.value = today;
        
        // Set default date range for reports (last 30 days)
        const last30Days = new Date();
        last30Days.setDate(last30Days.getDate() - 30);
        reportStartDateInput.value = last30Days.toISOString().split('T')[0];
        reportEndDateInput.value = today;
        
        // Set initial sales target from local storage
        salesTargetInput.value = getSalesTarget();

        // --- Authentication Logic ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // User is signed in, show app content
                userId = user.uid;
                isAuthReady = true;
                authSection.classList.add('hidden');
                appContainer.classList.remove('hidden');
                userIdSpan.textContent = userId;
                setupDataListeners(userId);
            } else {
                // User is signed out, show auth form
                isAuthReady = false;
                userId = null;
                authSection.classList.remove('hidden');
                appContainer.classList.add('hidden');
            }
        });

        authSignupBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessage.textContent = '';
            if (email.trim() === '' || password.trim() === '') {
                authMessage.textContent = 'Please enter an email and password.';
                return;
            }
            try {
                await createUserWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authMessage.textContent = `Error: ${error.message}`;
            }
        });

        authSigninBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            const password = authPasswordInput.value;
            authMessage.textContent = '';
            if (email.trim() === '' || password.trim() === '') {
                authMessage.textContent = 'Please enter an email and password.';
                return;
            }
            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                authMessage.textContent = `Error: ${error.message}`;
            }
        });

        authGoogleBtn.addEventListener('click', async () => {
            authMessage.textContent = '';
            try {
                const provider = new GoogleAuthProvider();
                await signInWithPopup(auth, provider);
            } catch (error) {
                authMessage.textContent = `Error: ${error.message}`;
            }
        });
        
        // New event listener for the forgot password button
        forgotPasswordBtn.addEventListener('click', async () => {
            const email = authEmailInput.value;
            authMessage.textContent = '';
            if (email.trim() === '') {
                authMessage.textContent = 'Please enter your email address to reset your password.';
                return;
            }
            try {
                await sendPasswordResetEmail(auth, email);
                authMessage.textContent = 'A password reset email has been sent to your address.';
                authMessage.classList.remove('text-red-500');
                authMessage.classList.add('text-green-500');
            } catch (error) {
                authMessage.textContent = `Error: ${error.message}`;
                authMessage.classList.remove('text-green-500');
                authMessage.classList.add('text-red-500');
            }
        });

        mainLogoutBtn.addEventListener('click', async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Logout failed:", error);
            }
        });


        // --- Firestore Real-Time Listeners ---
        function setupDataListeners(uid) {
            
            // Listeners for the combined data document
            onSnapshot(doc(db, `artifacts/${appId}/users/${uid}/private_data`, DOC_ID), (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    masterIngredients = data.masterIngredients || [];
                    menuItems = data.menuItems || [];
                    dailySales = data.dailySales || [];
                    dailyPurchases = data.dailyPurchases || [];
                    salary = data.salary || [];
                    documents = data.documents || [];
                } else {
                    console.log("No data found for this user. Starting fresh.");
                }
                
                // Re-render all sections after receiving data
                renderAllData();
            }, (error) => {
                console.error("Error fetching data:", error);
            });
        }
        
        // Function to update Firestore
        async function saveData() {
            if (!isAuthReady) {
                console.warn("Authentication not ready. Cannot save data.");
                return;
            }
            try {
                const docRef = doc(db, `artifacts/${appId}/users/${userId}/private_data`, DOC_ID);
                await setDoc(docRef, {
                    masterIngredients,
                    menuItems,
                    dailySales,
                    dailyPurchases,
                    salary,
                    documents
                });
            } catch (e) {
                console.error("Error saving data:", e);
                const errorMessage = `Error saving data: ${e.message}`;
                const errorDiv = document.createElement('div');
                errorDiv.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                errorDiv.textContent = errorMessage;
                document.body.appendChild(errorDiv);
                setTimeout(() => errorDiv.remove(), 5000);
            }
        }
        
        // --- Core Data Structures & Functions (Updated for Firestore) ---
        // Functions now call `saveData` after manipulating the local arrays
        function saveIngredients() { saveData(); }
        function saveMenuItems() { saveData(); }
        function saveDailySales() { saveData(); }
        function saveDailyPurchases() { saveData(); }
        function saveSalary() { saveData(); }
        function saveDocuments() { saveData(); }
        function saveSalesTarget(target) { 
            // Sales target remains in local storage as it is a user-specific preference, not part of core data.
            localStorage.setItem('salesTarget', target);
        }
        function getSalesTarget() { return localStorage.getItem('salesTarget') ? parseFloat(localStorage.getItem('salesTarget')) : 0; }
        
        // Function to switch tabs
        function switchTab(activeTab, activeSection) {
            const tabs = [masterTab, menuTab, salesTab, purchasesTab, salaryTab, documentsTab, reportsTab];
            const sections = [masterSection, menuSection, salesSection, purchasesSection, salarySection, documentsSection, reportsSection];
            tabs.forEach(tab => tab.classList.remove('border-indigo-500', 'text-indigo-600'));
            sections.forEach(section => section.classList.add('hidden'));
            activeTab.classList.add('border-indigo-500', 'text-indigo-600');
            activeSection.classList.remove('hidden');
            
            // Special rendering for new sections
            if (activeSection === reportsSection) {
                renderReports();
            }
        }

        // Tab click handlers
        masterTab.addEventListener('click', () => { switchTab(masterTab, masterSection); renderIngredients(); });
        menuTab.addEventListener('click', () => { switchTab(menuTab, menuSection); renderMenuItems(); });
        salesTab.addEventListener('click', () => { switchTab(salesTab, salesSection); renderDailySales(); });
        purchasesTab.addEventListener('click', () => { switchTab(purchasesTab, purchasesSection); renderPurchases(); });
        salaryTab.addEventListener('click', () => { switchTab(salaryTab, salarySection); renderSalary(); });
        documentsTab.addEventListener('click', () => { switchTab(documentsTab, documentsSection); renderDocuments(); });
        reportsTab.addEventListener('click', () => { switchTab(reportsTab, reportsSection); renderReports(); });

        // --- Master Ingredients Logic ---
        function renderIngredients() {
            ingredientsTableBody.innerHTML = '';
            if (masterIngredients.length === 0) {
                masterMessage.textContent = 'No ingredients added yet. Please add one above.';
                return;
            }
            masterMessage.textContent = '';
            masterIngredients.forEach((ingredient, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${ingredient.name}</td>
                    <td class="py-3 px-4 text-gray-800">${ingredient.unit}</td>
                    <td class="py-3 px-4 text-gray-800">
                        <input type="number" value="${ingredient.cost.toFixed(2)}" class="w-24 p-1 border rounded text-right" data-index="${index}">
                    </td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-ingredient-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                ingredientsTableBody.appendChild(row);
            });
            attachIngredientEventListeners();
        }

        function attachIngredientEventListeners() {
            // Delete button
            document.querySelectorAll('#ingredients-table-body .delete-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'master-ingredient';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the ingredient "${masterIngredients[index].name}"? This will affect any menu items that use it.`;
                });
            });

            // Editable cost input
            document.querySelectorAll('#ingredients-table-body input[type="number"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = e.target.dataset.index;
                    const newCost = parseFloat(e.target.value);
                    if (!isNaN(newCost) && newCost >= 0) {
                        masterIngredients[index].cost = newCost;
                        saveIngredients();
                        renderMenuItems(); // Recalculate all COGS
                    }
                });
            });
        }
        
        addIngredientBtn.addEventListener('click', async () => {
            const name = ingredientNameInput.value.trim();
            const unit = ingredientUnitInput.value.trim();
            const cost = parseFloat(ingredientCostInput.value);
            if (!name || !unit || isNaN(cost) || cost <= 0) {
                masterMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            masterIngredients.push({ name, unit, cost });
            await saveData();
            ingredientNameInput.value = '';
            ingredientUnitInput.value = '';
            ingredientCostInput.value = '';
            masterMessage.textContent = 'Ingredient added successfully!';
        });

        // Master Ingredients Download
        downloadIngredientsPdfBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No ingredients to download.';
                downloadIngredientsPdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Restaurant Manager - Master Ingredients List`, 14, 20);
            const tableColumn = ["Ingredient Name", "Unit", "Cost per Unit (£)"];
            const tableRows = masterIngredients.map(ing => [ing.name, ing.unit, ing.cost.toFixed(2)]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save('Master_Ingredients.pdf');
        });

        downloadIngredientsCsvBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No ingredients to download.';
                downloadIngredientsCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const headers = ["Ingredient Name", "Unit", "Cost per Unit"];
            const rows = masterIngredients.map(ing => [
                `"${ing.name}"`,
                `"${ing.unit}"`,
                `"${ing.cost}"`
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Master_Ingredients.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Master Ingredients Upload
        uploadIngredientsBtn.addEventListener('click', async () => {
            const file = uploadIngredientsFile.files[0];
            if (!file) {
                masterMessage.textContent = 'Please select a CSV file to upload.';
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                const content = e.target.result;
                const lines = content.split('\n');
                const newIngredients = [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                if (headers[0] !== 'Ingredient Name' || headers[1] !== 'Unit' || headers[2] !== 'Cost per Unit') {
                    masterMessage.textContent = 'Error: Invalid CSV headers. Expected "Ingredient Name", "Unit", "Cost per Unit".';
                    return;
                }
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
                        const name = parts[0];
                        const unit = parts[1];
                        const cost = parseFloat(parts[2]);
                        if (name && unit && !isNaN(cost) && cost > 0) {
                            newIngredients.push({ name, unit, cost });
                        }
                    }
                }
                masterIngredients = newIngredients;
                await saveData();
                masterMessage.textContent = `Successfully uploaded ${newIngredients.length} ingredients!`;
            };
            reader.readAsText(file);
        });


        // --- Menu Items & Platters Logic ---
        function getIngredientCost(name) {
            const ingredient = masterIngredients.find(ing => ing.name === name);
            return ingredient ? ingredient.cost : 0;
        }

        function calculateCogs(ingredients) {
            let totalCogs = 0;
            ingredients.forEach(item => {
                let cost = 0;
                if (item.type === 'ingredient') {
                    const masterIng = masterIngredients.find(ing => ing.name === item.name);
                    cost = masterIng ? masterIng.cost * item.quantity : 0;
                } else if (item.type !== 'ingredient') {
                    const dish = menuItems.find(menuItem => menuItem.name === item.name);
                    cost = dish ? dish.cogs * item.quantity : 0;
                }
                totalCogs += cost;
            });
            return totalCogs;
        }
        
        // Helper function to get the COGS star icon based on percentage
        function getCogsStar(percent) {
            let colorClass = 'text-gray-400';
            if (percent > 0 && percent <= 30) {
                colorClass = 'text-yellow-400';
            } else if (percent >= 31 && percent <= 35) {
                colorClass = 'text-green-500';
            } else if (percent >= 36 && percent <= 40) {
                colorClass = 'text-amber-500';
            } else if (percent >= 41) {
                colorClass = 'text-red-500';
            }
            
            return `
                <div class="flex items-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} fill-current" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    <span class="text-xs font-semibold text-gray-600">${percent.toFixed(0)}%</span>
                </div>
            `;
        }

        function renderMenuItems() {
            menuItemsContainer.innerHTML = '';
            if (menuItems.length === 0) {
                menuItemsContainer.innerHTML = '<div class="text-center text-gray-600">No menu items added yet.</div>';
                return;
            }
            menuItems.forEach((item, index) => {
                item.cogs = calculateCogs(item.ingredients);
                const dineInVat = item.dineInPrice ? item.dineInPrice * 0.20 : 0;
                const takeAwayVat = item.takeAwayPrice ? item.takeAwayPrice * 0.20 : 0;
                
                const dineInCogsPercent = item.dineInPrice > 0 ? (item.cogs / item.dineInPrice) * 100 : 0;
                const takeAwayCogsPercent = item.takeAwayPrice > 0 ? (item.cogs / item.takeAwayPrice) * 100 : 0;
                
                const dineInCogsWithVat = item.cogs + dineInVat;
                const takeAwayCogsWithVat = item.cogs + takeAwayVat;

                // Calculate profit and profit margin for the menu item
                const profit = item.dineInPrice - item.cogs;
                const profitMargin = (profit / item.dineInPrice) * 100;
                
                const itemCard = document.createElement('div');
                itemCard.className = 'p-6 bg-white rounded-lg shadow-md border border-gray-200';
                itemCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4 cursor-pointer toggle-menu-item" data-index="${index}">
                        <h3 class="text-xl font-bold text-gray-800">${item.name} (${item.type.charAt(0).toUpperCase() + item.type.slice(1)})</h3>
                        <div class="flex items-center space-x-4">
                            <span class="text-lg font-semibold text-gray-600">COGS:</span>
                            <span class="text-2xl font-extrabold text-indigo-600">£${item.cogs.toFixed(2)}</span>
                            <button class="delete-item-btn text-red-500 hover:text-red-700" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-${index}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div id="item-details-${index}" class="space-y-4 hidden">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In Price</span>
                                <span class="block text-gray-800 font-bold text-lg">£${item.dineInPrice ? item.dineInPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">£${dineInVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In COGS%</span>
                                ${item.dineInPrice > 0 ? getCogsStar(dineInCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away Price</span>
                                <span class="block text-gray-800 font-bold text-lg">£${item.takeAwayPrice ? item.takeAwayPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">£${takeAwayVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away COGS%</span>
                                ${item.takeAwayPrice > 0 ? getCogsStar(takeAwayCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Dine-In COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">£${dineInCogsWithVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Take-Away COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">£${takeAwayCogsWithVat.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- Online Markup Calculator -->
                        <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 mt-4">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Online Platform Pricing</h4>
                            <div class="grid grid-cols-2 gap-4 items-center">
                                <div class="flex items-center space-x-2">
                                    <label for="online-markup-${index}" class="text-sm font-medium text-gray-700">Markup:</label>
                                    <input type="number" id="online-markup-${index}" min="0" max="500" value="0" class="w-24 p-2 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-lg font-bold text-gray-600">%</span>
                                </div>
                                <div>
                                    <span class="block text-gray-500 text-sm">Online Selling Price:</span>
                                    <span class="block text-gray-800 font-bold text-lg" id="online-price-display-${index}">£${item.dineInPrice ? item.dineInPrice.toFixed(2) : '0.00'}</span>
                                </div>
                            </div>
                        </div>
                        
                        <!-- New Profit Margin Display -->
                        <div class="p-4 border border-green-200 rounded-lg bg-green-50 mt-4">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Profitability Analysis</h4>
                            <div class="flex justify-between items-center">
                                <div>
                                    <span class="block text-gray-500 text-sm">Profit (Dine-In):</span>
                                    <span class="block text-green-700 font-bold text-lg">£${item.dineInPrice > 0 ? profit.toFixed(2) : 'N/A'}</span>
                                </div>
                                <div>
                                    <span class="block text-gray-500 text-sm">Profit Margin:</span>
                                    <span class="block text-green-700 font-bold text-lg">${item.dineInPrice > 0 ? profitMargin.toFixed(2) : 'N/A'}%</span>
                                </div>
                            </div>
                        </div>


                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Component</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Quantity</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Unit/Type</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Cost</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-table-body-${index}">
                                    ${item.ingredients.map((ing, i) => `
                                        <tr class="border-b border-gray-200 last:border-b-0">
                                            <td class="py-2 px-3 text-gray-700">${ing.name}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.quantity}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.type}</td>
                                            <td class="py-2 px-3 text-gray-700">£${calculateComponentCost(ing).toFixed(2)}</td>
                                            <td class="py-2 px-3">
                                                <button class="remove-component-btn text-red-500 hover:text-red-700" data-item-index="${index}" data-component-index="${i}">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Add Component to Recipe</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <select class="component-select p-2 border border-gray-300 rounded-lg" data-item-index="${index}">
                                    <option value="">Select...</option>
                                    <optgroup label="Ingredients">
                                        ${masterIngredients.map(ing => `<option value="${ing.name}" data-type="ingredient">${ing.name}</option>`).join('')}
                                    </optgroup>
                                    ${item.type === 'platter' ? `<optgroup label="Dishes">${menuItems.filter(m => m.type !== 'platter').map(d => `<option value="${d.name}" data-type="dish">${d.name}</option>`).join('')}</optgroup>` : ''}
                                </select>
                                <input type="number" placeholder="Quantity" class="component-quantity p-2 border border-gray-300 rounded-lg">
                                <button class="add-component-btn p-2 text-white font-bold rounded-lg bg-indigo-500 hover:bg-indigo-600 transition-colors" data-item-index="${index}">Add</button>
                            </div>
                        </div>
                    </div>
                `;
                menuItemsContainer.appendChild(itemCard);
            });
            attachMenuEventListeners();
        }

        function calculateComponentCost(component) {
            if (component.type === 'ingredient') {
                const ing = masterIngredients.find(i => i.name === component.name);
                return ing ? ing.cost * component.quantity : 0;
            } else if (component.type !== 'ingredient') {
                const dish = menuItems.find(i => i.name === component.name);
                return dish ? dish.cogs * component.quantity : 0;
            }
            return 0;
        }

        addMenuItemBtn.addEventListener('click', async () => {
            const name = menuItemNameInput.value.trim();
            const type = itemTypeSelect.value;
            const dineInPrice = parseFloat(dineInPriceInput.value);
            const takeAwayPrice = parseFloat(takeAwayPriceInput.value);
            if (!name) { return; }
            menuItems.push({ name, type, ingredients: [], cogs: 0, dineInPrice, takeAwayPrice });
            await saveData();
            menuItemNameInput.value = '';
            dineInPriceInput.value = '';
            takeAwayPriceInput.value = '';
        });

        function attachMenuEventListeners() {
            document.querySelectorAll('.add-component-btn').forEach(btn => {
                btn.addEventListener('click', async () => {
                    const itemIndex = btn.dataset.item-index;
                    const item = menuItems[itemIndex];
                    const card = btn.closest('.p-6');
                    const select = card.querySelector('.component-select');
                    const quantity = parseFloat(card.querySelector('.component-quantity').value);
                    const selectedOption = select.options[select.selectedIndex];
                    const name = selectedOption.value;
                    const type = selectedOption.dataset.type;

                    if (!name || isNaN(quantity) || quantity <= 0) { return; }
                    
                    item.ingredients.push({ name, quantity, type });
                    await saveData();
                    
                    card.querySelector('.component-select').value = '';
                    card.querySelector('.component-quantity').value = '';
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'menu-item';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the menu item "${menuItems[index].name}"?`;
                });
            });
            
            document.querySelectorAll('.remove-component-btn').forEach(btn => {
                btn.addEventListener('click', async (e) => {
                    const itemIndex = e.target.closest('button').dataset.itemIndex;
                    const componentIndex = e.target.closest('button').dataset.componentIndex;
                    menuItems[itemIndex].ingredients.splice(componentIndex, 1);
                    await saveData();
                });
            });
            
            document.querySelectorAll('[id^="online-markup-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = e.target.id.split('-')[2];
                    const markup = parseFloat(e.target.value) || 0;
                    const dineInPrice = menuItems[index].dineInPrice;
                    const onlinePrice = dineInPrice + (dineInPrice * (markup / 100));
                    document.getElementById(`online-price-display-${index}`).textContent = `£${onlinePrice.toFixed(2)}`;
                });
            });

            // Toggle collapsible sections
            document.querySelectorAll('.toggle-menu-item').forEach(header => {
                header.addEventListener('click', (e) => {
                    // Prevent the click from triggering if the target is a delete button
                    if (e.target.closest('.delete-item-btn')) {
                        return;
                    }
                    const index = header.dataset.index;
                    const details = document.getElementById(`item-details-${index}`);
                    const chevron = document.getElementById(`chevron-${index}`);
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                });
            });
        }
        
        // --- Daily Sales Logic ---
        function renderDailySales() {
            salesHistoryBody.innerHTML = '';
            if (dailySales.length === 0) {
                salesHistoryBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-600 py-4">No sales recorded yet.</td></tr>';
                return;
            }
            dailySales.forEach((sale, index) => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                const onlineTotal = sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.toogoodtogo;
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${sale.date}</td>
                    <td class="py-3 px-4">£${sale.cash.toFixed(2)}</td>
                    <td class="py-3 px-4">£${sale.card.toFixed(2)}</td>
                    <td class="py-3 px-4">£${onlineTotal.toFixed(2)}</td>
                    <td class="py-3 px-4 font-bold">£${total.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-sales-record-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salesHistoryBody.appendChild(row);
            });
            attachSalesEventListeners();
        }

        function attachSalesEventListeners() {
            document.querySelectorAll('.delete-sales-record-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'sales';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the sales record for ${dailySales[index].date}?`;
                });
            });
        }

        addSalesBtn.addEventListener('click', async () => {
            const date = salesDateInput.value;
            const cash = parseFloat(salesCashInput.value) || 0;
            const card = parseFloat(salesCardInput.value) || 0;
            const uber = parseFloat(salesUberInput.value) || 0;
            const justeat = parseFloat(salesJustEatInput.value) || 0;
            const deliveroo = parseFloat(salesDeliverooInput.value) || 0;
            const website = parseFloat(salesWebsiteInput.value) || 0;
            const advance = parseFloat(salesAdvanceInput.value) || 0;
            const toogoodtogo = parseFloat(salesTooGoodToGoInput.value) || 0;

            if (!date) { 
                salesMessage.textContent = 'Please select a date.'; 
                return; 
            }
            
            dailySales.push({ date, cash, card, uber, justeat, deliveroo, website, advance, toogoodtogo });
            await saveData();
            salesMessage.textContent = 'Sales recorded successfully!';
            
            // Clear input fields
            salesCashInput.value = '';
            salesCardInput.value = '';
            salesUberInput.value = '';
            salesJustEatInput.value = '';
            salesDeliverooInput.value = '';
            salesWebsiteInput.value = '';
            salesAdvanceInput.value = '';
            salesTooGoodToGoInput.value = '';
            salesDateInput.value = new Date().toISOString().split('T')[0];
        });

        // --- Purchases Logic ---
        function renderPurchases() {
            purchasesHistoryBody.innerHTML = '';
            if (dailyPurchases.length === 0) {
                purchasesHistoryBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-600 py-4">No purchases recorded yet.</td></tr>';
                return;
            }
            dailyPurchases.forEach((purchase, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${purchase.date}</td>
                    <td class="py-3 px-4">${purchase.item}</td>
                    <td class="py-3 px-4">£${purchase.cost.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-purchase-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                purchasesHistoryBody.appendChild(row);
            });
            attachPurchasesEventListeners();
        }
        
        function attachPurchasesEventListeners() {
            document.querySelectorAll('.delete-purchase-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'purchases';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the purchase record for "${dailyPurchases[index].item}" on ${dailyPurchases[index].date}?`;
                });
            });
        }
        
        addPurchaseBtn.addEventListener('click', async () => {
            const date = purchaseDateInput.value;
            const item = purchaseItemInput.value.trim();
            const cost = parseFloat(purchaseCostInput.value);
            if (!date || !item || isNaN(cost) || cost <= 0) {
                purchaseMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            dailyPurchases.push({ date, item, cost });
            await saveData();
            purchaseDateInput.value = today;
            purchaseItemInput.value = '';
            purchaseCostInput.value = '';
            purchaseMessage.textContent = 'Purchase recorded successfully!';
        });
        
        // --- Salary Logic ---
        function renderSalary() {
            salaryHistoryBody.innerHTML = '';
            if (salary.length === 0) {
                salaryHistoryBody.innerHTML = '<tr><td colspan="7" class="text-center text-gray-600 py-4">No salary payments recorded yet.</td></tr>';
                return;
            }
            salary.forEach((payment, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${payment.date}</td>
                    <td class="py-3 px-4">${payment.employee}</td>
                    <td class="py-3 px-4">${payment.type}</td>
                    <td class="py-3 px-4">${payment.hours ? payment.hours.toFixed(2) : '-'}</td>
                    <td class="py-3 px-4">£${payment.rate ? payment.rate.toFixed(2) : '-'}</td>
                    <td class="py-3 px-4">£${payment.amount.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-salary-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salaryHistoryBody.appendChild(row);
            });
            attachSalaryEventListeners();
            populateEmployeeDropdown();
        }
        
        function populateEmployeeDropdown() {
            const uniqueEmployees = [...new Set(salary.map(p => p.employee))].sort();
            downloadSalaryEmployeesSelect.innerHTML = `<option value="">All Employees</option>`;
            uniqueEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                downloadSalaryEmployeesSelect.appendChild(option);
            });
        }

        function attachSalaryEventListeners() {
            document.querySelectorAll('.delete-salary-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'salary';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the salary payment for "${salary[index].employee}" on ${salary[index].date}?`;
                });
            });
        }

        addSalaryBtn.addEventListener('click', async () => {
            const date = salaryDateInput.value;
            const employee = salaryEmployeeInput.value.trim();
            const type = salaryTypeInput.value;
            const hours = parseFloat(salaryHoursInput.value);
            const rate = parseFloat(salaryRateInput.value);
            
            if (!date || !employee || isNaN(hours) || hours <= 0 || isNaN(rate) || rate <= 0) {
                salaryMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            
            const amount = hours * rate;

            salary.push({ date, employee, type, hours, rate, amount });
            await saveData();
            salaryDateInput.value = today;
            salaryEmployeeInput.value = '';
            salaryHoursInput.value = '';
            salaryRateInput.value = '';
            salaryTypeInput.value = '';
            salaryMessage.textContent = 'Salary payment recorded successfully!';
        });

        // --- Documents Logic ---
        function renderDocuments() {
            documentsTableBody.innerHTML = '';
            if (documents.length === 0) {
                documentsTableBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-600 py-4">No documents uploaded yet.</td></tr>';
                return;
            }
            documents.forEach((doc, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${doc.name}</td>
                    <td class="py-3 px-4 text-gray-800">${doc.type}</td>
                    <td class="py-3 px-4 text-gray-800">${(doc.size / 1024).toFixed(2)} KB</td>
                    <td class="py-3 px-4 flex gap-2">
                        <button data-index="${index}" class="download-document-btn text-indigo-600 hover:text-indigo-800 transition-colors duration-200">
                            Download
                        </button>
                        <button data-index="${index}" class="delete-document-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                documentsTableBody.appendChild(row);
            });
            attachDocumentEventListeners();
        }

        function attachDocumentEventListeners() {
            // Download button
            document.querySelectorAll('.download-document-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    const doc = documents[index];
                    if (doc.data) {
                        const link = document.createElement('a');
                        link.href = doc.data;
                        link.download = doc.name;
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                });
            });

            // Delete button
            document.querySelectorAll('.delete-document-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'documents';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the document "${documents[index].name}"?`;
                });
            });
        }

        uploadDocumentBtn.addEventListener('click', async () => {
            const file = documentFile.files[0];
            if (!file) {
                documentMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                documentMessage.textContent = 'Please select a file to upload.';
                setTimeout(() => documentMessage.textContent = '', 3000);
                return;
            }

            const reader = new FileReader();
            reader.onload = async (e) => {
                documents.push({
                    name: file.name,
                    type: file.type,
                    size: file.size,
                    data: e.target.result
                });
                await saveData();
                documentFile.value = '';
                documentMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-green-500 rounded-lg bg-green-100';
                documentMessage.textContent = 'Document uploaded successfully!';
                setTimeout(() => documentMessage.textContent = '', 3000);
            };
            reader.readAsDataURL(file);
        });

        // --- Reports Logic (New) ---
        function renderReports(startDate = null, endDate = null) {
            renderSalesChart(startDate, endDate);
            renderProfitReport();
        }

        function renderSalesChart(startDate = null, endDate = null) {
            // Use a default date range if none is provided
            if (!startDate || !endDate) {
                const today = new Date();
                const defaultStartDate = new Date();
                defaultStartDate.setDate(today.getDate() - 30);
                startDate = defaultStartDate.toISOString().split('T')[0];
                endDate = today.toISOString().split('T')[0];
                reportStartDateInput.value = startDate;
                reportEndDateInput.value = endDate;
            }

            const daysOfWeek = ['Sun', 'Mon', 'Tue', 'Wed', 'Thu', 'Fri', 'Sat'];
            const salesByDate = {};
            
            // Filter sales data by date range
            const filteredSales = dailySales.filter(sale => sale.date >= startDate && sale.date <= endDate);

            filteredSales.forEach(sale => {
                const totalSales = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                if (salesByDate[sale.date]) {
                    salesByDate[sale.date] += totalSales;
                } else {
                    salesByDate[sale.date] = totalSales;
                }
            });

            const sortedDates = Object.keys(salesByDate).sort();
            const salesData = sortedDates.map(date => salesByDate[date]);
            const labels = sortedDates.map(dateStr => {
                const date = new Date(dateStr);
                return `${daysOfWeek[date.getDay()]} (${date.getDate()})`;
            });

            // Get sales target and determine point colors
            const salesTarget = getSalesTarget();
            const pointColors = salesData.map(sale => {
                if (salesTarget > 0) {
                    if (sale >= salesTarget) {
                        return '#10b981'; // green
                    } else if (sale >= salesTarget * 0.9) {
                        return '#f59e0b'; // amber
                    } else {
                        return '#ef4444'; // red
                    }
                }
                return '#4f46e5'; // default indigo
            });

            // If a chart instance already exists, destroy it before creating a new one
            if (window.salesChartInstance) {
                window.salesChartInstance.destroy();
            }

            window.salesChartInstance = new Chart(salesChartCanvas, {
                type: 'line',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Daily Total Sales (£)',
                        data: salesData,
                        borderColor: '#4f46e5',
                        backgroundColor: 'rgba(79, 70, 229, 0.2)',
                        pointBackgroundColor: pointColors, // Set point colors based on target
                        pointRadius: 5,
                        pointHoverRadius: 8,
                        tension: 0.1,
                        fill: true
                    }]
                },
                options: {
                    responsive: true,
                    plugins: {
                        legend: {
                            position: 'top',
                        },
                        title: {
                            display: false,
                        }
                    },
                    scales: {
                        y: {
                            beginAtZero: true,
                            title: {
                                display: true,
                                text: 'Total Sales (£)'
                            }
                        },
                        x: {
                            title: {
                                display: true,
                                text: 'Date'
                            }
                        }
                    }
                }
            });
        }

        function renderProfitReport() {
            profitReportBody.innerHTML = '';
            if (menuItems.length === 0) {
                profitReportBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-600 py-4">No menu items to analyze.</td></tr>';
                return;
            }

            menuItems.forEach(item => {
                // Ensure COGS is calculated for the report
                item.cogs = calculateCogs(item.ingredients);
                const profit = item.dineInPrice - item.cogs;
                const profitMargin = item.dineInPrice > 0 ? (profit / item.dineInPrice) * 100 : 0;
                
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${item.name}</td>
                    <td class="py-3 px-4 text-gray-800">£${item.cogs.toFixed(2)}</td>
                    <td class="py-3 px-4 text-gray-800">£${item.dineInPrice ? item.dineInPrice.toFixed(2) : 'N/A'}</td>
                    <td class="py-3 px-4 text-green-600 font-semibold">£${item.dineInPrice > 0 ? profit.toFixed(2) : 'N/A'}</td>
                    <td class="py-3 px-4 text-green-600 font-semibold">${item.dineInPrice > 0 ? profitMargin.toFixed(2) : 'N/A'}%</td>
                `;
                profitReportBody.appendChild(row);
            });
        }
        
        // --- Global Data Management (Confirmation & Downloads) ---
        confirmDeleteBtn.addEventListener('click', async () => {
            if (pendingDeleteType === 'master-ingredient') {
                if (pendingDeleteIndex !== -1) {
                    masterIngredients.splice(pendingDeleteIndex, 1);
                    await saveData();
                    renderMenuItems(); // Recalculate COGS
                }
            } else if (pendingDeleteType === 'menu-item') {
                if (pendingDeleteIndex !== -1) {
                    menuItems.splice(pendingDeleteIndex, 1);
                    await saveData();
                }
            } else if (pendingDeleteType === 'sales') {
                if (pendingDeleteIndex !== -1) {
                    dailySales.splice(pendingDeleteIndex, 1);
                    await saveData();
                    renderReports(); // Update reports
                }
            } else if (pendingDeleteType === 'purchases') {
                if (pendingDeleteIndex !== -1) {
                    dailyPurchases.splice(pendingDeleteIndex, 1);
                    await saveData();
                }
            } else if (pendingDeleteType === 'salary') {
                if (pendingDeleteIndex !== -1) {
                    salary.splice(pendingDeleteIndex, 1);
                    await saveData();
                }
            } else if (pendingDeleteType === 'documents') {
                if (pendingDeleteIndex !== -1) {
                    documents.splice(pendingDeleteIndex, 1);
                    await saveData();
                }
            }
            pendingDeleteIndex = -1;
            pendingDeleteType = '';
            confirmModal.classList.add('hidden');
        });

        cancelDeleteBtn.addEventListener('click', () => {
            pendingDeleteIndex = -1;
            pendingDeleteType = '';
            confirmModal.classList.add('hidden');
        });

        // Sales PDF Download
        downloadPdfBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                // Using a custom message box instead of alert()
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredSales = dailySales.filter(sale => {
                return sale.date >= startDate && sale.date <= endDate;
            });
            if (filteredSales.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No sales data found for the selected date range.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Restaurant Manager - Daily Sales Report`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", "Cash (£)", "Card (£)", "Online (£)", "Total (£)"];
            const tableRows = filteredSales.map(sale => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                const onlineTotal = sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.toogoodtogo;
                return [
                    sale.date,
                    sale.cash.toFixed(2),
                    sale.card.toFixed(2),
                    onlineTotal.toFixed(2),
                    total.toFixed(2)
                ];
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Sales_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Sales CSV Download
        downloadCsvBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredSales = dailySales.filter(sale => {
                return sale.date >= startDate && sale.date <= endDate;
            });
            if (filteredSales.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No sales data found for the selected date range.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const headers = ["Date", "Cash", "Card", "Uber Eats", "Just Eat", "Deliveroo", "Website", "Booking Advance", "Too Good To Go", "Total"];
            const rows = filteredSales.map(sale => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                return [
                    sale.date,
                    sale.cash,
                    sale.card,
                    sale.uber,
                    sale.justeat,
                    sale.deliveroo,
                    sale.website,
                    sale.advance,
                    sale.toogoodtogo,
                    total
                ].map(value => `"${value}"`).join(",");
            });
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Sales_Report_${startDate}_to_${endDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Purchases PDF Download
        downloadPurchasePdfBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredPurchases = dailyPurchases.filter(purchase => {
                return purchase.date >= startDate && purchase.date <= endDate;
            });
            if (filteredPurchases.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No purchase data found for the selected date range.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Restaurant Manager - Daily Purchases Report`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", "Item/Service", "Total Cost (£)"];
            const tableRows = filteredPurchases.map(purchase => [
                purchase.date,
                purchase.item,
                purchase.cost.toFixed(2)
            ]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Purchases_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Purchases CSV Download
        downloadPurchaseCsvBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredPurchases = dailyPurchases.filter(purchase => {
                return purchase.date >= startDate && purchase.date <= endDate;
            });
            if (filteredPurchases.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No purchase data found for the selected date range.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const headers = ["Date", "Item/Service", "Total Cost"];
            const rows = filteredPurchases.map(purchase => [
                `"${purchase.date}"`,
                `"${purchase.item}"`,
                `"${purchase.cost}"`
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Purchases_Report_${startDate}_to_${endDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Salary PDF Download
        downloadSalaryPdfBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            let filteredSalary = salary.filter(payment => {
                return payment.date >= startDate && payment.date <= endDate;
            });

            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(payment => selectedEmployees.includes(payment.employee));
            }

            if (filteredSalary.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No salary data found for the selected criteria.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Restaurant Manager - Salary Report`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                doc.text(`Employees: ${selectedEmployees.join(', ')}`, 14, 37);
            }

            const tableColumn = ["Date", "Employee Name", "Payment Type", "Hours", "Hourly Rate (£)", "Amount (£)"];
            const tableRows = filteredSalary.map(payment => [
                payment.date,
                payment.employee,
                payment.type,
                payment.hours.toFixed(2),
                payment.rate.toFixed(2),
                payment.amount.toFixed(2)
            ]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 45,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Salary_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Salary CSV Download
        downloadSalaryCsvBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            let filteredSalary = salary.filter(payment => {
                return payment.date >= startDate && payment.date <= endDate;
            });

            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(payment => selectedEmployees.includes(payment.employee));
            }
            
            if (filteredSalary.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No salary data found for the selected criteria.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            const headers = ["Date", "Employee Name", "Payment Type", "Hours", "Hourly Rate", "Amount"];
            const rows = filteredSalary.map(payment => [
                `"${payment.date}"`,
                `"${payment.employee}"`,
                `"${payment.type}"`,
                `"${payment.hours}"`,
                `"${payment.rate}"`,
                `"${payment.amount}"`
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Salary_Report_${startDate}_to_${endDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // --- Initial setup function
        function renderAllData() {
            renderIngredients();
            renderMenuItems();
            renderDailySales();
            renderPurchases();
            renderSalary();
            renderDocuments();
            renderReports(); 
        }

        // Event listeners for the new report features
        filterSalesBtn.addEventListener('click', () => {
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const salesTarget = parseFloat(salesTargetInput.value);
            if (!isNaN(salesTarget) && salesTarget > 0) {
                saveSalesTarget(salesTarget);
            }
            renderSalesChart(startDate, endDate);
        });

        downloadSalesReportPdfBtn.addEventListener('click', () => {
            const startDate = reportStartDateInput.value;
            const endDate = reportEndDateInput.value;
            const salesTarget = getSalesTarget();

            if (!startDate || !endDate) {
                // Using a custom message box instead of alert()
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'Please select a valid date range.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            const filteredSales = dailySales.filter(sale => {
                return sale.date >= startDate && sale.date <= endDate;
            });

            if (filteredSales.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'fixed top-4 right-4 bg-red-500 text-white px-4 py-2 rounded-lg shadow-lg';
                downloadMessage.textContent = 'No sales data found for the selected date range.';
                document.body.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text(`Restaurant Manager - Daily Sales Report`, 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            if (salesTarget > 0) {
                doc.text(`Daily Sales Target: £${salesTarget.toFixed(2)}`, 14, 37);
            }

            const tableColumn = ["Date", "Day of Week", "Total Sales (£)", "Status"];
            const tableRows = filteredSales.map(sale => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                const date = new Date(sale.date);
                const dayOfWeek = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'][date.getDay()];
                
                let status = 'N/A';
                if (salesTarget > 0) {
                    if (total >= salesTarget) {
                        status = 'Target Met';
                    } else if (total >= salesTarget * 0.9) {
                        status = '10% Below Target';
                    } else {
                        status = 'Below Target';
                    }
                }
                
                return [
                    sale.date,
                    dayOfWeek,
                    total.toFixed(2),
                    status
                ];
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: salesTarget > 0 ? 45 : 40,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Sales_Report_${startDate}_to_${endDate}.pdf`);
        });

    </script>
</body>
</html>
