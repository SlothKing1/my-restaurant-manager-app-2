<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Restaurant Manager</title>
    <!-- Tailwind CSS CDN for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f3f4f6;
        }
        .container {
            max-width: 1100px;
        }
        input[type="number"]::-webkit-outer-spin-button,
        input[type="number"]::-webkit-inner-spin-button {
            -webkit-appearance: none;
            margin: 0;
        }
        input[type="number"] {
            -moz-appearance: textfield;
        }
        .hidden {
            display: none;
        }
    </style>
</head>
<body class="bg-gray-100 flex items-center justify-center min-h-screen p-4">

    <!-- Login/Password Form -->
    <div id="login-container" class="container bg-white rounded-xl shadow-2xl p-8 w-full max-w-md">
        <h1 class="text-4xl font-extrabold text-gray-800 text-center mb-4">Restaurant Manager</h1>
        <p class="text-center text-gray-500 mb-6">Enter the password to access the app.</p>
        <form id="login-form">
            <input type="password" id="password-input" placeholder="Password" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            <button type="submit" class="w-full mt-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                Log In
            </button>
        </form>
        <div id="login-message" class="mt-4 text-center text-sm font-medium text-red-500 hidden">Incorrect password. Please try again.</div>
    </div>

    <div id="app-content" class="container bg-white rounded-xl shadow-2xl p-8 w-full hidden">
        <!-- Title and Description -->
        <div class="flex items-center justify-between mb-8">
            <div class="text-center">
                <h1 class="text-4xl font-extrabold text-gray-800">Restaurant Manager</h1>
                <p class="mt-2 text-lg text-gray-500">Your all-in-one tool for costing, sales, and purchases.</p>
            </div>
        </div>

        <!-- Navigation Tabs -->
        <div class="flex flex-wrap border-b border-gray-200 mb-6">
            <button id="master-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Master Ingredients
            </button>
            <button id="menu-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Menu Costing
            </button>
            <button id="sales-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Daily Sales
            </button>
            <button id="purchases-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Purchases
            </button>
            <button id="salary-tab" class="py-3 px-6 text-base md:text-xl font-medium text-center text-gray-600 border-b-4 border-transparent hover:text-indigo-600 hover:border-indigo-500 transition-colors duration-200">
                Salary
            </button>
        </div>

        <!-- Content Sections -->

        <!-- Master Ingredients Section -->
        <div id="master-section" class="p-6 bg-gray-50 rounded-lg transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Master Ingredients</h2>
            
            <!-- Add New Ingredient Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Add a New Ingredient</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="ingredient-name" placeholder="Ingredient Name" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="ingredient-unit" placeholder="Unit (e.g., kg, gram)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="ingredient-cost" placeholder="Cost per Unit (£)" class="col-span-1 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-ingredient-btn" class="col-span-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Ingredient
                    </button>
                </div>
            </div>

            <!-- Search and Scrollable Ingredients Table -->
            <div class="mb-4">
                <input type="text" id="master-search" placeholder="Search ingredients..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Ingredient</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Unit</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Cost per Unit</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="ingredients-table-body">
                        <!-- Ingredient rows will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>
            
            <!-- Message container -->
            <div id="master-message" class="mt-4 p-3 text-center text-sm font-medium text-gray-600 rounded-lg"></div>

            <!-- Import/Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Manage Ingredient Data</h3>
                
                <!-- Download Records Section -->
                <div class="mb-6">
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download All Ingredients</h4>
                    <div class="flex flex-col sm:flex-row gap-4">
                        <button id="download-ingredients-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-ingredients-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>

                <!-- Upload Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Upload Ingredients (CSV)</h4>
                    <p class="text-sm text-gray-500 mb-2">CSV file should have headers: "Ingredient Name", "Unit", "Cost per Unit"</p>
                    <div class="flex flex-col sm:flex-row gap-4 items-center">
                        <input type="file" id="upload-ingredients-file" accept=".csv" class="flex-1 block w-full text-sm text-gray-500 file:mr-4 file:py-2 file:px-4 file:rounded-lg file:border-0 file:text-sm file:font-semibold file:bg-indigo-50 file:text-indigo-700 hover:file:bg-indigo-100">
                        <button id="upload-ingredients-btn" class="w-full sm:w-auto p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Upload & Replace
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Menu Items & Platters Section -->
        <div id="menu-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Menu Costing</h2>

            <!-- Add New Menu Item Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Add New Dish or Platter</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="text" id="menu-item-name" placeholder="Name" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="item-type-select" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="dish">Dish</option>
                        <option value="platter">Platter</option>
                        <option value="starter">Starter</option>
                        <option value="sides">Sides</option>
                        <option value="salads">Salads</option>
                        <option value="dessert">Dessert</option>
                        <option value="drinks">Drinks</option>
                        <option value="wraps">Wraps</option>
                    </select>
                    <input type="number" id="dine-in-price" placeholder="Dine-In Price (£)" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="take-away-price" placeholder="Take-Away Price (£)" class="col-span-2 p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-menu-item-btn" class="col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Add Item
                    </button>
                </div>
            </div>

            <!-- Search and Scrollable Menu Items List -->
            <div class="mb-4">
                <input type="text" id="menu-search" placeholder="Search menu items..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div id="menu-items-container" class="space-y-6 overflow-y-auto max-h-96">
                <!-- Menu item cards will be dynamically inserted here -->
            </div>
        </div>
        
        <!-- Daily Sales Section -->
        <div id="sales-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Daily Sales & Bookings</h2>
            
            <!-- Record Sales Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Record Today's Sales</h3>
                <div class="grid md:grid-cols-3 gap-4 items-end">
                    <input type="date" id="sales-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-cash" placeholder="Cash (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-card" placeholder="Card (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-uber" placeholder="Uber Eats (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-justeat" placeholder="Just Eat (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-deliveroo" placeholder="Deliveroo (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-website" placeholder="Website (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-advance" placeholder="Booking Advance (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="sales-toogoodtogo" placeholder="Too Good To Go (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-sales-btn" class="col-span-3 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Sales
                    </button>
                </div>
                <div id="sales-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>
            
            <!-- Search and Scrollable Daily Sales Summary Table -->
            <div class="mb-4">
                <input type="text" id="sales-search" placeholder="Search sales by date..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Date</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Cash (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Card (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Online (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Total (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="sales-history-body">
                        <!-- Sales history will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Download Sales Data</h3>
                
                <!-- Download Records Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Sales History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>

        <!-- Purchases Section -->
        <div id="purchases-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Purchases & Expenses</h2>

            <!-- Record Purchase Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Record a Purchase</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="date" id="purchase-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="purchase-item" placeholder="Item/Service Name" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="number" id="purchase-cost" placeholder="Total Cost (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-purchase-btn" class="p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Purchase
                    </button>
                </div>
                <div id="purchase-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <!-- Search and Scrollable Purchases History Table -->
            <div class="mb-4">
                <input type="text" id="purchases-search" placeholder="Search purchases..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Date</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Item/Service</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Total Cost (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="purchases-history-body">
                        <!-- Purchases history will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Download Purchases Data</h3>
                
                <!-- Download Records Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Purchases History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end">
                        <div>
                            <label for="download-purchase-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-purchase-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-purchase-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-purchase-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-purchase-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-purchase-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Salary Section -->
        <div id="salary-section" class="p-6 bg-gray-50 rounded-lg hidden transition-opacity duration-300 ease-in-out">
            <h2 class="text-2xl font-bold mb-4 text-gray-700">Salary</h2>

            <!-- Record Salary Form -->
            <div class="mb-6 p-4 border border-gray-200 rounded-lg bg-white shadow-sm">
                <h3 class="text-xl font-semibold text-gray-600 mb-3">Record Salary Payment</h3>
                <div class="grid md:grid-cols-4 gap-4 items-end">
                    <input type="date" id="salary-date" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <input type="text" id="salary-employee" placeholder="Employee Name" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <select id="salary-type" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                        <option value="">Select Payment Type</option>
                        <option value="Weekly Salary">Weekly Salary</option>
                        <option value="Monthly Salary">Monthly Salary</option>
                        <option value="Bonus">Bonus</option>
                        <option value="Overtime">Overtime</option>
                    </select>
                    <input type="number" id="salary-amount" placeholder="Amount (£)" class="p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
                    <button id="add-salary-btn" class="col-span-4 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                        Record Payment
                    </button>
                </div>
                <div id="salary-message" class="mt-4 text-sm font-medium text-gray-600"></div>
            </div>

            <!-- Search and Scrollable Salary History Table -->
            <div class="mb-4">
                <input type="text" id="salary-search" placeholder="Search employees..." class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500 transition-shadow">
            </div>
            <div class="overflow-y-auto max-h-96">
                <table class="min-w-full bg-white rounded-lg shadow-md overflow-hidden">
                    <thead class="bg-gray-100 border-b border-gray-200 sticky top-0">
                        <tr>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Date</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Employee Name</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Payment Type</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Amount (£)</th>
                            <th class="py-3 px-4 text-left font-semibold text-gray-600">Actions</th>
                        </tr>
                    </thead>
                    <tbody id="salary-history-body">
                        <!-- Salary history will be dynamically inserted here -->
                    </tbody>
                </table>
            </div>

            <!-- Export Options -->
            <div class="mt-8 p-6 bg-white rounded-lg shadow-md border border-gray-200">
                <h3 class="text-xl font-semibold text-gray-600 mb-4">Download Salary Data</h3>
                
                <!-- Download Records Section -->
                <div>
                    <h4 class="text-lg font-medium text-gray-700 mb-2">Download Salary History</h4>
                    <div class="grid sm:grid-cols-2 gap-4 items-end mb-4">
                        <div>
                            <label for="download-salary-start-date" class="block text-sm font-medium text-gray-700 mb-1">Start Date</label>
                            <input type="date" id="download-salary-start-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                        <div>
                            <label for="download-salary-end-date" class="block text-sm font-medium text-gray-700 mb-1">End Date</label>
                            <input type="date" id="download-salary-end-date" class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                        </div>
                    </div>
                    <div class="mb-4">
                        <label for="download-salary-employees" class="block text-sm font-medium text-gray-700 mb-1">Select Employees</label>
                        <select id="download-salary-employees" multiple class="w-full p-3 border border-gray-300 rounded-lg focus:outline-none focus:ring-2 focus:ring-indigo-500">
                            <!-- Options will be dynamically populated -->
                        </select>
                    </div>
                    <div class="flex flex-col sm:flex-row gap-4 mt-4">
                        <button id="download-salary-pdf-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-indigo-600 hover:bg-indigo-700 transition-colors duration-200 shadow-md">
                            Download as PDF
                        </button>
                        <button id="download-salary-csv-btn" class="flex-1 p-3 text-white font-bold rounded-lg bg-gray-600 hover:bg-gray-700 transition-colors duration-200 shadow-md">
                            Download as Google Sheet (CSV)
                        </button>
                    </div>
                </div>
            </div>
        </div>
        
    </div>
    
    <!-- Confirmation Modal -->
    <div id="confirm-modal" class="fixed inset-0 bg-gray-900 bg-opacity-50 flex items-center justify-center p-4 hidden">
        <div class="bg-white rounded-lg p-6 w-full max-w-sm shadow-xl">
            <h4 class="text-lg font-bold text-gray-800 mb-4">Confirm Deletion</h4>
            <p id="confirm-message" class="text-gray-600 mb-6"></p>
            <div class="flex justify-end gap-3">
                <button id="cancel-delete-btn" class="px-4 py-2 text-gray-700 rounded-lg border border-gray-300 hover:bg-gray-100 transition-colors">
                    No, Cancel
                </button>
                <button id="confirm-delete-btn" class="px-4 py-2 text-white bg-red-600 rounded-lg hover:bg-red-700 transition-colors">
                    Yes, Delete
                </button>
            </div>
        </div>
    </div>
    
    <!-- JS PDF libraries for PDF generation (fixed order) -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf-autotable/3.5.23/jspdf.plugin.autotable.min.js"></script>
    
    <!-- Firebase SDKs -->
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, setDoc, onSnapshot } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";
        
        // Firebase configuration provided by the user
        const firebaseConfig = {
          apiKey: "AIzaSyAoWY28i0hP3DN2t8fw2A61rBDw2yoIwS0",
          authDomain: "my-web-app2-c8dd0.firebaseapp.com",
          projectId: "my-web-app2-c8dd0",
          storageBucket: "my-web-app2-c8dd0.firebasestorage.app",
          messagingSenderId: "430499672591",
          appId: "1:430499672591:web:f11185605aece22dbee97a"
        };
        
        let db;
        // The single document to store all data.
        const mainDocId = 'restaurant-data';
        
        // --- Core Data Structures & Firestore Functions ---
        let masterIngredients = [];
        let menuItems = [];
        let dailySales = [];
        let dailyPurchases = [];
        let salary = [];
        
        // Initialize Firebase.
        try {
            initializeApp(firebaseConfig);
            db = getFirestore();
        } catch (e) {
            console.error("Firebase initialization failed:", e);
        }

        // Firestore data saving function
        async function saveDataToFirestore() {
            // The path is to a "public" collection, meaning it's not tied to a specific user.
            const dataRef = doc(db, 'public', mainDocId);
            const data = {
                masterIngredients,
                menuItems,
                dailySales,
                dailyPurchases,
                salary
            };
            try {
                await setDoc(dataRef, data);
            } catch (e) {
                console.error("Error writing document: ", e);
            }
        }
        
        // Use onSnapshot to get real-time updates for all data
        function setupFirestoreListeners() {
            // Reference to the public document
            const dataRef = doc(db, 'public', mainDocId);

            onSnapshot(dataRef, (docSnap) => {
                if (docSnap.exists()) {
                    const data = docSnap.data();
                    masterIngredients = data.masterIngredients || [];
                    menuItems = data.menuItems || [];
                    dailySales = data.dailySales || [];
                    dailyPurchases = data.dailyPurchases || [];
                    salary = data.salary || [];
                } else {
                    // Initialize with empty arrays if doc doesn't exist
                    masterIngredients = [];
                    menuItems = [];
                    dailySales = [];
                    dailyPurchases = [];
                    salary = [];
                }
                // Re-render everything with the latest data
                renderIngredients();
                renderMenuItems();
                renderDailySales();
                renderPurchases();
                renderSalary();
            }, (error) => {
                console.error("Error listening to data:", error);
                // Handle error gracefully
            });
        }
        
        // --- DOM Elements & Event Listeners ---
        const loginContainer = document.getElementById('login-container');
        const loginForm = document.getElementById('login-form');
        const passwordInput = document.getElementById('password-input');
        const loginMessage = document.getElementById('login-message');
        const appContent = document.getElementById('app-content');
        
        const masterTab = document.getElementById('master-tab');
        const menuTab = document.getElementById('menu-tab');
        const salesTab = document.getElementById('sales-tab');
        const purchasesTab = document.getElementById('purchases-tab');
        const salaryTab = document.getElementById('salary-tab');

        const masterSection = document.getElementById('master-section');
        const menuSection = document.getElementById('menu-section');
        const salesSection = document.getElementById('sales-section');
        const purchasesSection = document.getElementById('purchases-section');
        const salarySection = document.getElementById('salary-section');
        
        const masterSearchInput = document.getElementById('master-search');
        const ingredientsTableBody = document.getElementById('ingredients-table-body');
        const addIngredientBtn = document.getElementById('add-ingredient-btn');
        const ingredientNameInput = document.getElementById('ingredient-name');
        const ingredientUnitInput = document.getElementById('ingredient-unit');
        const ingredientCostInput = document.getElementById('ingredient-cost');
        const masterMessage = document.getElementById('master-message');

        const menuSearchInput = document.getElementById('menu-search');
        const menuItemsContainer = document.getElementById('menu-items-container');
        const addMenuItemBtn = document.getElementById('add-menu-item-btn');
        const menuItemNameInput = document.getElementById('menu-item-name');
        const itemTypeSelect = document.getElementById('item-type-select');
        const dineInPriceInput = document.getElementById('dine-in-price');
        const takeAwayPriceInput = document.getElementById('take-away-price');
        
        const salesSearchInput = document.getElementById('sales-search');
        const salesDateInput = document.getElementById('sales-date');
        const salesCashInput = document.getElementById('sales-cash');
        const salesCardInput = document.getElementById('sales-card');
        const salesUberInput = document.getElementById('sales-uber');
        const salesJustEatInput = document.getElementById('sales-justeat');
        const salesDeliverooInput = document.getElementById('sales-deliveroo');
        const salesWebsiteInput = document.getElementById('sales-website');
        const salesAdvanceInput = document.getElementById('sales-advance');
        const salesTooGoodToGoInput = document.getElementById('sales-toogoodtogo');
        const addSalesBtn = document.getElementById('add-sales-btn');
        const salesMessage = document.getElementById('sales-message');
        const salesHistoryBody = document.getElementById('sales-history-body');
        
        const purchasesSearchInput = document.getElementById('purchases-search');
        const purchaseDateInput = document.getElementById('purchase-date');
        const purchaseItemInput = document.getElementById('purchase-item');
        const purchaseCostInput = document.getElementById('purchase-cost');
        const addPurchaseBtn = document.getElementById('add-purchase-btn');
        const purchaseMessage = document.getElementById('purchase-message');
        const purchasesHistoryBody = document.getElementById('purchases-history-body');
        
        const salarySearchInput = document.getElementById('salary-search');
        const salaryDateInput = document.getElementById('salary-date');
        const salaryEmployeeInput = document.getElementById('salary-employee');
        const salaryTypeInput = document.getElementById('salary-type');
        const salaryAmountInput = document.getElementById('salary-amount');
        const addSalaryBtn = document.getElementById('add-salary-btn');
        const salaryMessage = document.getElementById('salary-message');
        const salaryHistoryBody = document.getElementById('salary-history-body');
        
        const confirmModal = document.getElementById('confirm-modal');
        const confirmMessage = document.getElementById('confirm-message');
        const confirmDeleteBtn = document.getElementById('confirm-delete-btn');
        const cancelDeleteBtn = document.getElementById('cancel-delete-btn');
        let pendingDeleteIndex = -1;
        let pendingDeleteType = '';

        const downloadStartDateInput = document.getElementById('download-start-date');
        const downloadEndDateInput = document.getElementById('download-end-date');
        const downloadPdfBtn = document.getElementById('download-pdf-btn');
        const downloadCsvBtn = document.getElementById('download-csv-btn');
        
        const downloadPurchaseStartDateInput = document.getElementById('download-purchase-start-date');
        const downloadPurchaseEndDateInput = document.getElementById('download-purchase-end-date');
        const downloadPurchasePdfBtn = document.getElementById('download-purchase-pdf-btn');
        const downloadPurchaseCsvBtn = document.getElementById('download-purchase-csv-btn');

        const downloadSalaryStartDateInput = document.getElementById('download-salary-start-date');
        const downloadSalaryEndDateInput = document.getElementById('download-salary-end-date');
        const downloadSalaryEmployeesSelect = document.getElementById('download-salary-employees');
        const downloadSalaryPdfBtn = document.getElementById('download-salary-pdf-btn');
        const downloadSalaryCsvBtn = document.getElementById('download-salary-csv-btn');

        const downloadIngredientsPdfBtn = document.getElementById('download-ingredients-pdf-btn');
        const downloadIngredientsCsvBtn = document.getElementById('download-ingredients-csv-btn');
        const uploadIngredientsFile = document.getElementById('upload-ingredients-file');
        const uploadIngredientsBtn = document.getElementById('upload-ingredients-btn');


        // Set today's date on the date pickers
        const today = new Date().toISOString().split('T')[0];
        salesDateInput.value = today;
        purchaseDateInput.value = today;
        salaryDateInput.value = today;
        downloadStartDateInput.value = today;
        downloadEndDateInput.value = today;
        downloadPurchaseStartDateInput.value = today;
        downloadPurchaseEndDateInput.value = today;
        downloadSalaryStartDateInput.value = today;
        downloadSalaryEndDateInput.value = today;


        // --- Password Logic ---
        const correctPassword = "Summer2025";
        loginForm.addEventListener('submit', (e) => {
            e.preventDefault();
            if (passwordInput.value === correctPassword) {
                loginContainer.classList.add('hidden');
                appContent.classList.remove('hidden');
                // Initial render of the content after successful login
                // Now we initiate the Firebase listener
                setupFirestoreListeners();
                switchTab(masterTab, masterSection);
            } else {
                loginMessage.classList.remove('hidden');
            }
        });


        // Function to switch tabs
        function switchTab(activeTab, activeSection) {
            const tabs = [masterTab, menuTab, salesTab, purchasesTab, salaryTab];
            const sections = [masterSection, menuSection, salesSection, purchasesSection, salarySection];
            tabs.forEach(tab => tab.classList.remove('border-indigo-500', 'text-indigo-600'));
            sections.forEach(section => section.classList.add('hidden'));
            activeTab.classList.add('border-indigo-500', 'text-indigo-600');
            activeSection.classList.remove('hidden');
        }

        // Tab click handlers
        masterTab.addEventListener('click', () => { switchTab(masterTab, masterSection); renderIngredients(); });
        menuTab.addEventListener('click', () => { switchTab(menuTab, menuSection); renderMenuItems(); });
        salesTab.addEventListener('click', () => { switchTab(salesTab, salesSection); renderDailySales(); });
        purchasesTab.addEventListener('click', () => { switchTab(purchasesTab, purchasesSection); renderPurchases(); });
        salaryTab.addEventListener('click', () => { switchTab(salaryTab, salarySection); renderSalary(); });

        // --- Master Ingredients Logic ---
        function renderIngredients(data = masterIngredients) {
            ingredientsTableBody.innerHTML = '';
            if (data.length === 0) {
                masterMessage.textContent = 'No ingredients found.';
                return;
            }
            masterMessage.textContent = '';
            data.forEach((ingredient, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4 text-gray-800">${ingredient.name}</td>
                    <td class="py-3 px-4 text-gray-800">${ingredient.unit}</td>
                    <td class="py-3 px-4 text-gray-800">
                        <input type="number" value="${ingredient.cost.toFixed(2)}" class="w-24 p-1 border rounded text-right" data-index="${index}">
                    </td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-ingredient-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                ingredientsTableBody.appendChild(row);
            });
            attachIngredientEventListeners();
        }

        masterSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredIngredients = masterIngredients.filter(ing => ing.name.toLowerCase().includes(query));
            renderIngredients(filteredIngredients);
        });

        function attachIngredientEventListeners() {
            // Delete button
            document.querySelectorAll('#ingredients-table-body .delete-ingredient-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'master-ingredient';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the ingredient "${masterIngredients[index].name}"? This will affect any menu items that use it.`;
                });
            });

            // Editable cost input
            document.querySelectorAll('#ingredients-table-body input[type="number"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = e.target.dataset.index;
                    const newCost = parseFloat(e.target.value);
                    if (!isNaN(newCost) && newCost >= 0) {
                        masterIngredients[index].cost = newCost;
                        saveDataToFirestore();
                        renderMenuItems(); // Recalculate all COGS
                    }
                });
            });
        }
        
        addIngredientBtn.addEventListener('click', () => {
            const name = ingredientNameInput.value.trim();
            const unit = ingredientUnitInput.value.trim();
            const cost = parseFloat(ingredientCostInput.value);
            if (!name || !unit || isNaN(cost) || cost <= 0) {
                masterMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            masterIngredients.push({ name, unit, cost });
            saveDataToFirestore();
            ingredientNameInput.value = '';
            ingredientUnitInput.value = '';
            ingredientCostInput.value = '';
            masterMessage.textContent = 'Ingredient added successfully!';
        });

        // Master Ingredients Download
        downloadIngredientsPdfBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No ingredients to download.';
                downloadIngredientsPdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Master Ingredients List", 14, 20);
            const tableColumn = ["Ingredient Name", "Unit", "Cost per Unit (£)"];
            const tableRows = masterIngredients.map(ing => [ing.name, ing.unit, ing.cost.toFixed(2)]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 30,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save('Master_Ingredients.pdf');
        });

        downloadIngredientsCsvBtn.addEventListener('click', () => {
            if (masterIngredients.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No ingredients to download.';
                downloadIngredientsCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const headers = ["Ingredient Name", "Unit", "Cost per Unit"];
            const rows = masterIngredients.map(ing => [
                `"${ing.name}"`,
                `"${ing.unit}"`,
                `"${ing.cost}"`
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Master_Ingredients.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Master Ingredients Upload
        uploadIngredientsBtn.addEventListener('click', () => {
            const file = uploadIngredientsFile.files[0];
            if (!file) {
                masterMessage.textContent = 'Please select a CSV file to upload.';
                return;
            }

            const reader = new FileReader();
            reader.onload = (e) => {
                const content = e.target.result;
                const lines = content.split('\n');
                const newIngredients = [];
                const headers = lines[0].split(',').map(h => h.trim().replace(/^"|"$/g, ''));
                if (headers[0] !== 'Ingredient Name' || headers[1] !== 'Unit' || headers[2] !== 'Cost per Unit') {
                    masterMessage.textContent = 'Error: Invalid CSV headers. Expected "Ingredient Name", "Unit", "Cost per Unit".';
                    return;
                }
                for (let i = 1; i < lines.length; i++) {
                    const line = lines[i].trim();
                    if (line) {
                        const parts = line.split(',').map(p => p.trim().replace(/^"|"$/g, ''));
                        const name = parts[0];
                        const unit = parts[1];
                        const cost = parseFloat(parts[2]);
                        if (name && unit && !isNaN(cost) && cost > 0) {
                            newIngredients.push({ name, unit, cost });
                        }
                    }
                }
                masterIngredients = newIngredients;
                saveDataToFirestore();
                renderIngredients();
                renderMenuItems();
                masterMessage.textContent = `Successfully uploaded ${newIngredients.length} ingredients!`;
            };
            reader.readAsText(file);
        });


        // --- Menu Items & Platters Logic ---
        function getIngredientCost(name) {
            const ingredient = masterIngredients.find(ing => ing.name === name);
            return ingredient ? ingredient.cost : 0;
        }

        function calculateCogs(ingredients) {
            let totalCogs = 0;
            ingredients.forEach(item => {
                let cost = 0;
                if (item.type === 'ingredient') {
                    const masterIng = masterIngredients.find(ing => ing.name === item.name);
                    cost = masterIng ? masterIng.cost * item.quantity : 0;
                } else if (item.type !== 'ingredient') {
                    const dish = menuItems.find(menuItem => menuItem.name === item.name);
                    cost = dish ? dish.cogs * item.quantity : 0;
                }
                totalCogs += cost;
            });
            return totalCogs;
        }
        
        // Helper function to get the COGS star icon based on percentage
        function getCogsStar(percent) {
            let colorClass = 'text-gray-400';
            if (percent > 0 && percent <= 30) {
                colorClass = 'text-yellow-400';
            } else if (percent >= 31 && percent <= 35) {
                colorClass = 'text-green-500';
            } else if (percent >= 36 && percent <= 40) {
                colorClass = 'text-amber-500';
            } else if (percent >= 41) {
                colorClass = 'text-red-500';
            }
            
            return `
                <div class="flex items-center space-x-1">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5 ${colorClass} fill-current" viewBox="0 0 20 20" fill="currentColor">
                        <path d="M9.049 2.927c.3-.921 1.603-.921 1.902 0l1.07 3.292a1 1 0 00.95.69h3.462c.969 0 1.371 1.24.588 1.81l-2.8 2.034a1 1 0 00-.364 1.118l1.07 3.292c.3.921-.755 1.688-1.54 1.118l-2.8-2.034a1 1 0 00-1.175 0l-2.8 2.034c-.784.57-1.838-.197-1.539-1.118l1.07-3.292a1 1 0 00-.364-1.118L2.98 8.72c-.783-.57-.38-1.81.588-1.81h3.461a1 1 0 00.951-.69l1.07-3.292z" />
                    </svg>
                    <span class="text-xs font-semibold text-gray-600">${percent.toFixed(0)}%</span>
                </div>
            `;
        }

        function renderMenuItems(data = menuItems) {
            menuItemsContainer.innerHTML = '';
            if (data.length === 0) {
                menuItemsContainer.innerHTML = '<div class="text-center text-gray-600">No menu items found.</div>';
                return;
            }
            data.forEach((item, index) => {
                item.cogs = calculateCogs(item.ingredients);
                const dineInVat = item.dineInPrice ? item.dineInPrice * 0.20 : 0;
                const takeAwayVat = item.takeAwayPrice ? item.takeAwayPrice * 0.20 : 0;
                
                const dineInCogsPercent = item.dineInPrice > 0 ? (item.cogs / item.dineInPrice) * 100 : 0;
                const takeAwayCogsPercent = item.takeAwayPrice > 0 ? (item.cogs / item.takeAwayPrice) * 100 : 0;
                
                const dineInCogsWithVat = item.cogs + dineInVat;
                const takeAwayCogsWithVat = item.cogs + takeAwayVat;

                const itemCard = document.createElement('div');
                itemCard.className = 'p-6 bg-white rounded-lg shadow-md border border-gray-200';
                itemCard.innerHTML = `
                    <div class="flex items-center justify-between mb-4 cursor-pointer toggle-menu-item" data-index="${index}">
                        <h3 class="text-xl font-bold text-gray-800">${item.name} (${item.type.charAt(0).toUpperCase() + item.type.slice(1)})</h3>
                        <div class="flex items-center space-x-4">
                            <span class="text-lg font-semibold text-gray-600">COGS:</span>
                            <span class="text-2xl font-extrabold text-indigo-600">£${item.cogs.toFixed(2)}</span>
                            <button class="delete-item-btn text-red-500 hover:text-red-700" data-index="${index}">
                                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                            </button>
                            <svg class="h-6 w-6 text-gray-400 transform transition-transform duration-200" id="chevron-${index}" fill="none" viewBox="0 0 24 24" stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7" />
                            </svg>
                        </div>
                    </div>
                    
                    <div id="item-details-${index}" class="space-y-4 hidden">
                        <div class="grid md:grid-cols-3 gap-4">
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In Price</span>
                                <span class="block text-gray-800 font-bold text-lg">£${item.dineInPrice ? item.dineInPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">£${dineInVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Dine-In COGS%</span>
                                ${item.dineInPrice > 0 ? getCogsStar(dineInCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away Price</span>
                                <span class="block text-gray-800 font-bold text-lg">£${item.takeAwayPrice ? item.takeAwayPrice.toFixed(2) : 'N/A'}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away VAT (20%)</span>
                                <span class="block text-gray-800 font-bold text-lg">£${takeAwayVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg">
                                <span class="block text-gray-500 text-sm">Take-Away COGS%</span>
                                ${item.takeAwayPrice > 0 ? getCogsStar(takeAwayCogsPercent) : `<span class="text-gray-400">-</span>`}
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Dine-In COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">£${dineInCogsWithVat.toFixed(2)}</span>
                            </div>
                            <div class="p-2 border rounded-lg col-span-3">
                                <span class="block text-gray-500 text-sm">Take-Away COGS + VAT</span>
                                <span class="block text-gray-800 font-bold text-lg">£${takeAwayCogsWithVat.toFixed(2)}</span>
                            </div>
                        </div>

                        <!-- Online Markup Calculator -->
                        <div class="p-4 border border-indigo-200 rounded-lg bg-indigo-50 mt-4">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Online Platform Pricing</h4>
                            <div class="grid grid-cols-2 gap-4 items-center">
                                <div class="flex items-center space-x-2">
                                    <label for="online-markup-${index}" class="text-sm font-medium text-gray-700">Markup:</label>
                                    <input type="number" id="online-markup-${index}" min="0" max="500" value="0" class="w-24 p-2 border border-gray-300 rounded-lg text-sm text-center">
                                    <span class="text-lg font-bold text-gray-600">%</span>
                                </div>
                                <div>
                                    <span class="block text-gray-500 text-sm">Online Selling Price:</span>
                                    <span class="block text-gray-800 font-bold text-lg" id="online-price-display-${index}">£${item.dineInPrice ? item.dineInPrice.toFixed(2) : '0.00'}</span>
                                </div>
                            </div>
                        </div>

                        <div class="overflow-x-auto mt-4">
                            <table class="min-w-full bg-white border border-gray-200 rounded-lg">
                                <thead class="bg-gray-100">
                                    <tr>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Component</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Quantity</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Unit/Type</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Cost</th>
                                        <th class="py-2 px-3 text-left font-semibold text-gray-600">Actions</th>
                                    </tr>
                                </thead>
                                <tbody id="recipe-table-body-${index}">
                                    ${item.ingredients.map((ing, i) => `
                                        <tr class="border-b border-gray-200 last:border-b-0">
                                            <td class="py-2 px-3 text-gray-700">${ing.name}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.quantity}</td>
                                            <td class="py-2 px-3 text-gray-700">${ing.type}</td>
                                            <td class="py-2 px-3 text-gray-700">£${calculateComponentCost(ing).toFixed(2)}</td>
                                            <td class="py-2 px-3">
                                                <button class="remove-component-btn text-red-500 hover:text-red-700" data-item-index="${index}" data-component-index="${i}">Remove</button>
                                            </td>
                                        </tr>
                                    `).join('')}
                                </tbody>
                            </table>
                        </div>
                        <div class="p-4 border border-gray-200 rounded-lg bg-gray-50">
                            <h4 class="text-md font-semibold text-gray-700 mb-2">Add Component to Recipe</h4>
                            <div class="grid grid-cols-3 gap-2">
                                <select class="component-select p-2 border border-gray-300 rounded-lg" data-item-index="${index}">
                                    <option value="">Select...</option>
                                    <optgroup label="Ingredients">
                                        ${masterIngredients.map(ing => `<option value="${ing.name}" data-type="ingredient">${ing.name}</option>`).join('')}
                                    </optgroup>
                                    ${item.type === 'platter' ? `<optgroup label="Dishes">${menuItems.filter(m => m.type !== 'platter').map(d => `<option value="${d.name}" data-type="dish">${d.name}</option>`).join('')}</optgroup>` : ''}
                                </select>
                                <input type="number" placeholder="Quantity" class="component-quantity p-2 border border-gray-300 rounded-lg">
                                <button class="add-component-btn p-2 text-white font-bold rounded-lg bg-indigo-500 hover:bg-indigo-600 transition-colors" data-item-index="${index}">Add</button>
                            </div>
                        </div>
                    </div>
                `;
                menuItemsContainer.appendChild(itemCard);
            });
            attachMenuEventListeners();
        }

        menuSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredMenu = menuItems.filter(item => item.name.toLowerCase().includes(query));
            renderMenuItems(filteredMenu);
        });

        function calculateComponentCost(component) {
            if (component.type === 'ingredient') {
                const ing = masterIngredients.find(i => i.name === component.name);
                return ing ? ing.cost * component.quantity : 0;
            } else if (component.type !== 'ingredient') {
                const dish = menuItems.find(i => i.name === component.name);
                return dish ? dish.cogs * component.quantity : 0;
            }
            return 0;
        }

        addMenuItemBtn.addEventListener('click', () => {
            const name = menuItemNameInput.value.trim();
            const type = itemTypeSelect.value;
            const dineInPrice = parseFloat(dineInPriceInput.value);
            const takeAwayPrice = parseFloat(takeAwayPriceInput.value);
            if (!name) { return; }
            menuItems.push({ name, type, ingredients: [], cogs: 0, dineInPrice, takeAwayPrice });
            saveDataToFirestore();
            menuItemNameInput.value = '';
            dineInPriceInput.value = '';
            takeAwayPriceInput.value = '';
        });

        function attachMenuEventListeners() {
            document.querySelectorAll('.add-component-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    // Fix: Use correct camelCase for dataset properties
                    const itemIndex = btn.dataset.itemIndex;
                    const item = menuItems[itemIndex];
                    const card = btn.closest('.p-6');
                    const select = card.querySelector('.component-select');
                    const quantity = parseFloat(card.querySelector('.component-quantity').value);
                    const selectedOption = select.options[select.selectedIndex];
                    const name = selectedOption.value;
                    const type = selectedOption.dataset.type;

                    if (!name || isNaN(quantity) || quantity <= 0) { return; }
                    
                    item.ingredients.push({ name, quantity, type });
                    saveDataToFirestore();
                    
                    card.querySelector('.component-select').value = '';
                    card.querySelector('.component-quantity').value = '';
                });
            });

            document.querySelectorAll('.delete-item-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'menu-item';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the menu item "${menuItems[index].name}"?`;
                });
            });
            
            document.querySelectorAll('.remove-component-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    // Fix: Use correct camelCase for dataset properties
                    const itemIndex = e.target.closest('button').dataset.itemIndex;
                    const componentIndex = e.target.closest('button').dataset.componentIndex;
                    menuItems[itemIndex].ingredients.splice(componentIndex, 1);
                    saveDataToFirestore();
                });
            });
            
            document.querySelectorAll('[id^="online-markup-"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const index = e.target.id.split('-')[2];
                    const markup = parseFloat(e.target.value) || 0;
                    const dineInPrice = menuItems[index].dineInPrice;
                    const onlinePrice = dineInPrice + (dineInPrice * (markup / 100));
                    document.getElementById(`online-price-display-${index}`).textContent = `£${onlinePrice.toFixed(2)}`;
                });
            });

            // Toggle collapsible sections
            document.querySelectorAll('.toggle-menu-item').forEach(header => {
                header.addEventListener('click', (e) => {
                    // Prevent the click from triggering if the target is a delete button
                    if (e.target.closest('.delete-item-btn')) {
                        return;
                    }
                    const index = header.dataset.index;
                    const details = document.getElementById(`item-details-${index}`);
                    const chevron = document.getElementById(`chevron-${index}`);
                    details.classList.toggle('hidden');
                    chevron.classList.toggle('rotate-180');
                });
            });
        }
        
        // --- Daily Sales Logic ---
        function renderDailySales(data = dailySales) {
            salesHistoryBody.innerHTML = '';
            if (data.length === 0) {
                salesHistoryBody.innerHTML = '<tr><td colspan="6" class="text-center text-gray-600 py-4">No sales recorded yet.</td></tr>';
                return;
            }
            data.forEach((sale, index) => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                const onlineTotal = sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.toogoodtogo;
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${sale.date}</td>
                    <td class="py-3 px-4">£${sale.cash.toFixed(2)}</td>
                    <td class="py-3 px-4">£${sale.card.toFixed(2)}</td>
                    <td class="py-3 px-4">£${onlineTotal.toFixed(2)}</td>
                    <td class="py-3 px-4 font-bold">£${total.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-sales-record-btn text-red-500 hover:text-red-700 transition-colors duration-200">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salesHistoryBody.appendChild(row);
            });
            attachSalesEventListeners();
        }

        salesSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredSales = dailySales.filter(sale => sale.date.includes(query));
            renderDailySales(filteredSales);
        });

        function attachSalesEventListeners() {
            document.querySelectorAll('.delete-sales-record-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'sales';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the sales record for ${dailySales[index].date}?`;
                });
            });
        }

        addSalesBtn.addEventListener('click', () => {
            const date = salesDateInput.value;
            const cash = parseFloat(salesCashInput.value) || 0;
            const card = parseFloat(salesCardInput.value) || 0;
            const uber = parseFloat(salesUberInput.value) || 0;
            const justeat = parseFloat(salesJustEatInput.value) || 0;
            const deliveroo = parseFloat(salesDeliverooInput.value) || 0;
            const website = parseFloat(salesWebsiteInput.value) || 0;
            const advance = parseFloat(salesAdvanceInput.value) || 0;
            const toogoodtogo = parseFloat(salesTooGoodToGoInput.value) || 0;

            if (!date) { 
                salesMessage.textContent = 'Please select a date.'; 
                return; 
            }
            
            dailySales.push({ date, cash, card, uber, justeat, deliveroo, website, advance, toogoodtogo });
            saveDataToFirestore();
            salesMessage.textContent = 'Sales recorded successfully!';
            
            // Clear input fields
            salesCashInput.value = '';
            salesCardInput.value = '';
            salesUberInput.value = '';
            salesJustEatInput.value = '';
            salesDeliverooInput.value = '';
            salesWebsiteInput.value = '';
            salesAdvanceInput.value = '';
            salesTooGoodToGoInput.value = '';
            salesDateInput.value = new Date().toISOString().split('T')[0];
        });

        // --- Purchases Logic ---
        function renderPurchases(data = dailyPurchases) {
            purchasesHistoryBody.innerHTML = '';
            if (data.length === 0) {
                purchasesHistoryBody.innerHTML = '<tr><td colspan="4" class="text-center text-gray-600 py-4">No purchases recorded yet.</td></tr>';
                return;
            }
            data.forEach((purchase, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${purchase.date}</td>
                    <td class="py-3 px-4">${purchase.item}</td>
                    <td class="py-3 px-4">£${purchase.cost.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-purchase-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                purchasesHistoryBody.appendChild(row);
            });
            attachPurchasesEventListeners();
        }

        purchasesSearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredPurchases = dailyPurchases.filter(purchase => purchase.item.toLowerCase().includes(query));
            renderPurchases(filteredPurchases);
        });
        
        function attachPurchasesEventListeners() {
            document.querySelectorAll('.delete-purchase-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'purchases';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the purchase record for "${dailyPurchases[index].item}" on ${dailyPurchases[index].date}?`;
                });
            });
        }
        
        addPurchaseBtn.addEventListener('click', () => {
            const date = purchaseDateInput.value;
            const item = purchaseItemInput.value.trim();
            const cost = parseFloat(purchaseCostInput.value);
            if (!date || !item || isNaN(cost) || cost <= 0) {
                purchaseMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            dailyPurchases.push({ date, item, cost });
            saveDataToFirestore();
            purchaseDateInput.value = today;
            purchaseItemInput.value = '';
            purchaseCostInput.value = '';
            purchaseMessage.textContent = 'Purchase recorded successfully!';
        });
        
        // --- Salary Logic ---
        function renderSalary(data = salary) {
            salaryHistoryBody.innerHTML = '';
            if (data.length === 0) {
                salaryHistoryBody.innerHTML = '<tr><td colspan="5" class="text-center text-gray-600 py-4">No salary payments recorded yet.</td></tr>';
                return;
            }
            data.forEach((payment, index) => {
                const row = document.createElement('tr');
                row.className = 'border-b border-gray-200 last:border-b-0 hover:bg-gray-50';
                row.innerHTML = `
                    <td class="py-3 px-4">${payment.date}</td>
                    <td class="py-3 px-4">${payment.employee}</td>
                    <td class="py-3 px-4">${payment.type}</td>
                    <td class="py-3 px-4">£${payment.amount.toFixed(2)}</td>
                    <td class="py-3 px-4">
                        <button data-index="${index}" class="delete-salary-btn text-red-500 hover:text-red-700">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6" fill="none" viewBox="0 0 24 24" stroke="currentColor"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 7l-.867 12.142A2 2 0 0116.138 21H7.862a2 2 0 01-1.995-1.858L5 7m5 4v6m4-6v6m1-10V4a1 1 0 00-1-1h-4a1 1 0 00-1 1v3M4 7h16" /></svg>
                        </button>
                    </td>
                `;
                salaryHistoryBody.appendChild(row);
            });
            attachSalaryEventListeners();
            populateEmployeeDropdown();
        }

        salarySearchInput.addEventListener('input', (e) => {
            const query = e.target.value.toLowerCase();
            const filteredSalary = salary.filter(payment => payment.employee.toLowerCase().includes(query));
            renderSalary(filteredSalary);
        });
        
        function populateEmployeeDropdown() {
            const uniqueEmployees = [...new Set(salary.map(p => p.employee))].sort();
            downloadSalaryEmployeesSelect.innerHTML = `<option value="">All Employees</option>`;
            uniqueEmployees.forEach(employee => {
                const option = document.createElement('option');
                option.value = employee;
                option.textContent = employee;
                downloadSalaryEmployeesSelect.appendChild(option);
            });
        }

        function attachSalaryEventListeners() {
            document.querySelectorAll('.delete-salary-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const index = e.target.closest('button').dataset.index;
                    pendingDeleteIndex = index;
                    pendingDeleteType = 'salary';
                    confirmModal.classList.remove('hidden');
                    confirmMessage.textContent = `Are you sure you want to delete the salary payment for "${salary[index].employee}" on ${salary[index].date}?`;
                });
            });
        }

        addSalaryBtn.addEventListener('click', () => {
            const date = salaryDateInput.value;
            const employee = salaryEmployeeInput.value.trim();
            const type = salaryTypeInput.value;
            const amount = parseFloat(salaryAmountInput.value);
            if (!date || !employee || !type || isNaN(amount) || amount <= 0) {
                salaryMessage.textContent = 'Please fill out all fields with valid data.';
                return;
            }
            salary.push({ date, employee, type, amount });
            saveDataToFirestore();
            salaryDateInput.value = today;
            salaryEmployeeInput.value = '';
            salaryTypeInput.value = '';
            salaryAmountInput.value = '';
            salaryMessage.textContent = 'Salary payment recorded successfully!';
        });

        // --- Global Data Management (Confirmation & Downloads) ---
        confirmDeleteBtn.addEventListener('click', () => {
            if (pendingDeleteType === 'master-ingredient') {
                if (pendingDeleteIndex !== -1) {
                    masterIngredients.splice(pendingDeleteIndex, 1);
                    saveDataToFirestore();
                }
            } else if (pendingDeleteType === 'menu-item') {
                if (pendingDeleteIndex !== -1) {
                    menuItems.splice(pendingDeleteIndex, 1);
                    saveDataToFirestore();
                }
            } else if (pendingDeleteType === 'sales') {
                if (pendingDeleteIndex !== -1) {
                    dailySales.splice(pendingDeleteIndex, 1);
                    saveDataToFirestore();
                }
            } else if (pendingDeleteType === 'purchases') {
                if (pendingDeleteIndex !== -1) {
                    dailyPurchases.splice(pendingDeleteIndex, 1);
                    saveDataToFirestore();
                }
            } else if (pendingDeleteType === 'salary') {
                if (pendingDeleteIndex !== -1) {
                    salary.splice(pendingDeleteIndex, 1);
                    saveDataToFirestore();
                }
            }
            pendingDeleteIndex = -1;
            pendingDeleteType = '';
            confirmModal.classList.add('hidden');
        });

        cancelDeleteBtn.addEventListener('click', () => {
            pendingDeleteIndex = -1;
            pendingDeleteType = '';
            confirmModal.classList.add('hidden');
        });

        // Sales PDF Download
        downloadPdfBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                downloadPdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredSales = dailySales.filter(sale => {
                return sale.date >= startDate && sale.date <= endDate;
            });
            if (filteredSales.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No sales data found for the selected date range.';
                downloadPdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Daily Sales Report", 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", "Cash (£)", "Card (£)", "Online (£)", "Total (£)"];
            const tableRows = filteredSales.map(sale => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                const onlineTotal = sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.toogoodtogo;
                return [
                    sale.date,
                    sale.cash.toFixed(2),
                    sale.card.toFixed(2),
                    onlineTotal.toFixed(2),
                    total.toFixed(2)
                ];
            });
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Sales_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Sales CSV Download
        downloadCsvBtn.addEventListener('click', () => {
            const startDate = downloadStartDateInput.value;
            const endDate = downloadEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                downloadCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredSales = dailySales.filter(sale => {
                return sale.date >= startDate && sale.date <= endDate;
            });
            if (filteredSales.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No sales data found for the selected date range.';
                downloadCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const headers = ["Date", "Cash", "Card", "Uber Eats", "Just Eat", "Deliveroo", "Website", "Booking Advance", "Too Good To Go", "Total"];
            const rows = filteredSales.map(sale => {
                const total = sale.cash + sale.card + sale.uber + sale.justeat + sale.deliveroo + sale.website + sale.advance + sale.toogoodtogo;
                return [
                    sale.date,
                    sale.cash,
                    sale.card,
                    sale.uber,
                    sale.justeat,
                    sale.deliveroo,
                    sale.website,
                    sale.advance,
                    sale.toogoodtogo,
                    total
                ].map(value => `"${value}"`).join(",");
            });
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Sales_Report_${startDate}_to_${endDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
        // Purchases PDF Download
        downloadPurchasePdfBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                downloadPurchasePdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredPurchases = dailyPurchases.filter(purchase => {
                return purchase.date >= startDate && purchase.date <= endDate;
            });
            if (filteredPurchases.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No purchase data found for the selected date range.';
                downloadPurchasePdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Daily Purchases Report", 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            const tableColumn = ["Date", "Item/Service", "Total Cost (£)"];
            const tableRows = filteredPurchases.map(purchase => [
                purchase.date,
                purchase.item,
                purchase.cost.toFixed(2)
            ]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 40,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Purchases_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Purchases CSV Download
        downloadPurchaseCsvBtn.addEventListener('click', () => {
            const startDate = downloadPurchaseStartDateInput.value;
            const endDate = downloadPurchaseEndDateInput.value;
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                downloadPurchaseCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const filteredPurchases = dailyPurchases.filter(purchase => {
                return purchase.date >= startDate && purchase.date <= endDate;
            });
            if (filteredPurchases.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No purchase data found for the selected date range.';
                downloadPurchaseCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }
            const headers = ["Date", "Item/Service", "Total Cost"];
            const rows = filteredPurchases.map(purchase => [
                `"${purchase.date}"`,
                `"${purchase.item}"`,
                `"${purchase.cost}"`
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Purchases_Report_${startDate}_to_${endDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });

        // Salary PDF Download
        downloadSalaryPdfBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                downloadSalaryPdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            let filteredSalary = salary.filter(payment => {
                return payment.date >= startDate && payment.date <= endDate;
            });

            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(payment => selectedEmployees.includes(payment.employee));
            }

            if (filteredSalary.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No salary data found for the selected criteria.';
                downloadSalaryPdfBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            const { jsPDF } = window.jspdf;
            const doc = new jsPDF();
            doc.setFontSize(18);
            doc.text("Salary Report", 14, 20);
            doc.setFontSize(12);
            doc.text(`Date Range: ${startDate} to ${endDate}`, 14, 30);
            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                doc.text(`Employees: ${selectedEmployees.join(', ')}`, 14, 37);
            }

            const tableColumn = ["Date", "Employee Name", "Payment Type", "Amount (£)"];
            const tableRows = filteredSalary.map(payment => [
                payment.date,
                payment.employee,
                payment.type,
                payment.amount.toFixed(2)
            ]);
            doc.autoTable({
                head: [tableColumn],
                body: tableRows,
                startY: 45,
                styles: { fontSize: 10, cellPadding: 2 },
                headStyles: { fillColor: [243, 244, 246], textColor: [0, 0, 0] }
            });
            doc.save(`Salary_Report_${startDate}_to_${endDate}.pdf`);
        });

        // Salary CSV Download
        downloadSalaryCsvBtn.addEventListener('click', () => {
            const startDate = downloadSalaryStartDateInput.value;
            const endDate = downloadSalaryEndDateInput.value;
            const selectedEmployees = Array.from(downloadSalaryEmployeesSelect.selectedOptions).map(opt => opt.value);
            
            if (!startDate || !endDate) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'Please select a start and end date for the download.';
                downloadSalaryCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            let filteredSalary = salary.filter(payment => {
                return payment.date >= startDate && payment.date <= endDate;
            });

            if (selectedEmployees.length > 0 && selectedEmployees[0] !== "") {
                filteredSalary = filteredSalary.filter(payment => selectedEmployees.includes(payment.employee));
            }
            
            if (filteredSalary.length === 0) {
                const downloadMessage = document.createElement('div');
                downloadMessage.className = 'mt-4 p-3 text-center text-sm font-medium text-red-500 rounded-lg bg-red-100';
                downloadMessage.textContent = 'No salary data found for the selected criteria.';
                downloadSalaryCsvBtn.parentElement.appendChild(downloadMessage);
                setTimeout(() => downloadMessage.remove(), 3000);
                return;
            }

            const headers = ["Date", "Employee Name", "Payment Type", "Amount"];
            const rows = filteredSalary.map(payment => [
                `"${payment.date}"`,
                `"${payment.employee}"`,
                `"${payment.type}"`,
                `"${payment.amount}"`
            ].join(","));
            const csvContent = [headers.join(","), ...rows].join("\n");
            const blob = new Blob([csvContent], { type: 'text/csv;charset=utf-8;' });
            const link = document.createElement("a");
            const url = URL.createObjectURL(blob);
            link.setAttribute("href", url);
            link.setAttribute("download", `Salary_Report_${startDate}_to_${endDate}.csv`);
            link.style.visibility = 'hidden';
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
        });
        
    </script>
</body>
</html>
